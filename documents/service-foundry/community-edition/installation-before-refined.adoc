= Installation Guide

:imagesdir: ./images

== Prerequisites

Service Foundry is a self-service platform engineering solution that runs on your own Kubernetes cluster. It is not a managed service, so you need to provide your own infrastructure and tools.

- AWS Account
- GitHub Account

== Get Started

You need to download the Community Edition License and the Service Foundry Bootstrap tool from the link below:

https://community.servicefoundry.org/

=== Community Edition License

The Community Edition license is a license that allows you to use the Community Edition of Service Foundry. It is a free license and does not require any payment. It expires in 365 days. You can renew it by downloading a new license from the link above.

The License policy might change in the future. Please check the link above for the latest license policy.

==== Step 1: Obtain the Community Edition License

The Community Edition license is available free for 365 days and grants you full access to all Service Foundry features.

1. Visit the Service Foundry Community portal: https://community.servicefoundry.org/
2. Navigate to the *Community License* page or go directly to: https://community.servicefoundry.org/community-license
3. Complete the registration form with your information
4. Download your license fileâ€”this will be a `.lic` file required during bootstrap

[.img-wide]
image::community-edition-license.png[Community Edition License Download Page]

Form fields:

- Customer Email Address(Required): [EMAIL_ADDRESS]
- Installation Id(Required): Kubernetes Cluster Name
- Edition(Not editable): community
- NBR(Not editable): the date of today
- EXP(Not editable): the date of today + 365 days
- Max Nodes(Not editable): 10


After entering your email address and Kubernetes cluster name, Click Generate License button. The generated license will be in theLicense(JWT) field. 

.Community Edition License Generated
[.img-wide]
image::community-edition-license-generated.png[Community Edition License Generated]

Click 'Copy License' button to copy the license to your clipboard so that you can paste it in the next step. Or, you can save the license to a file by clicking 'Save License' button.

=== Bootstrap Scripts Generation

Service Foundry provides a bootstrap script to automate the installation process. The bootstrap script will install ArgoCD as the GitOps engine on your Kubernetes cluster and deploy all core components from your GitOps repository.


The bootstrap includes:

- ArgoCD
- Argo Rollouts
- Traefik
- Keycloak
- OAuth2 Proxy
- Sealed Secrets
- Cert-manager
- PostgreSQL
- Redis
- Service Foundry Builder
- Service Foundry Console Backend and Frontend
- ArgoCD HTTPRoute for external access (Use ArgoCD username and password for authentication)
- Argo Rollouts HTTPRoute for external access (Use Service Foundry SSO username and password for authentication)

==== HTTPS and Certificate

You can use Service Foundry without HTTPS and certificate. However, it is recommended to use HTTPS and certificate for production environments. In this guide, we will use AWS Certificate Manager (ACM) to issue a certificate for the domain name of your Kubernetes cluster and Route 53 to create a CNAME record for the domain name of your Kubernetes cluster.


==== How to Generate Bootstrap Scripts

1. Visit the Service Foundry Community portal: https://community.servicefoundry.org/
2. Navigate to the *Bootstrap* page or go directly to: https://community.servicefoundry.org/bootstrap-scripts
3. Fill in the form with your information
4. Click *Generate Bootstrap Scripts* button

.Bootstrap Script Generation
[.img-wide]
image::service-foundry-bootstrap.png[Service Foundry Bootstrap]

==== Handling Secure Properties

All properties can be overridden by environment variables. For example, if you want to override the PostgreSQL password, you can set the environment variable `SF_POSTGRES_PASSWORD` to the desired password.

So, we recommend to use environment variables to override the properties in the bootstrap script after keeping them as empty strings in the bootstrap script.


==== Bootstrap Properties

===== Component Versions

Users can choose to use the latest version of the components or a specific version of the components.

- *Service Foundry Console Helm Version*: Use the default version
- *Service Foundry Console Application Version*: Keep it empty to use the latest version
- Service Foundry Builder Helm Version*: Use the default version

===== Cloud provider

As of now, Service Foundry is only supported on AWS. 

- *Cloud Provider*: AWS
- *AWS ACCOUNT ID*: Keep it empty to use environment variable `AWS_ACCOUNT_ID`
- *AWS Region*: Keep it empty to use environment variable `AWS_REGION`
- *Kubernetes Cluster Name*: input your EKS cluster name or use environment variable `EKS_CLUSTER_NAME`

===== Core Configuration

- *Service Foundry Namespace*: Namespace where Service Foundry will be installed. Default is `service-foundry`
- *GitOps Repo URL*: URL of the GitOps repository. This is mandatory.
- *GitOps User Email*: Email of the GitOps repository. This is optional.
- *GitOps User Name*: Name of the GitOps repository. This is optional.
- *Root Domain*: Root domain of your project. This is mandatory. e.g. `example.com`
- *Log Level*: Log level of Service Foundry. Default is `INFO`

For GitOps Repo URL, I will use `git@github.com:nsalexamy/gitops-demo.git` and I will show you how to create a GitOps repository in the next step.

For Root Domain, I will use `servicefoundry.org` and AWS Certificate Manager to issue a certificate for the domain name of your Kubernetes cluster. The ARN of the certificate will be used in the next step.

===== Load Balancer Configuration

- *Use TLS(env: TRAEFIK_USE_TLS)*: Use TLS for Traefik
- *Use AWS ACM(env: TRAEFIK_USE_AWS_ACM)*: Use AWS Certificate Manager for TLS
- *ACM Certification ARN*: ARN of the ACM certificate. This is mandatory if `TRAEFIK_USE_AWS_ACM` is set to `true`

Configure USE TLS and USE AWS ACM to `true` and paste the ARN of the ACM certificate in the ACM Certification ARN field.

===== credentials

- *PostresSQL Username*: Username of the PostgreSQL database. Default is `admin`
- *PostresSQL Password*: Password of the PostgreSQL database. 
- *Redis Password*: Password of the Redis database. 
- *Service Foundry Admin Console Username*: Username of the Service Foundry Admin Console. Default is `admin`
- *Service Foundry Admin Console Password*: Password of the Service Foundry Admin Console. 

You don't have to fill in the credentials if you are uncomfortable with it. You can use environment variables to override the properties in the bootstrap script after keeping them as empty strings in the bootstrap script.



===== License

- *License Payload*: License payload. Paste the license payload here. This is mandatory.

===== Download Bootstrap Scripts

Click *Download Bootstrap Scripts* button to download the bootstrap scripts. The bootstrap scripts will be in a zip file.


[.img-wide]
image::service-foundry-bootstrap-zip.png[Service Foundry Bootstrap Scripts - Zip File]


== AWS CloudShell

AWS CloudShell is one of good options to run the bootstrap scripts. 

For more information, please watch the video below:

- https://youtu.be/9qyVR5EEIes[Deploy Kubernetes Workloads with AWS Cloud Shell + Helm]
- https://nsalexamy.github.io/service-foundry/pages/documents/blog/aws-cloud-shell/persist-custom-software-installations.html#install-eksctl[AWS CloudShell - Persist Custom Software Installations]

After setting up AWS CloudShell, you can run the bootstrap scripts in the CloudShell.

$HOME: /home/cloudshell-user

The default home directory is `/home/cloudshell-user`. And I will use $HOME/service-foundry directory to store the bootstrap scripts.

[source,shell]
----
$ mkdir -p $HOME/service-foundry
$ cd $HOME/service-foundry
----


== GitOps Repository

All configuration files will be stored in the GitOps repository. In this guide, I will use 'gitops-demo' as the GitOps repository name.

I created a GitOps repository named gitops-demo on GitHub which is private repository.

Repository name: `gitops-demo`
Repository URL: `https://github.com/your-username/gitops-demo.git`

=== Prepare Deployment Key

[source,shell]
----
# On AWS CloudShell or local machine(Linux/Mac)
$ cd $HOME/service-foundry

$ mkdir -p gitops-demo-ssh
$ ssh-keygen -t rsa -b 4096 -C "devops@example.com" -f ./gitops-demo-ssh/id_rsa

# Copy the public key to clipboard
$ cat ./gitops-demo-ssh/id_rsa.pub 
----

=== Add Deployment Key to GitOps Repo

Add the public key to the gitops repo as a deploy key.

Use the public key to add the deployment key to the gitops repo.

Go to https://github.com/your-username/gitops-demo/settings/keys/new

Fill in the form with the following information:

- *Title*: `gitops-demo-ssh`
- *Key*: paste the public key

Check 'Allow write access' checkbox.

Click *Add key* button.

=== GIT_OPS_REPO_SSH_KEY_PATH

Use the private key to override the environment variable `GIT_OPS_REPO_SSH_KEY_PATH`.

[source,shell]
----
$ export GIT_OPS_REPO_SSH_KEY_PATH=$HOME/service-foundry/gitops-demo-ssh/id_rsa
----

=== Init and Push GitOps Repo 

If the repository has not been initialized, you need to initialize it.
If you don't set the user name and email for git, you need to set them.

[source,shell]
----
$ git config user.name || git config user.name "service-foundry"
$ git config user.email || git config user.email "[EMAIL_ADDRESS]"
----


We already have the deployment key, so we can use it to initialize the repository.

The `gitops-demo` directory is for the gitops repository.

[source,shell]
----
$ cd $HOME/service-foundry

$ mkdir -p gitops-demo
$ cd gitops-demo

$ export GIT_SSH_COMMAND="ssh -i $GIT_OPS_REPO_SSH_KEY_PATH -o IdentitiesOnly=yes -F /dev/null"

$ git init
$ git branch -M main
$ git remote add origin git@github.com:your-username/gitops-demo.git

$ echo ".DS_Store" >> .gitignore
$ git add .
$ git commit -m "Initial commit"

$ git push -u origin main
----


== Running Bootstrap Scripts on AWS CloudShell

Upload the bootstrap-scripts.zip to the AWS CloudShell by clicking Actions > Upload File menu.

You can find the bootstrap-scripts.zip in the $HOME/ directory. Move the bootstrap-scripts.zip to the $HOME/service-foundry directory and unzip it.

[source,shell]
----
$ mv $HOME/bootstrap-scripts.zip $HOME/service-foundry/
$ cd $HOME/service-foundry
$ unzip bootstrap-scripts.zip
----

=== Create a new EKS cluster if not exists

If you have already created an EKS cluster, you can skip this step.

The bootstrap scripts also contains a script to create a new EKS cluster in aws folder.

Set the EKS cluster name to `nsa2-sf`.

[source,shell]
----
$ export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
$ export EKS_CLUSTER_NAME=nsa2-sf 

$ cd $HOME/service-foundry/aws

$ chmod +x *.sh
$ ./create-eks.sh
----

The AWS Region and Account ID are already set in your AWS CloudShell. 

It will take about 10 minutes to create a new EKS cluster.

The script will create EKS cluster with the additional components:

- autoscaler
- ebs-csi driver
- priority classes


=== Run bootstrap scripts

[source,shell]
----
$ cd $HOME/service-foundry
$ chmod +x *.sh
$ ./bootstrap.sh
----

== Verify Installation

After the bootstrap script completes, you can access the Service Foundry console and other components.

These are the URLs you need to access:

- console.your-root-domain
- argocd.your-root-domain
- argo-rollouts.your-root-domain
- keycloak.your-root-domain



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Securing Kubernetes Web Applications with Single Sign-On (SSO)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
            margin: 0;
            padding: 0;
        }
    </style>
    
</head>
<body>
<div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#what-is-oauth2-proxy">What is OAuth2 Proxy?</a></li>
<li><a href="#how-oauth2-proxy-uses-session-cookies">How OAuth2 Proxy Uses Session Cookies</a>
<ul class="sectlevel2">
<li><a href="#cookie-name">Cookie Name</a></li>
</ul>
</li>
<li><a href="#sample-web-application">Sample Web Application</a>
<ul class="sectlevel2">
<li><a href="#server-js">server.js</a></li>
<li><a href="#basedeployment-yaml">base/deployment.yaml</a></li>
</ul>
</li>
<li><a href="#configure-traefik-ingress">Configure Traefik Ingress</a>
<ul class="sectlevel2">
<li><a href="#kustomization-yaml-file">kustomization.yaml file</a></li>
<li><a href="#ingressroute-dev-yaml">ingressroute-dev.yaml</a></li>
<li><a href="#forward-auth-middleware-yaml">forward-auth-middleware.yaml</a></li>
</ul>
</li>
<li><a href="#deploying-the-application">Deploying the Application</a></li>
<li><a href="#signing-in-and-accessing-the-app">Signing In and Accessing the App</a>
<ul class="sectlevel2">
<li><a href="#example-cookie-and-header-values">Example Cookie and Header Values</a></li>
</ul>
</li>
<li><a href="#whats-next">What’s Next?</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="imageblock img-wide">
<div class="content">
<img src="images/architecture.png" alt="architecture">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>YouTube Video Tutorial</strong>: <a href="https://youtu.be/Hus8WK_3K9k" class="bare">https://youtu.be/Hus8WK_3K9k</a></p>
</div>
<div class="paragraph">
<p>This guide walks you through securing a web application on Kubernetes using Single Sign-On (SSO). With the Service Foundry Console, you&#8217;ll configure Traefik Ingress to delegate authentication to OAuth2 Proxy, which integrates with Keycloak as the identity provider.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before you begin, ensure the following components are installed in your Kubernetes cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Traefik Ingress Controller</p>
</li>
<li>
<p>OAuth2 Proxy</p>
</li>
<li>
<p>Keycloak</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-oauth2-proxy">What is OAuth2 Proxy?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OAuth2 Proxy is a reverse proxy that provides authentication using third-party providers, including Keycloak. It acts as a gatekeeper, ensuring only authenticated users can access protected resources.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-oauth2-proxy-uses-session-cookies">How OAuth2 Proxy Uses Session Cookies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OAuth2 Proxy uses encrypted session cookies to maintain user login state. These cookies are stored in the user&#8217;s browser and sent with each request to prove authentication. They typically include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User ID from Keycloak</p>
</li>
<li>
<p>Optional access and ID tokens</p>
</li>
<li>
<p>Expiration timestamps</p>
</li>
<li>
<p>A session identifier (if using Redis for session storage)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cookie-name">Cookie Name</h3>
<div class="paragraph">
<p>By default, OAuth2 Proxy uses _oauth2_proxy as the cookie name, but it can be customized using the --cookie-name flag.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sample-web-application">Sample Web Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this demo, we&#8217;ll use a Node.js application that echoes all HTTP request headers. This helps visualize what headers are passed through after authentication.</p>
</div>
<div class="listingblock">
<div class="title">project structure</div>
<div class="content">
<pre>k8s
├── base
│   ├── configmap.yaml
│   ├── deployment.yaml
│   ├── kustomization.yaml
│   ├── namespace.yaml
│   └── service.yaml
└── overlays
    └── dev
        ├── kustomization.yaml
        ├── pod-label-patch.yaml
        └── server.js</pre>
</div>
</div>
<div class="sect2">
<h3 id="server-js">server.js</h3>
<div class="paragraph">
<p>This Node.js script displays incoming request headers:</p>
</div>
<div class="listingblock">
<div class="title">k8s/overlays/dev/server.js</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="javascript"><span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">end</span><span class="p">(</span><span class="s2">`
        &lt;html&gt;
        &lt;body&gt;
          &lt;h1&gt;Request Headers After oauth2-proxy&lt;/h1&gt;
          &lt;pre&gt;</span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span><span class="s2">&lt;/pre&gt;
        &lt;/body&gt;
        &lt;/html&gt;
      `</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Header dump server running on port</span><span class="dl">"</span><span class="p">,</span> <span class="nx">port</span><span class="p">);</span>
<span class="p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basedeployment-yaml">base/deployment.yaml</h3>
<div class="paragraph">
<p>This Deployment launches the Node.js header-dump server:</p>
</div>
<div class="listingblock">
<div class="title">k8s/base/deployment.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">web-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">web-app</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">web-app</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-header-dump</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">node:22-alpine</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">node"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/app/server.js"</span><span class="pi">]</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3000</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-sources</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app/server.js</span>
              <span class="na">subPath</span><span class="pi">:</span> <span class="s">server.js</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-sources</span>
          <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">node-sources</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-traefik-ingress">Configure Traefik Ingress</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll now set up Traefik to enforce authentication before routing traffic to our app.</p>
</div>
<div class="listingblock">
<div class="title">traefik-ingress directory</div>
<div class="content">
<pre>k8s/traefik-ingress
├── forward-auth-middleware.yaml
├── ingressroute-dev.yaml
└── kustomization.yaml</pre>
</div>
</div>
<div class="sect2">
<h3 id="kustomization-yaml-file">kustomization.yaml file</h3>
<div class="listingblock">
<div class="title">k8s/traefik-ingress/kustomization.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">namespace</span><span class="pi">:</span> <span class="s">dev</span>

<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingressroute-dev.yaml</span>
  <span class="pi">-</span> <span class="s">forward-auth-middleware.yaml</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ingressroute-dev-yaml">ingressroute-dev.yaml</h3>
<div class="paragraph">
<p>This IngressRoute includes the <strong>forward-auth</strong> middleware to redirect unauthenticated users.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">traefik.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IngressRoute</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-ingress-route</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">dev</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">entryPoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">web</span>
    <span class="pi">-</span> <span class="s">websecure</span>

  <span class="na">routes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span> <span class="s">Host(`dev.servicefoundry.org`) &amp;&amp; PathPrefix(`/`)</span>
      <span class="na">kind</span><span class="pi">:</span> <span class="s">Rule</span>
      <span class="na">services</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dev-web-service</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>

      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">forward-auth</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="forward-auth-middleware-yaml">forward-auth-middleware.yaml</h3>
<div class="paragraph">
<p>This middleware forwards authentication to the OAuth2 Proxy service:</p>
</div>
<div class="listingblock">
<div class="title">k8s/traefik-ingress/forward-auth-middleware.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">traefik.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Middleware</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">forward-auth</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">service-foundry</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">forwardAuth</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s">http://oauth2-proxy.service-foundry.svc.cluster.local/oauth2/</span>
    <span class="na">trustForwardHeader</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">authResponseHeaders</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">X-Auth-Request-User"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">X-Auth-Request-Email"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">X-Auth-Request-Preferred-Username"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">Authorization"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These headers are passed to your app after authentication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>X-Auth-Request-User</strong>: Keycloak user ID</p>
</li>
<li>
<p><strong>X-Auth-Request-Email</strong>: Email address</p>
</li>
<li>
<p><strong>X-Auth-Request-Preferred-Username</strong>: Preferred username</p>
</li>
<li>
<p><strong>Authorization</strong>: Access token (if provided)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-the-application">Deploying the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apply the deployment and ingress configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl apply <span class="nt">-k</span> k8s/overlays/dev

<span class="nv">$ </span>kubectl apply <span class="nt">-k</span> k8s/traefik-ingress</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="signing-in-and-accessing-the-app">Signing In and Accessing the App</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Visit: <a href="https://dev.servicefoundry.org" class="bare">https://dev.servicefoundry.org</a>
You’ll be redirected to the Keycloak login screen.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/sign-in.png" alt="sign in">
</div>
<div class="title">Figure 1. Sign-In Page</div>
</div>
<div class="paragraph">
<p>After signing in, you&#8217;ll see your request headers as returned by the app.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/request-headers.png" alt="request headers">
</div>
<div class="title">Figure 2. Headers After Authentication</div>
</div>
<div class="sect2">
<h3 id="example-cookie-and-header-values">Example Cookie and Header Values</h3>
<div class="paragraph">
<p>The _oauth2-proxy cookie and authResponseHeaders set by oauth2-proxy are as follows:</p>
</div>
<div class="listingblock">
<div class="title">oauth2-proxy cookie</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">"cookie": "_oauth2_proxy=ch6QXiH-Qv-Bpt...(truncated for brevity)..",</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">authResponseHeaders</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">  "x-auth-request-email": "devops@nsa2.com",
  "x-auth-request-preferred-username": "devops",
  "x-auth-request-user": "1bb013b8-ed9e-4466-b058-8b6c616cf2d3",</code></pre>
</div>
</div>
<div class="paragraph">
<p>These values come from Keycloak and are also visible in the Keycloak user info panel.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/keycloak-user.png" alt="keycloak user">
</div>
<div class="title">Figure 3. Keycloak User Info</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="whats-next">What’s Next?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide showed how to implement SSO for your Kubernetes applications using Traefik, OAuth2 Proxy, and Keycloak. With this setup, you can secure internal apps and streamline user access with centralized authentication.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="imageblock img-wide">
<div class="content">
<img src="images/architecture.png" alt="architecture">
</div>
</div>
<div class="paragraph">
<p>In this guide, we demonstrated how to secure a web application running on Kubernetes using oauth2-proxy and Keycloak for Single Sign-On (SSO). By integrating these components with the Traefik Ingress Controller, we ensured that only authenticated users can access the application, enhancing its security and user management capabilities.</p>
</div>
<div class="paragraph">
<p><br>
<br>
<br>
<br>
<br>
<br>
<br>
<br></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/thnak-you-for-watching.png" alt="thnak you for watching">
</div>
</div>
<div class="paragraph">
<p><br>
<br>
<br>
<br>
<br>
<br>
<br>
<br></p>
</div>
</div>
</div>
</body>
</html>
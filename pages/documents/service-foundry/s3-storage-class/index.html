<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS S3 Storage Class for Data Analytics in Kubernetes</title>
    <!-- rouge source highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/service-foundry/pages/assets/css/main.css">

    <!-- Highlight.js script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</head>
<body class="">

<!-- Header -->
<header>
<!--    <div class="logo text-xl font-semibold">Service Foundry</div>-->
    <a href="/service-foundry/pages/index.html" class="text-2xl font-semibold hover:text-teal-400">
    Service Foundry
</a>
    <nav>
    
        
        <a href="/service-foundry/pages/getting-started/" class="">Getting Started</a>
    
        
        <a href="/service-foundry/pages/products/" class="">Products</a>
    
        
        <a href="/service-foundry/pages/documents/" class="active">Docs</a>
    
        
        <a href="/service-foundry/pages/github/" class="">GitHub</a>
    
        
        <a href="/service-foundry/pages/developers/" class="">Developers</a>
    
        
        <a href="/service-foundry/pages/demo/" class="">Demo</a>
    
</nav>
</header>


    <!-- Sub-navigation for Foundries -->
    <div class="subnav">

    
    <a href="/service-foundry/pages/documents/service-foundry/" class="active">Service Foundry</a>

    
    <a href="/service-foundry/pages/documents/mlops-foundry/" class="">MLOps Foundry</a>

    
    <a href="/service-foundry/pages/documents/blog/" class="">Blog</a>

    
    <a href="/service-foundry/pages/documents/infra-foundry/" class="">Infra</a>

    
    <a href="/service-foundry/pages/documents/sso-foundry/" class="">SSO</a>

    
    <a href="/service-foundry/pages/documents/o11y-foundry/" class="">Observability</a>

    
    <a href="/service-foundry/pages/documents/backend-foundry/" class="">Backend</a>

    
    <a href="/service-foundry/pages/documents/bigdata-foundry/" class="">Big Data</a>

<!--    <a href="/service-foundry/pages/documents/infra-foundry/index-backup.html" class="text-gray-300 hover:text-white">Infra</a>-->
<!--    <a href="/service-foundry/pages/documents/sso-foundry/index-backup.html" class="text-gray-300 hover:text-white">SSO</a>-->
<!--    <a href="/service-foundry/pages/documents/o11y-foundry/index-backup.html" class="text-gray-300 hover:text-white">Observability</a>-->
<!--    <a href="/service-foundry/pages/documents/backend-foundry/index-backup.html" class="text-gray-300 hover:text-white">Backend</a>-->
<!--    <a href="/service-foundry/pages/documents/bigdata-foundry/index-backup.html" class="text-gray-300 hover:text-white">Big Data</a>-->
</div>





<!-- Breadcrumb -->

    <nav class="breadcrumb-wrapper">
    <ol class="breadcrumb">
        
        <li>
            
            <a href="/service-foundry/pages/">Home</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/">Docs</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/service-foundry/">Service Foundry</a>
            
            
        </li>
        
    </ol>
</nav>





<!-- Main Layout -->
<div class="container">


    <nav id="toc-container" class="toc-nav"></nav>


    <main id="main-content">
        
        <div class="author-box">
            Young Gyu Kim
            &lt;<a href="mailto:credemol@gmail.com" style="color: #0d9488; text-decoration: none;">credemol@gmail.com</a>&gt;
        </div>
        

        <!-- Title -->
        
        <h1 class="page-title">
            AWS S3 Storage Class for Data Analytics in Kubernetes
        </h1>
        

        <div class="asciidoc">
            <div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#use-case-scenario">Use Case Scenario</a></li>
</ul>
</li>
<li><a href="#why-use-s3-with-csi-driver-instead-of-s3-client-libraries">Why Use S3 with CSI Driver Instead of S3 Client Libraries?</a></li>
<li><a href="#installing-the-s3-csi-driver">Installing the S3 CSI Driver</a>
<ul class="sectlevel2">
<li><a href="#enabling-s3-csi-driver-in-service-foundry">Enabling S3 CSI Driver in Service Foundry</a></li>
</ul>
</li>
<li><a href="#creating-persistent-volume-and-claim">Creating Persistent Volume and Claim</a>
<ul class="sectlevel2">
<li><a href="#1-persistent-volume-pv">1. Persistent Volume (PV)</a></li>
<li><a href="#2-persistent-volume-claim-pvc">2. Persistent Volume Claim (PVC)</a></li>
</ul>
</li>
<li><a href="#s3-bucket-and-data">S3 Bucket and Data</a></li>
<li><a href="#sample-python-data-loader">Sample Python Data Loader</a>
<ul class="sectlevel2">
<li><a href="#main-components">Main Components</a></li>
<li><a href="#main-py">main.py</a></li>
<li><a href="#requirements-txt">requirements.txt</a></li>
<li><a href="#dockerfile">Dockerfile</a></li>
</ul>
</li>
<li><a href="#deploying-the-data-loader-to-kubernetes">Deploying the Data Loader to Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#add-a-job-resource">Add a Job Resource</a></li>
<li><a href="#kubernetes-job-manifest">Kubernetes Job Manifest</a></li>
<li><a href="#create-a-secret-containing-postgresql-connection-string">Create a Secret containing PostgreSQL Connection String</a></li>
<li><a href="#job-output-example">Job Output Example</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="imageblock img-wide">
<div class="content">
<img src="images/using-s3-pvc.png" alt="using s3 pvc">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Service Foundry</strong> is a comprehensive Kubernetes-native deployment and management solution that enables users to provision infrastructure, deploy applications, and manage storage and GitOps workflows‚Äîall through an intuitive web console, without needing to run any command-line tools.</p>
</div>
<div class="paragraph">
<p>This guide demonstrates how to integrate Amazon S3 as a persistent storage solution within a Kubernetes environment using the S3 CSI (Container Storage Interface) driver. You‚Äôll learn how to install the S3 CSI driver, create a StorageClass, PersistentVolume (PV), and PersistentVolumeClaim (PVC), and use these to run a Python job that loads Parquet files from S3 into a PostgreSQL database.</p>
</div>
<div class="sect2">
<h3 id="use-case-scenario">Use Case Scenario</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upload NYC Open Data into an S3 bucket under the nyc-open-data/ prefix.</p>
</li>
<li>
<p>Enable the S3 CSI Driver and define an S3-backed StorageClass.</p>
</li>
<li>
<p>Create a Persistent Volume referencing the S3 bucket and prefix.</p>
</li>
<li>
<p>Create a Persistent Volume Claim to bind to the Persistent Volume.</p>
</li>
<li>
<p>Deploy a Python job that extracts data from S3 and loads it into PostgreSQL.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="why-use-s3-with-csi-driver-instead-of-s3-client-libraries">Why Use S3 with CSI Driver Instead of S3 Client Libraries?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using the S3 CSI driver offers several advantages over directly using S3 client libraries in your application code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Kubernetes-Native Integration</strong>: Treat S3 as a standard volume using Kubernetes-native constructs like PVCs and PVs.</p>
</li>
<li>
<p><strong>Simplified Codebase</strong>: Application code can interact with local file paths, avoiding the need for S3-specific APIs.</p>
</li>
<li>
<p><strong>Dynamic Provisioning</strong>: PVCs can request dynamic volumes using a predefined StorageClass.</p>
</li>
<li>
<p><strong>Persistent Storage</strong>: Data remains accessible even after pods are deleted or restarted.</p>
</li>
<li>
<p><strong>Security &amp; Access Control</strong>: Leverage Kubernetes RBAC and IAM roles for secure access to S3.</p>
</li>
<li>
<p><strong>Unified Storage Management</strong>: Manage cloud storage centrally via Kubernetes tooling and dashboards.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installing-the-s3-csi-driver">Installing the S3 CSI Driver</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can install the S3 CSI Driver manually or through the Service Foundry Console, which automates the process.</p>
</div>
<div class="sect2">
<h3 id="enabling-s3-csi-driver-in-service-foundry">Enabling S3 CSI Driver in Service Foundry</h3>
<div class="paragraph">
<p>Navigate to:</p>
</div>
<div class="paragraph">
<p><strong>Service Foundry Console ‚Üí Storage &amp; Volumes ‚Üí Storage Classes ‚Üí Enable S3 CSI Driver</strong></p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-storage-classes.png" alt="console storage classes">
</div>
<div class="title">Figure 1. Service Foundry Console - Enable S3 CSI Driver</div>
</div>
<div class="paragraph">
<p>This action performs the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates an S3 bucket if not already present.</p>
</li>
<li>
<p>Generates an IAM Policy and IAM Role for S3 access.</p>
</li>
<li>
<p>Assigns the IAM Role to EKS node groups.</p>
</li>
<li>
<p>Installs the CSI driver and creates a s3-sc StorageClass.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once complete, you should see the s3-sc StorageClass available:</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-storage-classes-s3-sc.png" alt="console storage classes s3 sc">
</div>
<div class="title">Figure 2. Service Foundry Console - S3 Storage Class Created</div>
</div>
<div class="listingblock">
<div class="title">StorageClass Manifest (s3-sc.yaml)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">storageclass.kubernetes.io/is-default-class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-sc</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">bucketName</span><span class="pi">:</span> <span class="s">your-s3-bucket</span>
<span class="na">provisioner</span><span class="pi">:</span> <span class="s">s3.csi.aws.com</span>
<span class="na">reclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
<span class="na">volumeBindingMode</span><span class="pi">:</span> <span class="s">Immediate</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-persistent-volume-and-claim">Creating Persistent Volume and Claim</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="1-persistent-volume-pv">1. Persistent Volume (PV)</h3>
<div class="paragraph">
<p>Create a PV that uses s3-sc and points to your S3 bucket and a specific prefix.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-pv-add.png" alt="console pv add">
</div>
<div class="title">Figure 3. Service Foundry Console - Add Persistent Volume using S3 Storage Class</div>
</div>
<div class="paragraph">
<p>New Persistent Volume can be seen in the list.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-pv-added.png" alt="console pv added">
</div>
<div class="title">Figure 4. Service Foundry Console - New Persistent Volume Claim Added</div>
</div>
<div class="paragraph">
<p>To create a Persistent Volume Claim (PVC) to use the Persistent Volume, click Add Icon on the Claim Ref column. This icon is only available if the PV is not yet claimed.</p>
</div>
<div class="paragraph">
<p>The Persistent Volume manifest looks like below.</p>
</div>
<div class="listingblock">
<div class="title">pv-nyc-open-data.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pv-nyc-open-data</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">5Gi</span>
  <span class="na">volumeMode</span><span class="pi">:</span> <span class="s">Filesystem</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteMany</span>
  <span class="na">persistentVolumeReclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">s3-cs</span>
  <span class="na">csi</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">s3.csi.aws.com</span>
    <span class="na">volumeHandle</span><span class="pi">:</span> <span class="s">your-s3-bucket-nyc-open-data</span> <span class="c1"># A unique name for the PV - bucket-name + prefix</span>
    <span class="na">volumeAttributes</span><span class="pi">:</span>
      <span class="na">bucketName</span><span class="pi">:</span> <span class="s">your-s3-bucket</span>
  <span class="na">mountOptions</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">prefix=nyc-open-data/'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the prefix is specified in the mountOptions. This means that only objects under the 'nyc-open-data/' prefix in the S3 bucket will be accessible through this PV.</p>
</div>
</div>
<div class="sect2">
<h3 id="2-persistent-volume-claim-pvc">2. Persistent Volume Claim (PVC)</h3>
<div class="paragraph">
<p>Create a PVC to bind to the PV created above.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-pvc-add.png" alt="console pvc add">
</div>
<div class="title">Figure 5. Service Foundry Console - Add Persistent Volume Claim</div>
</div>
<div class="paragraph">
<p>Fill out the form and click 'Add' button.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PVC Name: pvc-nyc-open-data</p>
</li>
<li>
<p>Namespace: qc</p>
</li>
</ul>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-pvc-added.png" alt="console pvc added">
</div>
<div class="title">Figure 6. Service Foundry Console - New Persistent Volume Claim Added</div>
</div>
<div class="paragraph">
<p>The Persistent Volume Claim manifest looks like below.</p>
</div>
<div class="listingblock">
<div class="title">pvc-nyc-open-data.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pvc-nyc-open-data</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">qc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ReadWriteMany</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">10Gi</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">s3-sc</span>
  <span class="na">volumeMode</span><span class="pi">:</span> <span class="s">Filesystem</span>
  <span class="na">volumeName</span><span class="pi">:</span> <span class="s">pv-nyc-open-data</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="s3-bucket-and-data">S3 Bucket and Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The S3 bucket created by the S3 CSI Driver can be found in the AWS Console.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/aws-s3-bucket.png" alt="aws s3 bucket">
</div>
<div class="title">Figure 7. AWS Console - S3 Bucket</div>
</div>
<div class="paragraph">
<p>Create a folder named <code>nyc-open-data</code> in the bucket and upload Parquet files from NYC Open Data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sample-python-data-loader">Sample Python Data Loader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The sample app reads Parquet files from the mounted PVC and loads them into PostgreSQL.</p>
</div>
<div class="sect2">
<h3 id="main-components">Main Components</h3>
<div class="ulist">
<ul>
<li>
<p>main.py: Reads Parquet and inserts into Postgres.</p>
</li>
<li>
<p>Dockerfile: Builds the container.</p>
</li>
<li>
<p>requirements.txt: Lists dependencies.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="main-py">main.py</h3>
<div class="listingblock">
<div class="title">main.py</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="n">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="n">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"> üîç Initializing data loader...</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Load environment variables from .env file
</span><span class="nf">load_dotenv</span><span class="p">()</span>

<span class="c1"># PostgreSQL connection string from .env
</span><span class="n">postgres_url</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">POSTGRES_URL</span><span class="sh">"</span><span class="p">)</span>
<span class="n">engine</span> <span class="o">=</span> <span class="nf">create_engine</span><span class="p">(</span><span class="n">postgres_url</span><span class="p">)</span>

<span class="c1"># Path to your parquet files directory
</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">SOURCE_DATA_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">data/</span><span class="sh">"</span><span class="p">)</span>
<span class="n">table_name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">TARGET_TABLE_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yellow_taxi_trips</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"> üöÄ Starting data load process...</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"> üìÇ Source Data directory: </span><span class="sh">"</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"> üóÑÔ∏è Target table name: </span><span class="sh">"</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>


<span class="c1"># Get list of all .parquet files in the data/ directory
</span><span class="n">parquet_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">*.parquet</span><span class="sh">"</span><span class="p">))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">parquet_files</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">‚ö†Ô∏è No Parquet files found in the {data_dir} directory.</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># exit(1)
</span>
<span class="c1"># Load and insert each file
</span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">parquet_files</span><span class="p">)):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">üì¶ Loading file </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">parquet_files</span><span class="p">)</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">df</span><span class="p">.</span><span class="nf">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">‚úÖ Loaded </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s"> rows from </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">‚ùå Error loading </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">üéâ All files processed.</span><span class="sh">"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One key benefit of using the PVC is that you don&#8217;t need to include S3 access logic in your application code. The S3 CSI Driver handles the interaction with S3, allowing your application to work with the data as if it were stored on a local filesystem.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="requirements-txt">requirements.txt</h3>
<div class="paragraph">
<p>All the Python dependencies required for the application are listed in the requirements.txt file.</p>
</div>
<div class="listingblock">
<div class="title">requirements.txt</div>
<div class="content">
<pre class="rouge highlight"><code>pandas
pyarrow
sqlalchemy
psycopg2-binary
python-dotenv</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dockerfile">Dockerfile</h3>
<div class="paragraph">
<p>This Dockerfile sets up the Python environment and installs the required dependencies.</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="dockerfile"><span class="k">FROM</span><span class="s"> python:3.11.4</span>

<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
<span class="k">RUN </span>python <span class="nt">-m</span> venv venv
<span class="k">RUN </span><span class="nb">.</span> venv/bin/activate

<span class="k">COPY</span><span class="s"> requirements.txt ./</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-cache-dir</span> <span class="nt">-r</span> requirements.txt

<span class="k">COPY</span><span class="s"> main.py ./</span>
<span class="k">COPY</span><span class="s"> .env ./</span>

<span class="k">CMD</span><span class="s"> [ "python3", "-u", "main.py" ]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Push the image to a container registry (e.g., credemol/nyc-open-data-loader:0.1.0).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-the-data-loader-to-kubernetes">Deploying the Data Loader to Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <strong>Service Foundry Console ‚Üí Enterprise Applications ‚Üí Add Application</strong> to deploy.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-enterprise-apps-add.png" alt="console enterprise apps add">
</div>
<div class="title">Figure 8. Service Foundry Console - Add Enterprise Application</div>
</div>
<div class="paragraph">
<p>Fill in.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application Name: nyc-open-data-loader</p>
</li>
<li>
<p>Namespace: qc</p>
</li>
<li>
<p>Image Registry: docker.io</p>
</li>
<li>
<p>Image Repository: credemol/nyc-open-data-loader</p>
</li>
<li>
<p>Image Tag: 0.1.0</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="add-a-job-resource">Add a Job Resource</h3>
<div class="paragraph">
<p>Click '<strong>Add Resource</strong>' button to select 'Job' resource type.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/console-enterprise-apps-add-job.png" alt="console enterprise apps add job">
</div>
<div class="title">Figure 9. Service Foundry Console - Add Job Resource</div>
</div>
<div class="paragraph">
<p>Kubernetes Job manifest is provided based on the Application Common Properties. You can modify the manifest as needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-job-manifest">Kubernetes Job Manifest</h3>
<div class="paragraph">
<p>The following is the Kubernetes Job manifest to deploy the Python application using the PVC.</p>
</div>
<div class="listingblock">
<div class="title">job.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nyc-open-data-loader-job</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">qc</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nyc-open-data-loader</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">credemol/nyc-open-data-loader:0.1.0</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>

        <span class="na">volumeMounts</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nyc-open-data</span>
            <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/data</span>

        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SOURCE_DATA_DIR</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">/data/yellow-trip-data</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">TARGET_TABLE_NAME</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">yellow_taxi_trips</span>
        <span class="na">envFrom</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">secretRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">nyc-open-data-secret</span>
              <span class="na">optional</span><span class="pi">:</span> <span class="kc">true</span>

      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span> <span class="c1"># OnFailure or Never</span>

      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nyc-open-data</span>
          <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
            <span class="na">claimName</span><span class="pi">:</span> <span class="s">pvc-nyc-open-data</span>

  <span class="na">backoffLimit</span><span class="pi">:</span> <span class="s">4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two environment variables defined in the manifest:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>SOURCE_DATA_DIR</strong>: The directory where the Parquet files are located (mounted from the PVC).</p>
</li>
<li>
<p><strong>TARGET_TABLE_NAME</strong>: The name of the PostgreSQL table to insert the data into.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="create-a-secret-containing-postgresql-connection-string">Create a Secret containing PostgreSQL Connection String</h3>
<div class="paragraph">
<p>The PostgreSQL connection string is provided via a Kubernetes Secret named <code>nyc-open-data-secret</code>. You need to create this secret in the <code>qc</code> namespace with the following key-value pair:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Key: POSTGRES_URL</p>
</li>
<li>
<p>Value: The PostgreSQL connection string in the format <code>postgresql://username:password@host:port/database</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click 'Add Resource' button to select 'Secret' resource type.</p>
</div>
<div class="listingblock">
<div class="title">secret.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nyc-open-data-secret</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">qc</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">provider</span><span class="pi">:</span> <span class="s">service-foundry</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">POSTGRES_URL</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">base64-encoded-postgres-connection-string</span><span class="pi">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the application and resources are added, the kustomization manifest is generated and looks like below.</p>
</div>
<div class="listingblock">
<div class="title">kustomization.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">namespace</span><span class="pi">:</span> <span class="s">qc</span>
<span class="na">resources</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="s">nyc-open-data-loader-job.yaml</span>
 <span class="pi">-</span> <span class="s">nyc-open-data-loader-secret.yaml</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Click 'Deploy Application' button to deploy the application.</p>
</div>
</div>
<div class="sect2">
<h3 id="job-output-example">Job Output Example</h3>
<div class="listingblock">
<div class="title">Sample Logs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="text"> üîç Initializing data loader...
 üöÄ Starting data load process...
 üìÇ Source Data directory:  /data/yellow-trip-data
 üóÑÔ∏è Target table name:  yellow_taxi_trips
üì¶ Loading file 1/12: /data/yellow-trip-data/yellow_tripdata_2024-01.parquet
‚úÖ Loaded 2964624 rows from yellow_tripdata_2024-01.parquet
üì¶ Loading file 2/12: /data/yellow-trip-data/yellow_tripdata_2024-02.parquet
‚úÖ Loaded 3007526 rows from yellow_tripdata_2024-02.parquet
üì¶ Loading file 3/12: /data/yellow-trip-data/yellow_tripdata_2024-03.parquet
‚úÖ Loaded 3582628 rows from yellow_tripdata_2024-03.parquet
üì¶ Loading file 4/12: /data/yellow-trip-data/yellow_tripdata_2024-04.parquet
‚úÖ Loaded 3514289 rows from yellow_tripdata_2024-04.parquet
üì¶ Loading file 5/12: /data/yellow-trip-data/yellow_tripdata_2024-05.parquet
‚úÖ Loaded 3723833 rows from yellow_tripdata_2024-05.parquet
üì¶ Loading file 6/12: /data/yellow-trip-data/yellow_tripdata_2024-06.parquet
‚úÖ Loaded 3539193 rows from yellow_tripdata_2024-06.parquet
üì¶ Loading file 7/12: /data/yellow-trip-data/yellow_tripdata_2024-07.parquet
‚úÖ Loaded 3076903 rows from yellow_tripdata_2024-07.parquet
üì¶ Loading file 8/12: /data/yellow-trip-data/yellow_tripdata_2024-08.parquet
‚úÖ Loaded 2979183 rows from yellow_tripdata_2024-08.parquet
üì¶ Loading file 9/12: /data/yellow-trip-data/yellow_tripdata_2024-09.parquet
‚úÖ Loaded 3633030 rows from yellow_tripdata_2024-09.parquet
üì¶ Loading file 10/12: /data/yellow-trip-data/yellow_tripdata_2024-10.parquet
‚úÖ Loaded 3833771 rows from yellow_tripdata_2024-10.parquet
üì¶ Loading file 11/12: /data/yellow-trip-data/yellow_tripdata_2024-11.parquet
‚úÖ Loaded 3646369 rows from yellow_tripdata_2024-11.parquet
üì¶ Loading file 12/12: /data/yellow-trip-data/yellow_tripdata_2024-12.parquet
‚úÖ Loaded 3668371 rows from yellow_tripdata_2024-12.parquet
üéâ All files processed.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query in PostgreSQL</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">yellow_taxi_trips</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Total Rows: 41,169,720</p>
</div>
<div class="imageblock img-medium">
<div class="content">
<img src="images/pgadmin4-query-count.png" alt="pgadmin4 query count">
</div>
<div class="title">Figure 10. pgAdmin4 Query Result</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide showcased how to configure AWS S3 as a native storage backend in Kubernetes using the S3 CSI driver and how to build and deploy a Python application that loads large-scale analytics data into PostgreSQL. With this setup, you can now manage, process, and analyze cloud-hosted data in a Kubernetes-native and GitOps-friendly way using Service Foundry Console.</p>
</div>
<div class="paragraph">
<p>üìò View the web version:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://nsalexamy.github.io/service-foundry/pages/documents/service-foundry/s3-storage-class/" class="bare">https://nsalexamy.github.io/service-foundry/pages/documents/service-foundry/s3-storage-class/</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/awslabs/mountpoint-s3-csi-driver/blob/main/docs/INSTALL.md" class="bare">https://github.com/awslabs/mountpoint-s3-csi-driver/blob/main/docs/INSTALL.md</a></p>
</li>
</ul>
</div>
</div>
</div>
        </div>
    </main>
</div>




<script>
    const toc = document.getElementById('toc');
    const container = document.getElementById('toc-container');
    if (toc && container) {
        container.appendChild(toc);
    }
</script>


<!--<button onclick="toggleTheme()" style="position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; background-color: var(&#45;&#45;link); color: white; border: none; border-radius: 0.375rem; cursor: pointer;">-->
<!--    Toggle Theme-->
<!--</button>-->

<!--<script>-->
<!--    function toggleTheme() {-->
<!--        const html = document.documentElement;-->
<!--        const isDark = html.getAttribute("data-theme") === "dark";-->
<!--        html.setAttribute("data-theme", isDark ? "light" : "dark");-->
<!--        localStorage.setItem("theme", isDark ? "light" : "dark");-->
<!--    }-->

<!--    document.addEventListener("DOMContentLoaded", () => {-->
<!--        const savedTheme = localStorage.getItem("theme") || "light";-->
<!--        document.documentElement.setAttribute("data-theme", savedTheme);-->
<!--    });-->
<!--</script>-->

<!-- Footer -->
<footer class="bg-gray-900 text-white text-sm py-6 text-center">
    ¬© 2025 Service Foundry. All rights reserved.
</footer>
</body>
</html>
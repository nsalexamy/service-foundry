<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oauth2 Client for Batch Applications</title>
    <!-- rouge source highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
<!--    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="/service-foundry/pages/assets/css/main.css">

    <!-- Highlight.js script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</head>
<body class="">

<!-- Header -->
<header>
<!--    <div class="logo text-xl font-semibold">Service Foundry</div>-->
    <a href="/service-foundry/pages/index.html" class="text-2xl font-semibold hover:text-teal-400">Service Foundry</a>
    <nav>
    
        
        <a href="/service-foundry/pages/getting-started/" class="">Getting Started</a>
    
        
        <a href="/service-foundry/pages/documents/" class="active">Docs</a>
    
        
        <a href="/service-foundry/pages/github/" class="">GitHub</a>
    
        
        <a href="/service-foundry/pages/developers/" class="">Developers</a>
    
</nav>
</header>

<!-- Sub-navigation for Foundries -->
<div class="subnav">

    
    <a href="/service-foundry/pages/documents/blog/" class="">Blog</a>

    
    <a href="/service-foundry/pages/documents/infra-foundry/" class="">Infra</a>

    
    <a href="/service-foundry/pages/documents/sso-foundry/" class="">SSO</a>

    
    <a href="/service-foundry/pages/documents/o11y-foundry/" class="">Observability</a>

    
    <a href="/service-foundry/pages/documents/backend-foundry/" class="active">Backend</a>

    
    <a href="/service-foundry/pages/documents/bigdata-foundry/" class="">Big Data</a>

<!--    <a href="/service-foundry/pages/documents/infra-foundry/index-backup.html" class="text-gray-300 hover:text-white">Infra</a>-->
<!--    <a href="/service-foundry/pages/documents/sso-foundry/index-backup.html" class="text-gray-300 hover:text-white">SSO</a>-->
<!--    <a href="/service-foundry/pages/documents/o11y-foundry/index-backup.html" class="text-gray-300 hover:text-white">Observability</a>-->
<!--    <a href="/service-foundry/pages/documents/backend-foundry/index-backup.html" class="text-gray-300 hover:text-white">Backend</a>-->
<!--    <a href="/service-foundry/pages/documents/bigdata-foundry/index-backup.html" class="text-gray-300 hover:text-white">Big Data</a>-->
</div>




<!-- Breadcrumb -->

    <nav class="breadcrumb-wrapper">
    <ol class="breadcrumb">
        
        <li>
            
            <a href="/service-foundry/pages/">Home</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/">Docs</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/backend-foundry/">Backend Foundry</a>
            
            
        </li>
        
    </ol>
</nav>





<!-- Main Layout -->
<div class="container">


    <nav id="toc-container" class="toc-nav"></nav>


    <main id="main-content">
        
        <div class="author-box">
            Young Gyu Kim
            &lt;<a href="mailto:credemol@gmail.com" style="color: #0d9488; text-decoration: none;">credemol@gmail.com</a>&gt;
        </div>
        

        <!-- Title -->
        
        <h1 class="page-title">
            Oauth2 Client for Batch Applications
        </h1>
        

        <div class="asciidoc">
            <div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#pre-requisites">Pre-requisites</a></li>
<li><a href="#oauth2-grant-types-client-credentials">Oauth2 grant types - Client Credentials</a></li>
<li><a href="#spring-restclient">Spring RestClient</a></li>
<li><a href="#spring-boot-application-for-batch-processing">Spring Boot Application for Batch Processing</a></li>
<li><a href="#add-dependencies">Add Dependencies</a>
<ul class="sectlevel2">
<li><a href="#build-gradle-kts">build.gradle.kts</a></li>
<li><a href="#settings-gradle-kts">settings.gradle.kts</a></li>
</ul>
</li>
<li><a href="#create-a-new-client">Create a new Client</a>
<ul class="sectlevel2">
<li><a href="#insert-new-client">Insert new client</a></li>
</ul>
</li>
<li><a href="#configure-the-client">Configure the Client</a></li>
<li><a href="#source-files-of-oauth2-client-application">Source Files of OAuth2 Client application</a>
<ul class="sectlevel2">
<li><a href="#application-yaml">application.yaml</a></li>
<li><a href="#oauth2clientconfig-java">OAuth2ClientConfig.java</a></li>
<li><a href="#oauthserverrestclient-java">OauthServerRestClient.java</a></li>
<li><a href="#oauthserverrequestinterceptor-java">OauthServerRequestInterceptor.java</a></li>
<li><a href="#securityadminrestclientconfig-java">SecurityAdminRestClientConfig.java</a></li>
<li><a href="#getusersjob-java">GetUsersJob.java</a></li>
</ul>
</li>
<li><a href="#access-token">Access Token</a>
<ul class="sectlevel2">
<li><a href="#jwt">JWT</a></li>
</ul>
</li>
<li><a href="#source-files-of-oauth2-resource-server-application">Source files of OAuth2 Resource Server application</a>
<ul class="sectlevel2">
<li><a href="#usercontroller-java">UserController.java</a></li>
</ul>
</li>
<li><a href="#http-request-and-response-for-client-credentials-grant-type">HTTP Request and Response for Client Credentials grant type</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#source-code">Source Code</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="imageblock img-wide">
<div class="content">
<img src="images/oauth2-batch-app.png" alt="oauth2 batch app">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article, we are going to apply OAuth2 client support to a batch application. We are going to use the Client Credentials grant type to authenticate the client application itself. The client application sends the client ID and client secret to the authorization server to get the access token.</p>
</div>
<div class="paragraph">
<p>This document is written based on the following document. For more information, please refer to the following document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-security/reference/6.4-SNAPSHOT/servlet/oauth2/client/authorization-grants.html#oauth2-client-client-credentials" class="bare">https://docs.spring.io/spring-security/reference/6.4-SNAPSHOT/servlet/oauth2/client/authorization-grants.html#oauth2-client-client-credentials</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pre-requisites">Pre-requisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As of writing this article, Spring Boot 3.4.0 is not released yet. We are using the latest milestone version 3.4.0-RC1. And Java 21 is used to leverage the latest features like Java virtual threads and RestClient.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Spring Boot 3.4.0-RC1</p>
</li>
<li>
<p>Java 21</p>
</li>
<li>
<p>Knowledge of Spring Security and OAuth2</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="oauth2-grant-types-client-credentials">Oauth2 grant types - Client Credentials</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unlike Web applications, Batch applications do not have a user interface to interact with the user. Therefore, the Client Credentials grant type is used to authenticate the client application itself. The client application sends the client ID and client secret to the authorization server to get the access token.</p>
</div>
<div class="paragraph">
<p>For more information on the Client Credentials grant type, please refer to the following document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://datatracker.ietf.org/doc/html/rfc6749#section-1.3.4" class="bare">https://datatracker.ietf.org/doc/html/rfc6749#section-1.3.4</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-restclient">Spring RestClient</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The RestClient is a synchronous HTTP client that offers a modern, fluent API. It offers an abstraction over HTTP libraries that allows for convenient conversion from a Java object to an HTTP request, and the creation of objects from an HTTP response.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Spring Framework Reference<br>
<cite>https://docs.spring.io/spring-framework/reference/integration/rest-clients.html</cite>
</div>
</div>
<div class="paragraph">
<p>RestClient was introduced in Spring 6.1.</p>
</div>
<div class="paragraph">
<p>In this document, we are going to use RestClient to call the REST API with the access token that we get from the authorization server.</p>
</div>
<div class="paragraph">
<p>There are two RestClient beans used in this document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OAuth2ServerRestClient: This bean is used to get the access token from the authorization server.</p>
</li>
<li>
<p>SecurityAdminRestClient: This bean is used to call the REST API with the access token.</p>
</li>
</ul>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/rest-clients.png" alt="rest clients">
</div>
<div class="title">Figure 1. Rest Client UML</div>
</div>
<div class="paragraph">
<p>For more information on RestClient, please refer to the following document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-framework/reference/integration/rest-clients.html" class="bare">https://docs.spring.io/spring-framework/reference/integration/rest-clients.html</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-boot-application-for-batch-processing">Spring Boot Application for Batch Processing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are using the same Spring Boot application that we used in the previous article. We are going to add OAuth2 client support to the existing application.</p>
</div>
<div class="paragraph">
<p>Please refer to the following article to understand the existing application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.linkedin.com/pulse/dkron-easy-reliable-cron-jobs-young-gyu-kim-9yp9c" class="bare">https://www.linkedin.com/pulse/dkron-easy-reliable-cron-jobs-young-gyu-kim-9yp9c</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="add-dependencies">Add Dependencies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="build-gradle-kts">build.gradle.kts</h3>
<div class="paragraph">
<p>Add libraries to build.gradle.kts</p>
</div>
<div class="listingblock">
<div class="title">build.gradle.kts</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">import</span> <span class="nn">org.springframework.boot.gradle.tasks.run.BootRun</span>

<span class="nf">plugins</span> <span class="p">{</span>
    <span class="n">java</span>
    <span class="nf">id</span><span class="p">(</span><span class="s">"org.springframework.boot"</span><span class="p">)</span> <span class="n">version</span> <span class="s">"3.4.0-RC1"</span>
    <span class="nf">id</span><span class="p">(</span><span class="s">"io.spring.dependency-management"</span><span class="p">)</span> <span class="n">version</span> <span class="s">"1.1.6"</span>
<span class="p">}</span>


<span class="n">group</span> <span class="p">=</span> <span class="s">"com.alexamy.nsa2"</span>
<span class="n">version</span> <span class="p">=</span> <span class="s">"0.0.1-SNAPSHOT"</span>

<span class="nf">java</span> <span class="p">{</span>
    <span class="nf">toolchain</span> <span class="p">{</span>
        <span class="n">languageVersion</span> <span class="p">=</span> <span class="nc">JavaLanguageVersion</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">configurations</span> <span class="p">{</span>
    <span class="nf">compileOnly</span> <span class="p">{</span>
        <span class="nf">extendsFrom</span><span class="p">(</span><span class="n">configurations</span><span class="p">.</span><span class="n">annotationProcessor</span><span class="p">.</span><span class="k">get</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">repositories</span> <span class="p">{</span>
    <span class="nf">mavenCentral</span><span class="p">()</span>
    <span class="nf">maven</span> <span class="p">{</span> <span class="n">url</span> <span class="p">=</span> <span class="nf">uri</span><span class="p">(</span><span class="s">"https://repo.spring.io/milestone"</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>

<span class="nf">dependencyManagement</span> <span class="p">{</span>
    <span class="nf">imports</span> <span class="p">{</span>
        <span class="nf">mavenBom</span><span class="p">(</span><span class="s">"io.opentelemetry.instrumentation:opentelemetry-instrumentation-bom:2.9.0"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nf">dependencies</span> <span class="p">{</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"io.opentelemetry.instrumentation:opentelemetry-spring-boot-starter"</span><span class="p">)</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"io.opentelemetry:opentelemetry-extension-trace-propagators"</span><span class="p">)</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter"</span><span class="p">)</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-oauth2-client"</span><span class="p">)</span>


    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-web"</span><span class="p">)</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework:spring-web"</span><span class="p">)</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-actuator"</span><span class="p">)</span>
    <span class="nf">compileOnly</span><span class="p">(</span><span class="s">"org.projectlombok:lombok"</span><span class="p">)</span>
    <span class="nf">annotationProcessor</span><span class="p">(</span><span class="s">"org.projectlombok:lombok"</span><span class="p">)</span>


    <span class="nf">testImplementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-test"</span><span class="p">)</span>
    <span class="nf">testRuntimeOnly</span><span class="p">(</span><span class="s">"org.junit.platform:junit-platform-launcher"</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span><span class="p">.</span><span class="n">withType</span><span class="p">&lt;</span><span class="nc">Test</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="nf">useJUnitPlatform</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">tasks</span><span class="p">.</span><span class="n">named</span><span class="p">&lt;</span><span class="nc">BootRun</span><span class="p">&gt;(</span><span class="s">"bootRun"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mainClass</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s">"com.alexamy.nsa2.example.cronjob.Nsa2CronjobExampleApplication"</span><span class="p">)</span>
    <span class="n">jvmArgs</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="s">"-Dotel.java.global-autoconfigure.enabled=true"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When working on Milestone versions, you need to add the Spring Milestone repository to the build.gradle.kts file.</p>
</div>
<div class="paragraph">
<p>'spring-boot-starter-oauth2-client' is the main dependency that we need to add to the build.gradle.kts file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-oauth2-client"</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="settings-gradle-kts">settings.gradle.kts</h3>
<div class="paragraph">
<p>We also need to add pluginManagement to the settings.gradle.kts file.</p>
</div>
<div class="listingblock">
<div class="title">settings.gradle.kts</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">pluginManagement</span> <span class="p">{</span>
    <span class="nf">repositories</span> <span class="p">{</span>
        <span class="nf">maven</span> <span class="p">{</span> <span class="n">url</span> <span class="p">=</span> <span class="nf">uri</span><span class="p">(</span><span class="s">"https://repo.spring.io/milestone"</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">gradlePluginPortal</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">rootProject</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">"nsa2-cronjob-example"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-a-new-client">Create a new Client</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="insert-new-client">Insert new client</h3>
<div class="paragraph">
<p>To add a new client, we need to insert a new record into the 'oauth2_registered_client' table. We are going to add a new client called 'nsa2-batch' with the 'client_credentials' grant type. The client ID is 'nsa2-batch' and the client secret is 'secret'.</p>
</div>
<div class="listingblock">
<div class="title">Insert nsa2-batch</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="n">uuid_generate_v4</span><span class="p">();</span>
<span class="c1">-- b5046189-ba3c-4473-9cc5-a0d328368163</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">public</span><span class="p">.</span><span class="n">oauth2_registered_client</span>
<span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_id_issued_at</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span> <span class="n">client_secret_expires_at</span><span class="p">,</span>
 <span class="n">client_name</span><span class="p">,</span> <span class="n">client_authentication_methods</span><span class="p">,</span> <span class="n">authorization_grant_types</span><span class="p">,</span> <span class="n">redirect_uris</span><span class="p">,</span>
 <span class="n">post_logout_redirect_uris</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">client_settings</span><span class="p">,</span> <span class="n">token_settings</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'b5046189-ba3c-4473-9cc5-a0d328368163'</span><span class="p">,</span> <span class="s1">'nsa2-batch'</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="s1">'{bcrypt}$2a$10$ZJkIZl2ew5fRjpX4VPkRcOwioG8n6vuD7//QZJ/QWlyzi59l5HW5u'</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span>
        <span class="s1">'NSA2 Batch Application'</span><span class="p">,</span> <span class="s1">'client_secret_basic'</span><span class="p">,</span> <span class="s1">'client_credentials'</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">'nsa2.admin'</span><span class="p">,</span> <span class="s1">'{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":false,"settings.client.require-authorization-consent":false}'</span><span class="p">,</span> <span class="s1">'{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.x509-certificate-bound-access-tokens":false,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","RS256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000],"settings.token.device-code-time-to-live":["java.time.Duration",300.000000000]}'</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Insert nsa2-cronjob-example client - deprecated</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="n">uuid_generate_v4</span><span class="p">();</span>
<span class="c1">-- 762475e5-a75b-4288-a653-a4bf3574c5bb</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">public</span><span class="p">.</span><span class="n">oauth2_registered_client</span>
<span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_id_issued_at</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span> <span class="n">client_secret_expires_at</span><span class="p">,</span>
 <span class="n">client_name</span><span class="p">,</span> <span class="n">client_authentication_methods</span><span class="p">,</span> <span class="n">authorization_grant_types</span><span class="p">,</span> <span class="n">redirect_uris</span><span class="p">,</span>
 <span class="n">post_logout_redirect_uris</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">client_settings</span><span class="p">,</span> <span class="n">token_settings</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'762475e5-a75b-4288-a653-a4bf3574c5bb'</span><span class="p">,</span> <span class="s1">'nsa2-cronjob-example'</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="s1">'{bcrypt}$2a$10$ZJkIZl2ew5fRjpX4VPkRcOwioG8n6vuD7//QZJ/QWlyzi59l5HW5u'</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span>
        <span class="s1">'NSA2 Cronjob Example'</span><span class="p">,</span> <span class="s1">'client_secret_basic'</span><span class="p">,</span> <span class="s1">'refresh_token,client_credentials,authorization_code'</span><span class="p">,</span> <span class="s1">'http://nsa2-cronjob-example:8080/login/oauth2/code/nsa2-cronjob-example'</span><span class="p">,</span> <span class="s1">'http://nsa2-cronjob-example:8080/logged-out'</span><span class="p">,</span> <span class="s1">'openid,profile,nsa2.user.all,nsa2.user.read,nsa2.user.write,nsa2.admin'</span><span class="p">,</span> <span class="s1">'{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":false,"settings.client.require-authorization-consent":false}'</span><span class="p">,</span> <span class="s1">'{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.x509-certificate-bound-access-tokens":false,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","RS256"],"settings.token.access-token-time-to-live":["java.time.Duration",300.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000],"settings.token.device-code-time-to-live":["java.time.Duration",300.000000000]}'</span><span class="p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-the-client">Configure the Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add the following properties to application.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring.security.oauth2.client</span><span class="pi">:</span>
  <span class="na">registration</span><span class="pi">:</span>
    <span class="na">nsa2-cronjob-example</span><span class="pi">:</span>
      <span class="na">provider</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_PROVIDER:spring}</span>
      <span class="na">client-id</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_CLIENT_ID:nsa2-cronjob-example}</span>
      <span class="na">client-secret</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_CLIENT_SECRET:secret}</span>
      <span class="na">authorization-grant-type</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_GRANT_TYPE:authorization_code}</span>
      <span class="na">scope</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_SCOPE:openid,profile}</span>
      <span class="na">redirect-uri</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_REDIRECT_URI:http://nsa2-cronjob-example:8080/login/oauth2/code/{registrationId}}</span>
      <span class="na">client-name</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_CLIENT_NAME:"NSA2 Cronjob Example"}</span>


  <span class="na">provider</span><span class="pi">:</span>
    <span class="na">spring</span><span class="pi">:</span>
      <span class="na">issuer-uri</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_ISSUER_URI:http://nsa2-auth-server:9000}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="source-files-of-oauth2-client-application">Source Files of OAuth2 Client application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going through the source files that are used in this document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>application.yaml</p>
</li>
<li>
<p>Oauth2ClientConfig.java</p>
</li>
<li>
<p>OauthServerRestClient.java</p>
</li>
<li>
<p>OauthServerRequestInterceptor.java</p>
</li>
<li>
<p>SecurityAdminRestClient.java</p>
</li>
<li>
<p>GetUsersJob.java</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="application-yaml">application.yaml</h3>
<div class="paragraph">
<p>The configuration for the OAuth2 client is defined in the application.yaml file.</p>
</div>
<div class="paragraph">
<p>It contains registration and provider information.</p>
</div>
<div class="listingblock">
<div class="title">application.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring.application.name</span><span class="pi">:</span> <span class="s">nsa2-cronjob-example</span>

<span class="na">otel</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="s">${OTEL_ENABLED:true}</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">nsa2-cronjob-example</span>
  <span class="na">exporter</span><span class="pi">:</span>
    <span class="na">otlp</span><span class="pi">:</span>
      <span class="na">endpoint</span><span class="pi">:</span> <span class="s">http://otel-collector:4318</span>
  <span class="na">logs</span><span class="pi">:</span>
    <span class="na">exporter</span><span class="pi">:</span> <span class="s">otlp</span>
  <span class="na">traces</span><span class="pi">:</span>
    <span class="na">exporter</span><span class="pi">:</span> <span class="s">otlp</span>
    <span class="na">sampler</span><span class="pi">:</span>
      <span class="na">arg</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">metrics</span><span class="pi">:</span>
    <span class="na">exporter</span><span class="pi">:</span> <span class="s">none</span>
  <span class="na">propagators</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">b3</span>
    <span class="pi">-</span> <span class="s">tracecontext</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="c1"># enable virtual thread</span>
  <span class="na">threads.virtual.enabled</span><span class="pi">:</span> <span class="kc">true</span>

  <span class="na">main</span><span class="pi">:</span>
    <span class="c1"># disable embedded web server(tomcat)</span>
    <span class="na">web-application-type</span><span class="pi">:</span> <span class="s">none</span>
    <span class="c1"># disable banner</span>
    <span class="na">banner-mode</span><span class="pi">:</span> <span class="s">off</span>

<span class="na">spring.security.oauth2.client</span><span class="pi">:</span>
  <span class="na">registration</span><span class="pi">:</span>
    <span class="na">nsa2-cronjob-example</span><span class="pi">:</span>
      <span class="na">provider</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_PROVIDER:spring}</span>
      <span class="na">client-id</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_CLIENT_ID:nsa2-batch}</span>
      <span class="na">client-secret</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_CLIENT_SECRET:secret}</span>
      <span class="na">authorization-grant-type</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_GRANT_TYPE:client_credentials}</span>
      <span class="na">scope</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_SCOPE:nsa2.admin}</span>

  <span class="na">provider</span><span class="pi">:</span>
    <span class="na">spring</span><span class="pi">:</span>
      <span class="na">issuer-uri</span><span class="pi">:</span> <span class="s">${NSA2_OAUTH_ISSUER_URI:http://nsa2-auth-server:9000}</span>

<span class="na">logging</span><span class="pi">:</span>

  <span class="na">level</span><span class="pi">:</span>
    <span class="na">org.springframework</span><span class="pi">:</span> <span class="s">INFO</span>
    <span class="na">com.alexamy</span><span class="pi">:</span> <span class="s">DEBUG</span>
    <span class="na">io.opentelemetry</span><span class="pi">:</span> <span class="s">TRACE</span>


<span class="na">app</span><span class="pi">:</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="na">security-admin</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">${SECURITY_ADMIN_SERVICE_URL:http://nsa2-securityadmin:8084}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that the authorization-grant-type is set to 'client_credentials' in the application.yaml file.</p>
</div>
<div class="paragraph">
<p>And its scope is set to 'nsa2.admin'.</p>
</div>
</div>
<div class="sect2">
<h3 id="oauth2clientconfig-java">OAuth2ClientConfig.java</h3>
<div class="paragraph">
<p>This Configuration bean is used to create beans that are used to get the access token from the authorization server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">com.alexamy.nsa2.example.cronjob.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientPropertiesMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.EnableConfigurationProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.registration.ClientRegistration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.registration.ClientRegistrationRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">OAuth2ClientProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Oauth2ClientConfig</span> <span class="o">{</span>


    <span class="nd">@Bean</span>
    <span class="nc">InMemoryClientRegistrationRepository</span> <span class="nf">clientRegistrationRepository</span><span class="o">(</span><span class="nc">OAuth2ClientProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ClientRegistration</span><span class="o">&gt;</span> <span class="n">registrations</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span>
                <span class="k">new</span> <span class="nf">OAuth2ClientPropertiesMapper</span><span class="o">(</span><span class="n">properties</span><span class="o">).</span><span class="na">asClientRegistrations</span><span class="o">().</span><span class="na">values</span><span class="o">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">InMemoryClientRegistrationRepository</span><span class="o">(</span><span class="n">registrations</span><span class="o">);</span>
    <span class="o">}</span>


<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When using spring-boot-starter-web with the @EnableWebSecurity annotation in your configuration class, you don&#8217;t need to manually create the ClientRegistrationRepository method, as the autoconfiguration handles it. However, for batch applications, you must create it manually.</p>
</div>
<div class="paragraph">
<p>This creates a ClientRegistrationRepository bean that contains the client registration information defined in the application.yaml file.</p>
</div>
<div class="paragraph">
<p>ClientRegistration can be retrieved from the ClientRegistrationRepository bean by calling the findByRegistrationId method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">        <span class="nc">ClientRegistration</span> <span class="n">clientRegistration</span> <span class="o">=</span>
                <span class="k">this</span><span class="o">.</span><span class="na">clientRegistrationRepository</span><span class="o">.</span><span class="na">findByRegistrationId</span><span class="o">(</span><span class="s">"nsa2-cronjob-example"</span><span class="o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oauthserverrestclient-java">OauthServerRestClient.java</h3>
<div class="paragraph">
<p>This class is used to get the access token from the authorization server.</p>
</div>
<div class="listingblock">
<div class="title">OauthServerRestClient.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">com.alexamy.nsa2.example.cronjob.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.converter.FormHttpMessageConverter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.endpoint.OAuth2AccessTokenResponseClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.endpoint.OAuth2ClientCredentialsGrantRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.endpoint.RestClientClientCredentialsTokenResponseClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.http.OAuth2ErrorResponseErrorHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.core.http.converter.OAuth2AccessTokenResponseHttpMessageConverter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestClient</span><span class="o">;</span>

<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OauthServerRestClientConfig</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">OAUTH_SERVER_REST_CLIENT</span> <span class="o">=</span> <span class="s">"oauthServerRestClient"</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.security.oauth2.client.provider.spring.issuer-uri}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">issuerUri</span><span class="o">;</span>


    <span class="nd">@Bean</span><span class="o">(</span><span class="no">OAUTH_SERVER_REST_CLIENT</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RestClient</span> <span class="nf">oauthServerRestClient</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">RestClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">issuerUri</span><span class="o">)</span>
                <span class="o">.</span><span class="na">messageConverters</span><span class="o">((</span><span class="n">messageConverters</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">messageConverters</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                    <span class="n">messageConverters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">FormHttpMessageConverter</span><span class="o">());</span>
                    <span class="n">messageConverters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">OAuth2AccessTokenResponseHttpMessageConverter</span><span class="o">());</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">defaultStatusHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">OAuth2ErrorResponseErrorHandler</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">OAuth2AccessTokenResponseClient</span><span class="o">&lt;</span><span class="nc">OAuth2ClientCredentialsGrantRequest</span><span class="o">&gt;</span> <span class="nf">accessTokenResponseClient</span><span class="o">(</span>
            <span class="nd">@Qualifier</span><span class="o">(</span><span class="no">OAUTH_SERVER_REST_CLIENT</span><span class="o">)</span> <span class="nc">RestClient</span> <span class="n">oauthServerRestClient</span><span class="o">)</span> <span class="o">{</span>

       <span class="kt">var</span> <span class="n">tokenResponseClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RestClientClientCredentialsTokenResponseClient</span><span class="o">();</span>

       <span class="n">tokenResponseClient</span><span class="o">.</span><span class="na">setRestClient</span><span class="o">(</span><span class="n">oauthServerRestClient</span><span class="o">);</span>

       <span class="k">return</span> <span class="n">tokenResponseClient</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This class is responsible for creating a RestClient bean that is used to get the access token from the authorization server.</p>
</div>
<div class="paragraph">
<p>It requires two message converters to convert the request and response payloads in Client Credentials grant type.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FormHttpMessageConverter</p>
</li>
<li>
<p>OAuth2AccessTokenResponseHttpMessageConverter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This class also creates a OAuth2AccessTokenResponseClient bean that is used to get the access token from the authorization server. RestClientClientCredentialsTokenResponseClient uses the RestClient bean for Client Credentials grant type. This class helps to reduce boilerplate code.</p>
</div>
</div>
<div class="sect2">
<h3 id="oauthserverrequestinterceptor-java">OauthServerRequestInterceptor.java</h3>
<div class="paragraph">
<p>This class intercepts requests to add an access token to the request headers. For a more abstract approach, you can use the RestClientClientCredentialsTokenResponseClient class, introduced in Spring 6.4.</p>
</div>
<div class="listingblock">
<div class="title">OauthServerRequestInterceptor.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">com.alexamy.nsa2.example.cronjob.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.annotation.Nullable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.annotation.PostConstruct</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestExecution</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.endpoint.OAuth2AccessTokenResponseClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.endpoint.OAuth2ClientCredentialsGrantRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.registration.ClientRegistration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.client.registration.ClientRegistrationRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.core.OAuth2AccessToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.core.endpoint.OAuth2AccessTokenResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.Instant</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="c1">//@AllArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OauthServerRequestInterceptor</span> <span class="kd">implements</span> <span class="nc">ClientHttpRequestInterceptor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OAuth2AccessTokenResponseClient</span><span class="o">&lt;</span><span class="nc">OAuth2ClientCredentialsGrantRequest</span><span class="o">&gt;</span> <span class="n">accessTokenResponseClient</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ClientRegistrationRepository</span> <span class="n">clientRegistrationRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">OAuth2AccessToken</span> <span class="n">accessToken</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${NSA2_OAUTH_CLIENT_REGISTRATION_ID:${NSA2_OAUTH_CLIENT_ID:nsa2-cronjob-example}}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">clientRegistrationId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OauthServerRequestInterceptor</span><span class="o">(</span>
            <span class="nc">OAuth2AccessTokenResponseClient</span><span class="o">&lt;</span><span class="nc">OAuth2ClientCredentialsGrantRequest</span><span class="o">&gt;</span> <span class="n">accessTokenResponseClient</span><span class="o">,</span>
            <span class="nc">ClientRegistrationRepository</span> <span class="n">clientRegistrationRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accessTokenResponseClient</span> <span class="o">=</span> <span class="n">accessTokenResponseClient</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">clientRegistrationRepository</span> <span class="o">=</span> <span class="n">clientRegistrationRepository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@PostConstruct</span>
    <span class="kt">void</span> <span class="nf">validateBean</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"===&gt; clientRegistrationRepository class: {}"</span><span class="o">,</span> <span class="n">clientRegistrationRepository</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ClientHttpResponse</span> <span class="nf">intercept</span><span class="o">(</span><span class="nc">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">,</span>
                                        <span class="nc">ClientHttpRequestExecution</span> <span class="n">execution</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"========&gt; httpRequest class: {}"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>

        <span class="kd">final</span> <span class="nc">OAuth2AccessToken</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">getAccessToken</span><span class="o">();</span>

        <span class="k">if</span><span class="o">(</span><span class="n">accessToken</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"=====&gt; accessToken is null"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">execution</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"token value: {}"</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">.</span><span class="na">getTokenValue</span><span class="o">());</span>
        <span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">setBearerAuth</span><span class="o">(</span><span class="n">accessToken</span><span class="o">.</span><span class="na">getTokenValue</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">execution</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nd">@Nullable</span> <span class="nc">OAuth2AccessToken</span> <span class="nf">getAccessToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(!</span> <span class="n">isValid</span><span class="o">(</span><span class="n">accessToken</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">resetAccessToken</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">accessToken</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">OAuth2AccessToken</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">token</span><span class="o">.</span><span class="na">getExpiresAt</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span>
                <span class="o">&amp;&amp;</span> <span class="n">token</span><span class="o">.</span><span class="na">getExpiresAt</span><span class="o">().</span><span class="na">isBefore</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">resetAccessToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accessToken</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="nc">ClientRegistration</span> <span class="n">clientRegistration</span> <span class="o">=</span>
                <span class="k">this</span><span class="o">.</span><span class="na">clientRegistrationRepository</span><span class="o">.</span><span class="na">findByRegistrationId</span><span class="o">(</span><span class="n">clientRegistrationId</span><span class="o">);</span>

        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"===&gt; clientRegistration: {}"</span><span class="o">,</span> <span class="n">clientRegistration</span><span class="o">);</span>

        <span class="nc">OAuth2ClientCredentialsGrantRequest</span> <span class="n">grantRequest</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nf">OAuth2ClientCredentialsGrantRequest</span><span class="o">(</span><span class="n">clientRegistration</span><span class="o">);</span>

        <span class="nc">OAuth2AccessTokenResponse</span> <span class="n">tokenResponse</span> <span class="o">=</span> <span class="n">accessTokenResponseClient</span><span class="o">.</span><span class="na">getTokenResponse</span><span class="o">(</span><span class="n">grantRequest</span><span class="o">);</span>

        <span class="nc">OAuth2AccessToken</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenResponse</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"===&gt; accessToken: {}"</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">accessToken</span> <span class="o">=</span> <span class="n">accessToken</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This component has a member variable of type OAuth2AccessToken and manage the access token. when the access token is null or expired, it gets a new access token from the authorization server. This interceptor component&#8217;s main goal is to add the access token to the request headers.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s have a look at resetAccessToken method. If we pass grantRequest parameter, it returns OAuth2AccessTokenResponse.  We don&#8217;t need to set any  request headers or parameters nor do we need to manage the response. RestClientClientCredentialsTokenResponseClient takes care of everything, making it very convenient</p>
</div>
<div class="paragraph">
<p>For more information on RestClientClientCredentialsTokenResponseClient, please refer to the following document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-security/reference/6.4-SNAPSHOT/servlet/oauth2/client/authorization-grants.html#oauth2-client-client-credentials-access-token" class="bare">https://docs.spring.io/spring-security/reference/6.4-SNAPSHOT/servlet/oauth2/client/authorization-grants.html#oauth2-client-client-credentials-access-token</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="securityadminrestclientconfig-java">SecurityAdminRestClientConfig.java</h3>
<div class="paragraph">
<p>This Config bean is used to create a RestClient bean that is used to call the REST APIs of the Security Admin application.</p>
</div>
<div class="listingblock">
<div class="title">SecurityAdminRestClientConfig.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">com.alexamy.nsa2.example.cronjob.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.http.HttpMessageConverters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestClient</span><span class="o">;</span>

<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityAdminRestClientConfig</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SECURITY_ADMIN_REST_CLIENT_BEAN</span> <span class="o">=</span> <span class="s">"securityAdminRestClient"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SECURITY_ADMIN_REST_CLIENT_BUILDER</span> <span class="o">=</span> <span class="s">"securityAdminRestClientBuilder"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ClientHttpRequestInterceptor</span> <span class="n">requestInterceptor</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${app.services.security-admin.url}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">securityAdminUrl</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SecurityAdminRestClientConfig</span><span class="o">(</span><span class="nc">ClientHttpRequestInterceptor</span> <span class="n">requestInterceptor</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">requestInterceptor</span> <span class="o">=</span> <span class="n">requestInterceptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="no">SECURITY_ADMIN_REST_CLIENT_BUILDER</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RestClient</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">securityAdminRestClientBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">RestClient</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">requestInterceptor</span><span class="o">(</span><span class="n">requestInterceptor</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="no">SECURITY_ADMIN_REST_CLIENT_BEAN</span><span class="o">)</span>
    <span class="nc">RestClient</span> <span class="nf">securityAdminRestClient</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="no">SECURITY_ADMIN_REST_CLIENT_BUILDER</span><span class="o">)</span>
                                       <span class="nc">RestClient</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">RestClient</span> <span class="n">restClient</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">securityAdminUrl</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">restClient</span><span class="o">;</span>
    <span class="o">}</span>



<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The interceptor is added to the RestClient bean to add the access token to the request headers.</p>
</div>
</div>
<div class="sect2">
<h3 id="getusersjob-java">GetUsersJob.java</h3>
<div class="paragraph">
<p>This class is a batch job that gets the users from the Security Admin application.</p>
</div>
<div class="listingblock">
<div class="title">GetUsersJob.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">com.alexamy.nsa2.example.cronjob.component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micrometer.observation.Observation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.api.OpenTelemetry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.api.trace.Span</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.api.trace.SpanBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.api.trace.Tracer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.context.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.context.Scope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.log4j.Log4j2</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.ParameterizedTypeReference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestClient</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">alexamy</span><span class="o">.</span><span class="na">nsa2</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">cronjob</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">SecurityAdminRestClientConfig</span><span class="o">.</span><span class="na">SECURITY_ADMIN_REST_CLIENT_BEAN</span><span class="o">;</span>


<span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="c1">//@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetUsersJob</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RestClient</span> <span class="n">restClient</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SpanBuilder</span> <span class="n">getUsersJobSpanBuilder</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OpenTelemetry</span> <span class="n">openTelemetry</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Tracer</span> <span class="n">tracer</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GetUsersJob</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="no">SECURITY_ADMIN_REST_CLIENT_BEAN</span><span class="o">)</span> <span class="nc">RestClient</span> <span class="n">restClient</span><span class="o">,</span>
                       <span class="nc">OpenTelemetry</span> <span class="n">openTelemetry</span><span class="o">,</span>
                       <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"getUsersJobSpanBuilder"</span><span class="o">)</span> <span class="nc">SpanBuilder</span> <span class="n">getUsersJobSpanBuilder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">restClient</span> <span class="o">=</span> <span class="n">restClient</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">openTelemetry</span> <span class="o">=</span> <span class="n">openTelemetry</span><span class="o">;</span>
<span class="c1">//        log.info("===&gt; openTelemetry: {}", openTelemetry);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tracer</span> <span class="o">=</span> <span class="n">openTelemetry</span><span class="o">.</span><span class="na">getTracer</span><span class="o">(</span><span class="s">"nsa2-cronjob-example-tracer2"</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"===&gt; tracer: {}"</span><span class="o">,</span> <span class="n">tracer</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">getUsersJobSpanBuilder</span> <span class="o">=</span> <span class="n">getUsersJobSpanBuilder</span><span class="o">;</span>
<span class="c1">//        this.observationRegistry = observationRegistry;</span>
    <span class="o">}</span>


    <span class="kt">void</span> <span class="nf">callService</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">restClient</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
                <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"/users"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="nc">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
                <span class="o">});</span>

        <span class="n">users</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">user</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=====&gt; user: {}"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="o">});</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Span</span> <span class="n">span</span> <span class="o">=</span> <span class="n">tracer</span>
                <span class="o">.</span><span class="na">spanBuilder</span><span class="o">(</span><span class="s">"get-users-job2"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">startSpan</span><span class="o">();</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"span: {}"</span><span class="o">,</span> <span class="n">span</span><span class="o">);</span>

        <span class="k">try</span><span class="o">(</span><span class="nc">Scope</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="na">makeCurrent</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"===&gt; scope: {}"</span><span class="o">,</span> <span class="n">scope</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"===&gt; executing..."</span><span class="o">);</span>


            <span class="n">callService</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">span</span><span class="o">.</span><span class="na">recordException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">span</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>



    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute_2</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Span</span> <span class="n">span</span> <span class="o">=</span> <span class="n">getUsersJobSpanBuilder</span>
                <span class="o">.</span><span class="na">setParent</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">root</span><span class="o">())</span>
                <span class="o">.</span><span class="na">startSpan</span><span class="o">();</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"span: {}"</span><span class="o">,</span> <span class="n">span</span><span class="o">);</span>

        <span class="k">try</span><span class="o">(</span><span class="nc">Scope</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="na">makeCurrent</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"===&gt; scope: {}"</span><span class="o">,</span> <span class="n">scope</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"===&gt; executing..."</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"sleeping for 1 second..."</span><span class="o">);</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">callService</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"in final sleeping for 1 second..."</span><span class="o">);</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">span</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run the GetUsersJob, it gets the access token from the authorization server and calls the REST API of the Security Admin application to get the users. All users are printed to the console.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="access-token">Access Token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The access token in Client Credentials grant type is a bit different from the access token in Authorization Code grant type. The access token in Client Credentials grant type does not contain user information. It contains only the client information.</p>
</div>
<div class="sect2">
<h3 id="jwt">JWT</h3>
<div class="paragraph">
<p>Here is an example of the JWT payload that we get from the authorization server.</p>
</div>
<div class="listingblock">
<div class="title">JWT Payload example</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-batch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-batch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nbf"</span><span class="p">:</span><span class="w"> </span><span class="mi">1730135601</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"nsa2.admin"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://nsa2-auth-server:9000"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1730139201</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1730135601</span><span class="p">,</span><span class="w">
  </span><span class="nl">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"700e4de4-954f-4312-98e6-982a332e9bcb"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It does not contain roles information because the client credentials grant type does not have a user. It has only the scope information. The scope is set to 'nsa2.admin' and this can be used as authorities in the application. The authority of 'nsa2.admin' will be 'SCOPE_nsa2.admin'.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="source-files-of-oauth2-resource-server-application">Source files of OAuth2 Resource Server application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="usercontroller-java">UserController.java</h3>
<div class="listingblock">
<div class="title">UserController.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/users"</span><span class="o">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="kd">implements</span> <span class="nc">UserApi</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasRole('NSA2_ADMIN') or hasAuthority('SCOPE_nsa2.admin')"</span><span class="o">)</span>
    <span class="nd">@GetMapping</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">getAllUsers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getAllUsers</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/authentication"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">authentication</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="s">"authorities"</span><span class="o">,</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code above, the @PreAuthorize annotation is used to authorize the user. The user must have the 'NSA2_ADMIN' role or the 'SCOPE_nsa2.admin' authority to access the getAllUsers method. On the other hand, the authentication method is open to all authenticated users. This method is a helper method to check the authentication information.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="http-request-and-response-for-client-credentials-grant-type">HTTP Request and Response for Client Credentials grant type</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To understand the actual HTTP request and response for the Client Credentials grant type, I will show you how to call OAuth2 authorization server to get the access token using the curl command.</p>
</div>
<div class="paragraph">
<p>The curl command below can be used to get the access token from the authorization server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ curl -X POST http://nsa2-auth-server:9000/oauth2/token -u nsa2-batch:secret -d grant_type=client_credentials -d scope=nsa2.admin

{
  "access_token": "eyJraWQiOiJhMTI1NjY1Yi1mYjFkLTQzNDEtOGQxYS03YThlY2JiZTQ0N2YiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJuc2EyLWJhdGNoIiwiYXVkIjoibnNhMi1iYXRjaCIsIm5iZiI6MTczMDE1MzQwMCwic2NvcGUiOlsibnNhMi5hZG1pbiJdLCJyb2xlcyI6W10sImlzcyI6Imh0dHA6Ly9uc2EyLWF1dGgtc2VydmVyOjkwMDAiLCJleHAiOjE3MzAxNTcwMDAsImlhdCI6MTczMDE1MzQwMCwianRpIjoiMTBlZDkwOGQtNDNlYS00MmFkLWI5OWQtZTFiYjgwY2Q0ZjU1IiwiZW1haWwiOm51bGx9.aFY33Y-GfK8NyaCEdEbSg_VH_hPMxctgMbjsEGryFr5F09cLjtYru1z6EVIc_AJpqOHVYWUT8xy9S10xBmx_ojDdsAII6sRnVvTQeai4fn4UQybyiHs4d-s2mKluB5RyKWbNo4Se44Jz_6yCRNgts_RguXOEk5HtGal91oDN3OLky9PqPU-yG6MW8z8_jjqL3Rs6dUL-Wl9_Dwsa1QgqS_oOe-6G8hytT_gZh-ujD_uD_7Obkj-RGHOkzIxOdIAvUkFRLcNLsmGqHCUp8cW5zjdteeYxugb5ab6CrKMOkKhmjycxE16tTzgP90FakeeEsyFDSYIXrOu9JJMVH6mxnQ",
  "scope": "nsa2.admin",
  "token_type": "Bearer",
  "expires_in": 3599
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article, we have learned how to apply OAuth2 client support to a batch application. We have used the Client Credentials grant type to authenticate the client application itself. The client application sends the client ID and client secret to the authorization server to get the access token.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="source-code">Source Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The source code is available at the following repository.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/nsalexamy/nsa2-cronjob-example" class="bare">https://github.com/nsalexamy/nsa2-cronjob-example</a></p>
</li>
</ul>
</div>
</div>
</div>
        </div>
    </main>
</div>




<script>
    const toc = document.getElementById('toc');
    const container = document.getElementById('toc-container');
    if (toc && container) {
        container.appendChild(toc);
    }
</script>


<!--<button onclick="toggleTheme()" style="position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; background-color: var(&#45;&#45;link); color: white; border: none; border-radius: 0.375rem; cursor: pointer;">-->
<!--    Toggle Theme-->
<!--</button>-->

<!--<script>-->
<!--    function toggleTheme() {-->
<!--        const html = document.documentElement;-->
<!--        const isDark = html.getAttribute("data-theme") === "dark";-->
<!--        html.setAttribute("data-theme", isDark ? "light" : "dark");-->
<!--        localStorage.setItem("theme", isDark ? "light" : "dark");-->
<!--    }-->

<!--    document.addEventListener("DOMContentLoaded", () => {-->
<!--        const savedTheme = localStorage.getItem("theme") || "light";-->
<!--        document.documentElement.setAttribute("data-theme", savedTheme);-->
<!--    });-->
<!--</script>-->

<!-- Footer -->
<footer class="bg-gray-900 text-white text-sm py-6 text-center">
     2025 Service Foundry. All rights reserved.
</footer>
</body>
</html>
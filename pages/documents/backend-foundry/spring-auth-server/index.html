<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spring Cloud Gateway with OAuth 2.0 (Spring Authorization Server)</title>
    <!-- rouge source highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/service-foundry/pages/assets/css/main.css">

    <!-- Highlight.js script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</head>
<body class="">

<!-- Header -->
<header>
<!--    <div class="logo text-xl font-semibold">Service Foundry</div>-->
    <a href="/service-foundry/pages/index.html" class="text-2xl font-semibold hover:text-teal-400">
    Service Foundry
</a>
    <nav>
    
        
        <a href="/service-foundry/pages/getting-started/" class="">Getting Started</a>
    
        
        <a href="/service-foundry/pages/products/" class="">Products</a>
    
        
        <a href="/service-foundry/pages/documents/" class="active">Docs</a>
    
        
        <a href="/service-foundry/pages/github/" class="">GitHub</a>
    
        
        <a href="/service-foundry/pages/developers/" class="">Developers</a>
    
        
        <a href="/service-foundry/pages/demo/" class="">Demo</a>
    
</nav>
</header>


    <!-- Sub-navigation for Foundries -->
    <div class="subnav">

    
    <a href="/service-foundry/pages/documents/service-foundry/" class="">Service Foundry</a>

    
    <a href="/service-foundry/pages/documents/blog/" class="">Blog</a>

    
    <a href="/service-foundry/pages/documents/infra-foundry/" class="">Infra</a>

    
    <a href="/service-foundry/pages/documents/sso-foundry/" class="">SSO</a>

    
    <a href="/service-foundry/pages/documents/o11y-foundry/" class="">Observability</a>

    
    <a href="/service-foundry/pages/documents/backend-foundry/" class="active">Backend</a>

    
    <a href="/service-foundry/pages/documents/bigdata-foundry/" class="">Big Data</a>

<!--    <a href="/service-foundry/pages/documents/infra-foundry/index-backup.html" class="text-gray-300 hover:text-white">Infra</a>-->
<!--    <a href="/service-foundry/pages/documents/sso-foundry/index-backup.html" class="text-gray-300 hover:text-white">SSO</a>-->
<!--    <a href="/service-foundry/pages/documents/o11y-foundry/index-backup.html" class="text-gray-300 hover:text-white">Observability</a>-->
<!--    <a href="/service-foundry/pages/documents/backend-foundry/index-backup.html" class="text-gray-300 hover:text-white">Backend</a>-->
<!--    <a href="/service-foundry/pages/documents/bigdata-foundry/index-backup.html" class="text-gray-300 hover:text-white">Big Data</a>-->
</div>





<!-- Breadcrumb -->

    <nav class="breadcrumb-wrapper">
    <ol class="breadcrumb">
        
        <li>
            
            <a href="/service-foundry/pages/">Home</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/">Docs</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/backend-foundry/">Backend Foundry</a>
            
            
        </li>
        
    </ol>
</nav>





<!-- Main Layout -->
<div class="container">


    <nav id="toc-container" class="toc-nav"></nav>


    <main id="main-content">
        
        <div class="author-box">
            Young Gyu Kim
            &lt;<a href="mailto:credemol@gmail.com" style="color: #0d9488; text-decoration: none;">credemol@gmail.com</a>&gt;
        </div>
        

        <!-- Title -->
        
        <h1 class="page-title">
            Spring Cloud Gateway with OAuth 2.0 (Spring Authorization Server)
        </h1>
        

        <div class="asciidoc">
            <div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#spring-bot-and-oauth2">Spring Bot and OAuth2</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#limitations">Limitations</a></li>
</ul>
</li>
<li><a href="#spring-authorization-server-as-oauth2-server">Spring Authorization Server as OAuth2 Server</a>
<ul class="sectlevel2">
<li><a href="#add-dependencies">Add Dependencies</a></li>
<li><a href="#application-yaml">application.yaml</a></li>
<li><a href="#security-configuration">Security Configuration</a></li>
<li><a href="#authorization-server-configuration">Authorization Server Configuration</a></li>
<li><a href="#run-the-application">Run the Application</a></li>
<li><a href="#openid-configuration">OpenID Configuration</a></li>
</ul>
</li>
<li><a href="#spring-cloud-gateway-as-oauth2-client">Spring Cloud Gateway as OAuth2 Client</a>
<ul class="sectlevel2">
<li><a href="#add-dependencies-2">Add Dependencies</a></li>
<li><a href="#configure-oauth2-client">Configure OAuth2 Client</a></li>
<li><a href="#run-the-application-2">Run the Application</a></li>
</ul>
</li>
<li><a href="#resource-server-example">Resource Server example</a>
<ul class="sectlevel2">
<li><a href="#add-dependencies-3">Add Dependencies</a></li>
<li><a href="#configure-oauth2-resource-server">Configure OAuth2 Resource Server</a></li>
<li><a href="#secure-controller">Secure Controller</a></li>
<li><a href="#run-the-application-3">Run the Application</a></li>
<li><a href="#test-resource-server-without-access-token">Test Resource Server without Access Token</a></li>
</ul>
</li>
<li><a href="#test-gateway-and-resource-server-all-together">Test Gateway and Resource Server all together</a>
<ul class="sectlevel2">
<li><a href="#use-session-id-to-access-resource-server-through-gateway">Use Session ID to Access Resource Server through Gateway</a></li>
<li><a href="#jwt-token-decoding">JWT Token Decoding</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a>
<ul class="sectlevel2">
<li><a href="#articles">Articles</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This article is part of a series on Spring Cloud Gateway. The other articles in the series are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Part 1: Spring Cloud Gateway with Virtual Threads</p>
</li>
<li>
<p>Part 2: Spring Cloud Gateway with Spring Authorization Server</p>
</li>
<li>
<p>Part 3: Spring Cloud Gateway with Spring Authorization Server using Database</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is the second article in the series, which focuses on using Spring Cloud Gateway with Virtual Threads.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Gateway plays a key role in managing cross-cutting concerns like security, monitoring, and resilience. In this article, we’ll explore how to configure Spring Cloud Gateway as an OAuth2 client to interact with an OAuth2 server. We’ll also dive into setting up Spring Authorization Server as the OAuth2 server. Building on the resource server from the previous article, we’ll demonstrate how Spring Cloud Gateway interacts with the OAuth2 server to access protected resources.</p>
</div>
<div class="sect2">
<h3 id="spring-bot-and-oauth2">Spring Bot and OAuth2</h3>
<div class="paragraph">
<p>In the previous article, we learned how to implement Spring Cloud Gateway using Virtual Threads. In this article, we will discuss how Spring Cloud Gateway handles security using OAuth2. Spring Cloud Gateway can be used as an OAuth2 client to an OAuth2 server. The OAuth2 server is responsible for issuing access tokens to the client. The client can then use the access token to access protected resources.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/oauth2-spring-authorization-server.png" alt="oauth2 spring authorization server">
</div>
<div class="title">Figure 1. Oauth2 with Spring Authorization Server</div>
</div>
<div class="paragraph">
<p>There are 3 microservices in this example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Cloud Gateway (OAuth2 client, Port 8080)</p>
</li>
<li>
<p>Spring Authorization Server (OAuth2 server, Port 8081)</p>
</li>
<li>
<p>Resource Server example (Port 8082)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Boot provides the following dependencies to enable OAuth2 support for OAuth2 client, OAuth2 authorization server, and OAuth2 resource server.</p>
</div>
<div class="paragraph">
<p>Here are the dependencies respectively:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.springframework.boot:spring-boot-starter-oauth2-client</p>
</li>
<li>
<p>org.springframework.boot:spring-boot-starter-oauth2-authorization-server</p>
</li>
<li>
<p>org.springframework.boot:spring-boot-starter-oauth2-resource-server</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="prerequisites">Prerequisites</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java 21 or later</p>
</li>
<li>
<p>Spring Boot 3.2.0 or later</p>
</li>
<li>
<p>Spring Cloud Gateway</p>
</li>
<li>
<p>Basic knowledge of OAuth2</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="limitations">Limitations</h3>
<div class="paragraph">
<p>In this article, I am not going to cover how OAuth2 works. I assume you have a basic understanding of OAuth2. If you are new to OAuth2, I recommend reading the following documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://oauth.net/2/">OAuth 2.0</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To focus on the main topic, in this article, I will not use a database to store the client details. Instead, I will use an in-memory client registration. We will discuss how to use a database to store client details in a future article.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-authorization-server-as-oauth2-server">Spring Authorization Server as OAuth2 Server</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Spring Authorization Server is a framework that provides implementations of the OAuth 2.1 and OpenID Connect 1.0 specifications and other related specifications. It is built on top of Spring Security to provide a secure, light-weight, and customizable foundation for building OpenID Connect 1.0 Identity Providers and OAuth2 Authorization Server products.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Introducing Spring Authorization Server<br>
<cite>https://docs.spring.io/spring-authorization-server/reference/overview.html</cite>
</div>
</div>
<div class="paragraph">
<p>For more information about Spring Authorization Server, visit the <a href="https://docs.spring.io/spring-authorization-server/reference/overview.html">Spring Authorization Server</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by creating a new Spring Boot project using Spring Initializr. Add the following dependencies:</p>
</div>
<div class="sect2">
<h3 id="add-dependencies">Add Dependencies</h3>
<div class="listingblock">
<div class="title">build.gradle.kts</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="gradle"><span class="k">dependencies</span> <span class="o">{</span>
<span class="c1">//         implementation("org.springframework.boot:spring-boot-starter-jdbc")</span>
	<span class="n">implementation</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-security"</span><span class="o">)</span>
	<span class="n">implementation</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-web"</span><span class="o">)</span>
	<span class="n">implementation</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-oauth2-authorization-server"</span><span class="o">)</span>
	<span class="n">compileOnly</span><span class="o">(</span><span class="s2">"org.projectlombok:lombok"</span><span class="o">)</span>
<span class="c1">// 	runtimeOnly("org.postgresql:postgresql")</span>
	<span class="n">annotationProcessor</span><span class="o">(</span><span class="s2">"org.projectlombok:lombok"</span><span class="o">)</span>
	<span class="n">testImplementation</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-test"</span><span class="o">)</span>
	<span class="n">testImplementation</span><span class="o">(</span><span class="s2">"org.springframework.security:spring-security-test"</span><span class="o">)</span>
	<span class="n">testRuntimeOnly</span><span class="o">(</span><span class="s2">"org.junit.platform:junit-platform-launcher"</span><span class="o">)</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we have added the <code>spring-boot-starter-oauth2-authorization-server</code> dependency to enable OAuth2 authorization server support in the application.
And I commented out the <code>spring-boot-starter-jdbc</code> and <code>postgresql</code> dependencies because we are not going to use a database to store the client details in this article.</p>
</div>
</div>
<div class="sect2">
<h3 id="application-yaml">application.yaml</h3>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring.application.name</span><span class="pi">:</span> <span class="s">nsa2-auth-server</span>

<span class="na">server.port</span><span class="pi">:</span> <span class="m">8081</span>

<span class="na">spring.security.oauth2.authorizationserver</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">nsa2-client</span><span class="pi">:</span>
      <span class="na">registration</span><span class="pi">:</span>
        <span class="na">client-id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nsa2"</span>
        <span class="na">client-secret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{noop}secret"</span>
        <span class="na">client-authentication-methods</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">client_secret_basic"</span>
        <span class="na">authorization-grant-types</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">authorization_code"</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">refresh_token"</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">client_credentials"</span>
        <span class="na">redirect-uris</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">http://127.0.0.1:8080/login/oauth2/code/nsa2"</span>
        <span class="na">post-logout-redirect-uris</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">http://127.0.0.1:8080/logged-out"</span>
        <span class="na">scopes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">openid"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">profile"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">nsa2.user.all"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">nsa2.user.read"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">nsa2.user.write"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">nsa2.admin"</span>

      <span class="na">require-authorization-consent</span><span class="pi">:</span> <span class="kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>application.yml</code> file, we have configured the OAuth2 client details. We have defined the client-id, client-secret, authorization-grant-types, redirect-uris, post-logout-redirect-uris, and scopes.</p>
</div>
</div>
<div class="sect2">
<h3 id="security-configuration">Security Configuration</h3>
<div class="listingblock">
<div class="title">SecurityConfig.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="nc">UserDetailsService</span> <span class="nf">inMemoryUserDetailsManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">InMemoryUserDetailsManager</span><span class="o">(</span>
                <span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"nsa2user"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">"{noop}password"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">roles</span><span class="o">(</span><span class="s">"NSA2_USER"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">(),</span>
                <span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"nsa2admin"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">"{noop}password"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">roles</span><span class="o">(</span><span class="s">"NSA2_ADMIN"</span><span class="o">,</span> <span class="s">"NSA2_USER"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()</span>

        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>SecurityConfig.java</code> file, we have defined the <code>inMemoryUserDetailsManager</code> bean to create in-memory users. We have created two users: <code>nsa2user</code> and <code>nsa2admin</code>. The <code>nsa2user</code> user has the <code>NSA2_USER</code> role, and the <code>nsa2admin</code> user has the <code>NSA2_ADMIN</code> and <code>NSA2_USER</code> roles.
The password for both users is <code>password</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="authorization-server-configuration">Authorization Server Configuration</h3>
<div class="listingblock">
<div class="title">AuthorizationServerConfig.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationServerConfig</span> <span class="o">{</span>

    <span class="c1">// @formatter:off</span>
    <span class="nd">@Order</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
    <span class="nd">@Bean</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">authorizationSecurityFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">applyDefaultSecurity</span><span class="o">(</span><span class="n">http</span><span class="o">);</span>
        <span class="n">http</span><span class="o">.</span><span class="na">getConfigurer</span><span class="o">(</span><span class="nc">OAuth2AuthorizationServerConfigurer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">oidc</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">http</span>
                <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">(</span><span class="n">oauth2</span> <span class="o">-&gt;</span> <span class="n">oauth2</span><span class="o">.</span><span class="na">jwt</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">()))</span>

                <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span>
                        <span class="n">c</span><span class="o">.</span><span class="na">defaultAuthenticationEntryPointFor</span><span class="o">(</span>
                                <span class="k">new</span> <span class="nf">LoginUrlAuthenticationEntryPoint</span><span class="o">(</span><span class="s">"/login"</span><span class="o">),</span>
                                <span class="k">new</span> <span class="nf">MediaTypeRequestMatcher</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)))</span>

                <span class="o">.</span><span class="na">formLogin</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// @formatter:on</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>AuthorizationServerConfig.java</code> file, we have defined the <code>authorizationSecurityFilterChain</code> bean to configure the security filter chain for the authorization server. We have applied the default security settings and configured the OAuth2 authorization server and OAuth2 resource server.</p>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application">Run the Application</h3>
<div class="paragraph">
<p>Now, run the application using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>./gradlew bootRun</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openid-configuration">OpenID Configuration</h3>
<div class="paragraph">
<p>If Authorization Server is running, you can access the OpenID Configuration endpoint using the following URL:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8081/.well-known/openid-configuration" class="bare">http://localhost:8081/.well-known/openid-configuration</a></p>
</div>
<div class="paragraph">
<p>The OpenID Configuration endpoint provides information about the OAuth2 server.</p>
</div>
<div class="paragraph">
<p>Here is an example of the response from the OpenID Configuration endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authorization_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/oauth2/authorize"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"device_authorization_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/oauth2/device_authorization"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"token_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/oauth2/token"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"token_endpoint_auth_methods_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"client_secret_basic"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"client_secret_post"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"client_secret_jwt"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"private_key_jwt"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tls_client_auth"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"self_signed_tls_client_auth"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"jwks_uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/oauth2/jwks"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"userinfo_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/userinfo"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"end_session_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/connect/logout"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"response_types_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"code"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"grant_types_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"authorization_code"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"client_credentials"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"refresh_token"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"urn:ietf:params:oauth:grant-type:device_code"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"urn:ietf:params:oauth:grant-type:token-exchange"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"revocation_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/oauth2/revoke"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"revocation_endpoint_auth_methods_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"client_secret_basic"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"client_secret_post"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"client_secret_jwt"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"private_key_jwt"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tls_client_auth"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"self_signed_tls_client_auth"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"introspection_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8081/oauth2/introspect"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"introspection_endpoint_auth_methods_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"client_secret_basic"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"client_secret_post"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"client_secret_jwt"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"private_key_jwt"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tls_client_auth"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"self_signed_tls_client_auth"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"code_challenge_methods_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"S256"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"tls_client_certificate_bound_access_tokens"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"subject_types_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"public"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"id_token_signing_alg_values_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"RS256"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"scopes_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"openid"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-gateway-as-oauth2-client">Spring Cloud Gateway as OAuth2 Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to use the same Spring Cloud Gateway project that we created in the previous article. We will add the OAuth2 client configuration to the Spring Cloud Gateway project.</p>
</div>
<div class="sect2">
<h3 id="add-dependencies-2">Add Dependencies</h3>
<div class="listingblock">
<div class="title">build.gradle.kts</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">dependencies</span> <span class="p">{</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.cloud:spring-cloud-starter-gateway-mvc"</span><span class="p">)</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-web"</span><span class="p">)</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-oauth2-client"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="nf">compileOnly</span><span class="p">(</span><span class="s">"org.projectlombok:lombok"</span><span class="p">)</span>
    <span class="nf">annotationProcessor</span><span class="p">(</span><span class="s">"org.projectlombok:lombok"</span><span class="p">)</span>
    <span class="nf">testImplementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-test"</span><span class="p">)</span>
    <span class="nf">testRuntimeOnly</span><span class="p">(</span><span class="s">"org.junit.platform:junit-platform-launcher"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the <code>build.gradle.kts</code> file, we have added the <code>spring-boot-starter-oauth2-client</code> dependency to enable OAuth2 client support in the application.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configure-oauth2-client">Configure OAuth2 Client</h3>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring.application.name</span><span class="pi">:</span>
  <span class="s">nsa2-gateway</span>


<span class="na">server</span><span class="pi">:</span>
  <span class="na">tomcat.threads.max</span><span class="pi">:</span> <span class="m">10</span>
  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">servlet.session.cookie</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">NSA2SESSION</span>

<i class="conum" data-value="2"></i><b>(2)</b>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">cloud</span><span class="pi">:</span>
    <span class="na">gateway</span><span class="pi">:</span>
      <span class="na">mvc</span><span class="pi">:</span>
        <span class="na">routes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">resource-server</span>
            <span class="na">uri</span><span class="pi">:</span> <span class="s">${NSA2_RESOURCE_SERVER_URI:http://127.0.0.1:8082}</span>
            <span class="na">predicates</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">Path=/resource-server/**</span>
            <span class="na">filters</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">StripPrefix=1</span>
              <span class="pi">-</span> <span class="s">AddRequestHeader=Origin, http://nsa2-gateway:8080</span>
              <i class="conum" data-value="3"></i><b>(3)</b>
              <span class="pi">-</span> <span class="s">TokenRelay=</span>

<i class="conum" data-value="4"></i><b>(4)</b>
<span class="na">spring.threads.virtual.enabled</span><span class="pi">:</span> <span class="kc">true</span>

<i class="conum" data-value="5"></i><b>(5)</b>
<span class="na">spring.security.oauth2.client</span><span class="pi">:</span>
  <span class="na">registration</span><span class="pi">:</span>
    <span class="na">nsa2</span><span class="pi">:</span>
      <span class="na">provider</span><span class="pi">:</span> <span class="s">spring</span>
      <span class="na">client-id</span><span class="pi">:</span> <span class="s">nsa2</span>
      <span class="na">client-secret</span><span class="pi">:</span> <span class="s">secret</span>
      <span class="na">authorization-grant-type</span><span class="pi">:</span> <span class="s">authorization_code</span>
      <span class="na">scope</span><span class="pi">:</span> <span class="s">openid,profile,nsa2.user.all,nsa2.user.read,nsa2.user.write,nsa2.admin</span>
      <span class="na">redirect-uri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://127.0.0.1:8080/login/oauth2/code/{registrationId}"</span>

  <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="na">provider</span><span class="pi">:</span>
    <span class="na">spring</span><span class="pi">:</span>
      <span class="na">issuer-uri</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8081</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cookie name for the session</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Gateway routes configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>TokenRelay filter to relay the access token to the downstream service</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Enable Virtual Threads</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>OAuth2 client configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>OAuth2 provider configuration</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please make sure that client-id and client-secret are the same as the client-id and client-secret defined in the <code>application.yml</code> file of the Spring Authorization Server.</p>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application-2">Run the Application</h3>
<div class="paragraph">
<p>Now, run the application using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>./gradlew bootRun</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resource-server-example">Resource Server example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to use the same Resource Server project that we created in the previous article. We will add the OAuth2 resource server configuration to the Resource Server project.</p>
</div>
<div class="sect2">
<h3 id="add-dependencies-3">Add Dependencies</h3>
<div class="listingblock">
<div class="title">build.gradle.kts</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">dependencies</span> <span class="p">{</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-web"</span><span class="p">)</span>
    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-oauth2-resource-server"</span><span class="p">)</span>
    <span class="nf">compileOnly</span><span class="p">(</span><span class="s">"org.projectlombok:lombok"</span><span class="p">)</span>
    <span class="nf">annotationProcessor</span><span class="p">(</span><span class="s">"org.projectlombok:lombok"</span><span class="p">)</span>
    <span class="nf">testImplementation</span><span class="p">(</span><span class="s">"org.springframework.boot:spring-boot-starter-test"</span><span class="p">)</span>
    <span class="nf">testRuntimeOnly</span><span class="p">(</span><span class="s">"org.junit.platform:junit-platform-launcher"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the <code>build.gradle.kts</code> file, we have added the <code>spring-boot-starter-oauth2-resource-server</code> dependency to enable OAuth2 resource server support in the application.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configure-oauth2-resource-server">Configure OAuth2 Resource Server</h3>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring.application.name</span><span class="pi">:</span> <span class="s">nsa2-resource-server-example</span>


<span class="na">server</span><span class="pi">:</span>
  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8082</span>
  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="na">tomcat.threads.max</span><span class="pi">:</span> <span class="m">10</span>

<i class="conum" data-value="3"></i><b>(3)</b>
<span class="na">spring.threads.virtual.enabled</span><span class="pi">:</span> <span class="kc">false</span>

<i class="conum" data-value="4"></i><b>(4)</b>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">security</span><span class="pi">:</span>
    <span class="na">oauth2</span><span class="pi">:</span>
      <span class="na">resourceserver</span><span class="pi">:</span>
        <span class="na">jwt</span><span class="pi">:</span>
          <span class="na">issuer-uri</span><span class="pi">:</span> <span class="s">${NSA2_JWT_ISSUER_URI:http://localhost:8081}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Server port configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tomcat threads configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable Virtual Threads</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>OAuth2 resource server configuration</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please make sure that the issuer-uri is the same as the issuer-uri defined in the <code>application.yml</code> file of the Spring Authorization Server.</p>
</div>
</div>
<div class="sect2">
<h3 id="secure-controller">Secure Controller</h3>
<div class="listingblock">
<div class="title">SecureController.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureController</span> <span class="o">{</span>
    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/access_token"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">accessToken</span><span class="o">(</span><span class="nc">JwtAuthenticationToken</span> <span class="n">jwtToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">tokenAttributes</span> <span class="o">=</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getTokenAttributes</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"principal class: {}"</span><span class="o">,</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>

        <span class="kt">var</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"authorities: {}"</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
                <span class="s">"principal"</span><span class="o">,</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                <span class="s">"access_token"</span><span class="o">,</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">().</span><span class="na">getTokenValue</span><span class="o">(),</span>
                <span class="s">"authorities"</span><span class="o">,</span> <span class="n">authorities</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span>
                <span class="s">"scope"</span><span class="o">,</span><span class="n">tokenAttributes</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"scope"</span><span class="o">)</span> <span class="o">?</span> <span class="n">tokenAttributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"scope"</span><span class="o">).</span><span class="na">toString</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('SCOPE_nsa2.user.all') or hasAuthority('SCOPE_nsa2.user.read') or hasAuthority('SCOPE_nsa2.user.write')"</span><span class="o">)</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">hello</span><span class="o">(</span><span class="nc">Principal</span> <span class="n">principal</span><span class="o">,</span> <span class="nc">JwtAuthenticationToken</span> <span class="n">jwtToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"principal: {}"</span><span class="o">,</span> <span class="n">principal</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"name: {}"</span><span class="o">,</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"principal class: {}"</span><span class="o">,</span> <span class="n">principal</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"jwtToken class: {}"</span><span class="o">,</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"authorities: {}"</span><span class="o">,</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
        <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"ResourceServer - Hello, "</span> <span class="o">+</span> <span class="n">principal</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('SCOPE_nsa2.admin')"</span><span class="o">)</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/admin/hello"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">adminHello</span><span class="o">(</span><span class="nc">Principal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"ResourceServer - Admin Hello, "</span> <span class="o">+</span> <span class="n">principal</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>


<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>accessToken</code> method returns the access token information.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>hello</code> method is secured with the <code>SCOPE_nsa2.user.all</code>, <code>SCOPE_nsa2.user.read</code>, and <code>SCOPE_nsa2.user.write</code> scopes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>adminHello</code> method is secured with the <code>SCOPE_nsa2.admin</code> scope.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For demonstration purposes, we have added the <code>accessToken</code> method to display the access token information. But on production, you should not expose the access token information. Normally access tokens are managed by the OAuth2 client and are not exposed to the browser. Only Session ID is exposed to the browser for security reasons.</p>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application-3">Run the Application</h3>
<div class="paragraph">
<p>Now, run the application using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>./gradlew bootRun</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-resource-server-without-access-token">Test Resource Server without Access Token</h3>
<div class="paragraph">
<p>Now this application is running as a resource server. So an access token is required to access the protected resources.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s test the resource server without an access token. Open the browser and access the following URL or using curl command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>curl http://127.0.0.1:8082/access_token <span class="nt">-I</span>

HTTP/1.1 401
WWW-Authenticate: Bearer
X-Content-Type-Options: nosniff
X-XSS-Protection: 0
Cache-Control: no-cache, no-store, max-age<span class="o">=</span>0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Length: 0
Date: Thu, 26 Sep 2024 15:19:22 GMT</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will return the HTTP status code 401 Unauthorized with the <code>WWW-Authenticate: Bearer</code> header. This means that the access token is required to access the protected resources.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-gateway-and-resource-server-all-together">Test Gateway and Resource Server all together</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, open the browser and access the following URL:</p>
</div>
<div class="paragraph">
<p><a href="http://127.0.0.1:8080/resource-server/access_token" class="bare">http://127.0.0.1:8080/resource-server/access_token</a></p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/test-1.png" alt="test 1">
</div>
<div class="title">Figure 2. Login Screen</div>
</div>
<div class="paragraph">
<p>Login screen will appear that is provided by the Authorization Server. Please notice that the port is 8081, which is the port of the Authorization Server.</p>
</div>
<div class="paragraph">
<p>Enter the username and password. The default username is <code>nsa2user</code> and the password is <code>password</code>.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/test-2.png" alt="test 2">
</div>
<div class="title">Figure 3. Consent Screen</div>
</div>
<div class="paragraph">
<p>Select all scopes except nsa2.admin and click the <code>Authorize</code> button.</p>
</div>
<div class="paragraph">
<p>The response will be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"authorities"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[SCOPE_nsa2.user.write, SCOPE_nsa2.user.all, SCOPE_openid, SCOPE_profile, SCOPE_nsa2.user.read]"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"principal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2user"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[nsa2.user.write, nsa2.user.all, openid, profile, nsa2.user.read]"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"access_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJraWQiOiJiMTc5YjU0MC0yMTkxLTQ5ZmItYTExYS0yYzJiNmMzNDQ5MzgiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJuc2EydXNlciIsImF1ZCI6Im5zYTIiLCJuYmYiOjE3MjczNDk4OTUsInNjb3BlIjpbIm5zYTIudXNlci53cml0ZSIsIm5zYTIudXNlci5hbGwiLCJvcGVuaWQiLCJwcm9maWxlIiwibnNhMi51c2VyLnJlYWQiXSwiaXNzIjoiaHR0cDovLzEyNy4wLjAuMTo4MDgxIiwiZXhwIjoxNzI3MzUwMTk1LCJpYXQiOjE3MjczNDk4OTUsImp0aSI6ImYyMjMxZWU5LTEwNTAtNDc2Yy1hOTQ5LTMxZWNjYmQwZWNhMiJ9.AxwYP891nlmFF2Z43fFDCRNsSbynC47oi0FsQRn6EurO0OGG7MOT3reJv7I843hiCIaIp6IdxCRRG-1U-gjmTci_WndnUnPS2VxWKWRVLetXGaRl0zLV7oaCDa5YYAaZIPFVa2Qne0A7dmLQu1V7hTii_r1qr-XJsbk33QJSD5S72IJ6P7JqESCt3zTQi9fNTXZBZleS7dwGwi4QGb4DOAq-ysnn2pB30qqms0fZD860LhBGnkydBymJgTLV_jf8rjsUvmNxkA5udcymrh7RUiTlGo3jXv62EXscSQ5XHtVAAITzQ06hiuvudTKwWl3FTgp73G7ONZFdKfGcleG7lA"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The authorities are <code>SCOPE_nsa2.user.write</code>, <code>SCOPE_nsa2.user.all</code>, <code>SCOPE_openid</code>, <code>SCOPE_profile</code>, and <code>SCOPE_nsa2.user.read</code> which is the format of 'SCOPE_{scope}'.</p>
</div>
<div class="paragraph">
<p>Now, access the following URL:</p>
</div>
<div class="paragraph">
<p><a href="http://127.0.0.1:8080/resource-server/hello" class="bare">http://127.0.0.1:8080/resource-server/hello</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('SCOPE_nsa2.user.all') or hasAuthority('SCOPE_nsa2.user.read') or hasAuthority('SCOPE_nsa2.user.write')"</span><span class="o">)</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">hello</span><span class="o">(</span><span class="nc">Principal</span> <span class="n">principal</span><span class="o">,</span> <span class="nc">JwtAuthenticationToken</span> <span class="n">jwtToken</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because nsa2user has the <code>SCOPE_nsa2.user.all</code>, <code>SCOPE_nsa2.user.read</code>, and <code>SCOPE_nsa2.user.write</code> scopes, the <code>hello</code> method will be accessible.</p>
</div>
<div class="paragraph">
<p>The response will be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ResourceServer - Hello, nsa2user"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, access the following URL:</p>
</div>
<div class="paragraph">
<p><a href="http://127.0.0.1:8080/resource-server/admin/hello" class="bare">http://127.0.0.1:8080/resource-server/admin/hello</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('SCOPE_nsa2.admin')"</span><span class="o">)</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/admin/hello"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">adminHello</span><span class="o">(</span><span class="nc">Principal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because nsa2user does not have the <code>SCOPE_nsa2.admin</code> scope, the <code>adminHello</code> method will not be accessible.</p>
</div>
<div class="paragraph">
<p>The response will be as follows:</p>
</div>
<div class="imageblock text-center img-wide">
<div class="content">
<img src="images/test-403-error.png" alt="test 403 error">
</div>
<div class="title">Figure 4. 403 Forbidden Error</div>
</div>
<div class="paragraph">
<p>The HTTP status code is 403 Forbidden.</p>
</div>
<div class="sect2">
<h3 id="use-session-id-to-access-resource-server-through-gateway">Use Session ID to Access Resource Server through Gateway</h3>
<div class="paragraph">
<p>Tokens are managed by the OAuth2 client and are not exposed to the browser. Only the Session ID is exposed to the browser for security reasons. The Session ID can be used to access the protected resources through the Gateway.</p>
</div>
<div class="paragraph">
<p>How to get the Session ID?</p>
</div>
<div class="paragraph">
<p>You can get the Session ID from the browser&#8217;s developer tools. Open the browser&#8217;s developer tools and go to the <code>Application</code> tab. You will see the <code>Cookies</code> section. The Session ID is stored in the <code>NSA2SESSION</code> cookie.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/session-cookie.png" alt="session cookie">
</div>
<div class="title">Figure 5. Session Cookie</div>
</div>
<div class="paragraph">
<p>To access the URL using the Session ID, you can use the curl command with the -b or --cookie option. Here is how you can do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>curl http://127.0.0.1:8080/resource-server/hello <span class="nt">-I</span> <span class="nt">--cookie</span> <span class="nv">NSA2SESSION</span><span class="o">=</span>7599A59CD27ED74582B9EFAEE82A2CD0

HTTP/1.1 200
cache-control: no-cache, no-store, max-age<span class="o">=</span>0, must-revalidate
<span class="nb">date</span>: Thu, 26 Sep 2024 15:42:14 GMT
expires: 0
pragma: no-cache
x-content-type-options: nosniff
x-frame-options: DENY
x-xss-protection: 0
Content-Type: application/json
Transfer-Encoding: chunked</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can see that the HTTP status code is 200 OK. This means that the protected resource is accessible using the Session ID.</p>
</div>
</div>
<div class="sect2">
<h3 id="jwt-token-decoding">JWT Token Decoding</h3>
<div class="paragraph">
<p>You can decode the JWT token using the following URL:</p>
</div>
<div class="paragraph">
<p><a href="https://jwt.io/" class="bare">https://jwt.io/</a></p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="images/jwt-decoding.png" alt="jwt decoding">
</div>
<div class="title">Figure 6. JWT decoding</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article, we discussed how to use Spring Cloud Gateway as an OAuth2 client to an OAuth2 server. We also discussed how to use Spring Authorization Server as an OAuth2 server. We created a Spring Authorization Server project, a Spring Cloud Gateway project, and a Resource Server project. We configured the OAuth2 client, OAuth2 resource server, and secured the controller using the <code>@PreAuthorize</code> annotation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.baeldung.com/spring-cloud-gateway-oauth2">Spring Cloud Gateway with OAuth2</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/sample-gateway-oauth2login" class="bare">https://github.com/spring-cloud-samples/sample-gateway-oauth2login</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-session/reference/index.html" class="bare">https://docs.spring.io/spring-session/reference/index.html</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/reference/servlet/authentication/session-management.html" class="bare">https://docs.spring.io/spring-security/reference/servlet/authentication/session-management.html</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/gatewayfilter-factories/addrequestheader-factory.html" class="bare">https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/gatewayfilter-factories/addrequestheader-factory.html</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html" class="bare">https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/reference/servlet/appendix/database-schema.html" class="bare">https://docs.spring.io/spring-security/reference/servlet/appendix/database-schema.html</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="articles">Articles</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://dev.to/relive27/spring-cloud-gateway-combined-with-the-security-practice-of-oauth20-protocol-1m3b" class="bare">https://dev.to/relive27/spring-cloud-gateway-combined-with-the-security-practice-of-oauth20-protocol-1m3b</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://medium.com/@alperkrtglu/spring-oauth2-with-keycloak-moving-from-scope-to-roles-34247f3ff78e" class="bare">https://medium.com/@alperkrtglu/spring-oauth2-with-keycloak-moving-from-scope-to-roles-34247f3ff78e</a></p>
</div>
</div>
</div>
</div>
        </div>
    </main>
</div>




<script>
    const toc = document.getElementById('toc');
    const container = document.getElementById('toc-container');
    if (toc && container) {
        container.appendChild(toc);
    }
</script>


<!--<button onclick="toggleTheme()" style="position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; background-color: var(&#45;&#45;link); color: white; border: none; border-radius: 0.375rem; cursor: pointer;">-->
<!--    Toggle Theme-->
<!--</button>-->

<!--<script>-->
<!--    function toggleTheme() {-->
<!--        const html = document.documentElement;-->
<!--        const isDark = html.getAttribute("data-theme") === "dark";-->
<!--        html.setAttribute("data-theme", isDark ? "light" : "dark");-->
<!--        localStorage.setItem("theme", isDark ? "light" : "dark");-->
<!--    }-->

<!--    document.addEventListener("DOMContentLoaded", () => {-->
<!--        const savedTheme = localStorage.getItem("theme") || "light";-->
<!--        document.documentElement.setAttribute("data-theme", savedTheme);-->
<!--    });-->
<!--</script>-->

<!-- Footer -->
<footer class="bg-gray-900 text-white text-sm py-6 text-center">
    © 2025 Service Foundry. All rights reserved.
</footer>
</body>
</html>
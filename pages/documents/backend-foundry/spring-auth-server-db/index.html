<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spring Cloud Gateway with Spring Authorization Server using Database</title>
    <!-- rouge source highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/service-foundry/pages/assets/css/main.css">

    <!-- Highlight.js script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</head>
<body class="">

<!-- Header -->
<header>
<!--    <div class="logo text-xl font-semibold">Service Foundry</div>-->
    <a href="/service-foundry/pages/index.html" class="text-2xl font-semibold hover:text-teal-400">
    Service Foundry
</a>
    <nav>
    
        
        <a href="/service-foundry/pages/getting-started/" class="">Getting Started</a>
    
        
        <a href="/service-foundry/pages/products/" class="">Products</a>
    
        
        <a href="/service-foundry/pages/documents/" class="active">Docs</a>
    
        
        <a href="/service-foundry/pages/github/" class="">GitHub</a>
    
        
        <a href="/service-foundry/pages/developers/" class="">Developers</a>
    
        
        <a href="/service-foundry/pages/demo/" class="">Demo</a>
    
</nav>
</header>


    <!-- Sub-navigation for Foundries -->
    <div class="subnav">

    
    <a href="/service-foundry/pages/documents/service-foundry/" class="">Service Foundry</a>

    
    <a href="/service-foundry/pages/documents/blog/" class="">Blog</a>

    
    <a href="/service-foundry/pages/documents/infra-foundry/" class="">Infra</a>

    
    <a href="/service-foundry/pages/documents/sso-foundry/" class="">SSO</a>

    
    <a href="/service-foundry/pages/documents/o11y-foundry/" class="">Observability</a>

    
    <a href="/service-foundry/pages/documents/backend-foundry/" class="active">Backend</a>

    
    <a href="/service-foundry/pages/documents/bigdata-foundry/" class="">Big Data</a>

<!--    <a href="/service-foundry/pages/documents/infra-foundry/index-backup.html" class="text-gray-300 hover:text-white">Infra</a>-->
<!--    <a href="/service-foundry/pages/documents/sso-foundry/index-backup.html" class="text-gray-300 hover:text-white">SSO</a>-->
<!--    <a href="/service-foundry/pages/documents/o11y-foundry/index-backup.html" class="text-gray-300 hover:text-white">Observability</a>-->
<!--    <a href="/service-foundry/pages/documents/backend-foundry/index-backup.html" class="text-gray-300 hover:text-white">Backend</a>-->
<!--    <a href="/service-foundry/pages/documents/bigdata-foundry/index-backup.html" class="text-gray-300 hover:text-white">Big Data</a>-->
</div>





<!-- Breadcrumb -->

    <nav class="breadcrumb-wrapper">
    <ol class="breadcrumb">
        
        <li>
            
            <a href="/service-foundry/pages/">Home</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/">Docs</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/backend-foundry/">Backend Foundry</a>
            
            
        </li>
        
    </ol>
</nav>





<!-- Main Layout -->
<div class="container">


    <nav id="toc-container" class="toc-nav"></nav>


    <main id="main-content">
        
        <div class="author-box">
            Young Gyu Kim
            &lt;<a href="mailto:credemol@gmail.com" style="color: #0d9488; text-decoration: none;">credemol@gmail.com</a>&gt;
        </div>
        

        <!-- Title -->
        
        <h1 class="page-title">
            Spring Cloud Gateway with Spring Authorization Server using Database
        </h1>
        

        <div class="asciidoc">
            <div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#prerequisites">Prerequisites</a></li>
</ul>
</li>
<li><a href="#database-setup">Database Setup</a></li>
<li><a href="#create-database-tables-for-spring-authorization-server">Create database tables for Spring Authorization Server</a>
<ul class="sectlevel2">
<li><a href="#schema-files-for-userdetailsservice">Schema files for UserDetailsService</a></li>
<li><a href="#schema-files-for-oauth2">Schema files for OAuth2</a></li>
<li><a href="#create-uuid-ossp-extension">Create uuid-ossp extension</a></li>
</ul>
</li>
<li><a href="#insert-data-into-the-tables">Insert data into the tables</a>
<ul class="sectlevel2">
<li><a href="#users-and-authorities">Users and Authorities</a></li>
<li><a href="#registered-client">Registered Client</a></li>
<li><a href="#authorization-consent">Authorization Consent</a></li>
<li><a href="#authorization">Authorization</a></li>
</ul>
</li>
<li><a href="#update-spring-authorization-server">Update Spring Authorization Server</a>
<ul class="sectlevel2">
<li><a href="#application-yml">application.yml</a></li>
<li><a href="#securityconfig-java">SecurityConfig.java</a></li>
<li><a href="#authorizationserverconfig-java">AuthorizationServerConfig.java</a></li>
</ul>
</li>
<li><a href="#deploy-applications-on-kubernetes">Deploy applications on Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#port-forwarding">Port forwarding</a></li>
<li><a href="#update-etchosts">Update /etc/hosts</a></li>
</ul>
</li>
<li><a href="#test-the-applications">Test the applications</a>
<ul class="sectlevel2">
<li><a href="#access-the-resource-server-using-curl">Access the resource server using cURL</a></li>
<li><a href="#access-the-resource-server-using-postman">Access the resource server using Postman</a></li>
</ul>
</li>
<li><a href="#distributed-tracing">Distributed Tracing</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This article is part of a series on Spring Cloud Gateway. The other articles in the series are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Part 1: Spring Cloud Gateway with Virtual Threads</p>
</li>
<li>
<p>Part 2: Spring Cloud Gateway with Spring Authorization Server</p>
</li>
<li>
<p>Part 3: Spring Cloud Gateway with Spring Authorization Server using Database</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is the third article in the series, which focuses on using Spring Authorization Server with a database as the backend.</p>
</div>
<div class="paragraph">
<p>In this article, we will set up a Spring Authorization Server using a database as the backend. We will use PostgreSQL as the database and set up the necessary tables for the Spring Authorization Server.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/spring-auth-server-database.png" alt="spring auth server database">
</div>
</div>
<div class="paragraph">
<p>There are 3 microservices in this example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Cloud Gateway (OAuth2 client, Port 8080)</p>
</li>
<li>
<p>Spring Authorization Server (OAuth2 server, Port 9000)</p>
</li>
<li>
<p>Resource Server example (Port 8082)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please note that the port number of OAuth2 Server is 9000 which used to be 8081 in the previous articles.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="prerequisites">Prerequisites</h3>
<div class="paragraph">
<p>Before you start, you need to have the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java 21</p>
</li>
<li>
<p>Gradle 8.10.1</p>
</li>
<li>
<p>PostgreSQL 16.4</p>
</li>
<li>
<p>Spring Boot 3.3.4</p>
</li>
<li>
<p>Spring CLI 3.2.4</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="database-setup">Database Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This article assumes that you have PostgreSQL 16.4 installed.
Here is some information about the database used in this article:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Database Name: nsa2</p>
</li>
<li>
<p>User: nsa2</p>
</li>
<li>
<p>Password: changeme</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-database-tables-for-spring-authorization-server">Create database tables for Spring Authorization Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Authorization Server is built on top of Spring Security. It uses a set of tables to store user information, authority information, and OAuth2 information.</p>
</div>
<div class="paragraph">
<p>Some database schemas such as users and authorities are provided by Spring Security. You can find the schema for the user and authority tables in the Spring Security documentation while the schema for OAuth2 tables is provided by Spring Authorization Server.</p>
</div>
<div class="sect2">
<h3 id="schema-files-for-userdetailsservice">Schema files for UserDetailsService</h3>
<div class="paragraph">
<p>You can find the schema for the user and authority tables in the Spring Security documentation.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-security/reference/servlet/appendix/database-schema.html" class="bare">https://docs.spring.io/spring-security/reference/servlet/appendix/database-schema.html</a></p>
</div>
<div class="paragraph">
<p>Here are tables for User and Authority:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>users</p>
</li>
<li>
<p>authorities</p>
</li>
<li>
<p>groups</p>
</li>
<li>
<p>group_authorities</p>
</li>
<li>
<p>group_members</p>
</li>
<li>
<p>persistent_logins(remember_me)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Among these tables, we will use the users and authorities tables for the Spring Authorization Server.</p>
</div>
<div class="paragraph">
<p>Here is the schema that Spring Security provides for the users and authorities tables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">users</span><span class="p">(</span>
	<span class="n">username</span> <span class="n">varchar_ignorecase</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
	<span class="n">password</span> <span class="n">varchar_ignorecase</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
	<span class="n">enabled</span> <span class="nb">boolean</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">authorities</span> <span class="p">(</span>
	<span class="n">username</span> <span class="n">varchar_ignorecase</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
	<span class="n">authority</span> <span class="n">varchar_ignorecase</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
	<span class="k">constraint</span> <span class="n">fk_authorities_users</span> <span class="k">foreign</span> <span class="k">key</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="k">references</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">ix_auth_username</span> <span class="k">on</span> <span class="n">authorities</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">authority</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the password keeps encrypted passwords in the users table. Its colume size is too small to store encrypted passwords. So, we need to update the schema for the users table to store encrypted passwords.</p>
</div>
<div class="paragraph">
<p>Here is an example of encrypted passwords for the users table of which size is 69.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{bcrypt}$2a$10$s2sHJSyGIzMpcKyVbbkYWuk9tDWmRe8rSolvCeJ14Y6JgWkGJWZ0S</pre>
</div>
</div>
<div class="paragraph">
<p>Here is the updated schema for the users and authorities table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">users</span><span class="p">(</span>
  <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">password</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">enabled</span> <span class="nb">boolean</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">authorities</span><span class="p">(</span>
    <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">authority</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">constraint</span> <span class="n">fk_authorities_users</span> <span class="k">foreign</span> <span class="k">key</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="k">references</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">ix_auth_username</span> <span class="k">on</span> <span class="n">authorities</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">authority</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For your information, we can use Spring CLI to encode passwords.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># to encode password</span>
<span class="nv">$ </span>spring encodepassword mypassword

<span class="o">{</span>bcrypt<span class="o">}</span><span class="nv">$2a$10$PLsAyCSJjqUZkKlLazQvreH4mzhLLlncAA3LSSSTRxmV5Xh</span>.aR1o6

<span class="c"># to count characters of encoded password</span>
<span class="nv">$ </span>spring encodepassword mypassword | <span class="nb">wc</span> <span class="nt">-c</span>

69</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="schema-files-for-oauth2">Schema files for OAuth2</h3>
<div class="paragraph">
<p>Here are tables for OAuth2 needed for the Spring Authorization Server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>oauth2_registered_client</p>
</li>
<li>
<p>oauth2_authorization_consents</p>
</li>
<li>
<p>oauth2_authorization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find the schema files for OAuth2 tables in the Spring Authorization Server source code.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-projects/spring-authorization-server/blob/main/oauth2-authorization-server/src/main/resources/org/springframework/security/oauth2/server/authorization/client/oauth2-registered-client-schema.sql">oauth2-registered-client-schema.sql</a></p>
</li>
<li>
<p><a href="https://github.com/spring-projects/spring-authorization-server/blob/main/oauth2-authorization-server/src/main/resources/org/springframework/security/oauth2/server/authorization/oauth2-authorization-consent-schema.sql">oauth2-authorization-consent-schema.sql</a></p>
</li>
<li>
<p><a href="https://github.com/spring-projects/spring-authorization-server/blob/main/oauth2-authorization-server/src/main/resources/org/springframework/security/oauth2/server/authorization/oauth2-authorization-schema.sql">oauth2-authorization-schema.sql</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These schema files are for H2 database. As they added comments for PostgreSQL, we need to update ALL columns defined with 'blob' to 'text' as PostgreSQL does not support 'blob' type.</p>
</div>
<div class="paragraph">
<p>The source below can be found in a Demo application of Spring Authorization Server.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-projects/spring-authorization-server/blob/main/samples/demo-authorizationserver/src/main/java/sample/config/AuthorizationServerConfig.java">AuthorizationServerConfig.java</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">EmbeddedDatabase</span> <span class="nf">embeddedDatabase</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// @formatter:off</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">EmbeddedDatabaseBuilder</span><span class="o">()</span>
				<span class="o">.</span><span class="na">generateUniqueName</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
				<span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">EmbeddedDatabaseType</span><span class="o">.</span><span class="na">H2</span><span class="o">)</span>
				<span class="o">.</span><span class="na">setScriptEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">"org/springframework/security/oauth2/server/authorization/oauth2-authorization-schema.sql"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">"org/springframework/security/oauth2/server/authorization/oauth2-authorization-consent-schema.sql"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">"org/springframework/security/oauth2/server/authorization/client/oauth2-registered-client-schema.sql"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">build</span><span class="o">();</span>
		<span class="c1">// @formatter:on</span>
	<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This code snippet will be useful when you want to see how oauth clients are registered in the database. If you want to see about the sample application, please refer to the link below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-projects/spring-authorization-server/blob/main/samples/README.adoc">Spring Authorization Server Demo Sample</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="schema-files-for-oauth2-for-postgresql">Schema files for OAuth2 for PostgreSQL</h4>
<div class="paragraph">
<p>Here are the schema files for OAuth2 tables for PostgreSQL that I modified and used in this article.</p>
</div>
<div class="listingblock">
<div class="title">pg-oauth2-registered-client-schema.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">oauth2_registered_client</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">client_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">client_id_issued_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">client_secret</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">client_secret_expires_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">client_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">client_authentication_methods</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorization_grant_types</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">redirect_uris</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">post_logout_redirect_uris</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">scopes</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">client_settings</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">token_settings</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pg-oauth2-authorization-consent-schema.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">oauth2_authorization_consent</span> <span class="p">(</span>
  <span class="n">registered_client_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">principal_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorities</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">registered_client_id</span><span class="p">,</span> <span class="n">principal_name</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pg-oauth2-authorization-schema.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">oauth2_authorization</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">registered_client_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">principal_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorization_grant_type</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorized_scopes</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">attributes</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">state</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorization_code_value</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorization_code_issued_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorization_code_expires_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">authorization_code_metadata</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">access_token_value</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">access_token_issued_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">access_token_expires_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">access_token_metadata</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">access_token_type</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">access_token_scopes</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">oidc_id_token_value</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">oidc_id_token_issued_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">oidc_id_token_expires_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">oidc_id_token_metadata</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">refresh_token_value</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">refresh_token_issued_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">refresh_token_expires_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">refresh_token_metadata</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">user_code_value</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">user_code_issued_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">user_code_expires_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">user_code_metadata</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">device_code_value</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">device_code_issued_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">device_code_expires_at</span> <span class="nb">timestamp</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">device_code_metadata</span> <span class="nb">text</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have the schema files for the users, authorities, and OAuth2 tables in PostgreSQL, we can apply them to Spring Authorization Server.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-uuid-ossp-extension">Create uuid-ossp extension</h3>
<div class="paragraph">
<p>Because the primary key of oauth2_registered_client is a text type, we need to create the uuid-ossp extension to generate a UUID for the primary key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="nv">"uuid-ossp"</span><span class="p">;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="insert-data-into-the-tables">Insert data into the tables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We need to insert data into the users and authorities tables to authenticate users.</p>
</div>
<div class="sect2">
<h3 id="users-and-authorities">Users and Authorities</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">insert</span> <span class="k">into</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">enabled</span><span class="p">)</span>
<span class="k">values</span>
    <span class="p">(</span><span class="s1">'nsa2admin'</span><span class="p">,</span> <span class="s1">'{noop}password'</span><span class="p">,</span> <span class="k">true</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'nsa2user'</span><span class="p">,</span> <span class="s1">'{noop}password'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">authorities</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">authority</span><span class="p">)</span> <span class="k">values</span>
     <span class="p">(</span><span class="s1">'nsa2admin'</span><span class="p">,</span> <span class="s1">'ROLE_NSA2_ADMIN'</span><span class="p">),</span>
     <span class="p">(</span><span class="s1">'nsa2admin'</span><span class="p">,</span> <span class="s1">'ROLE_NSA2_USER'</span><span class="p">),</span>
     <span class="p">(</span><span class="s1">'nsa2user'</span><span class="p">,</span> <span class="s1">'ROLE_NSA2_USER'</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to keep the password encrypted, you can use the bcrypt encoder to encode the password and then insert it into the users table as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">insert</span> <span class="k">into</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">enabled</span><span class="p">)</span>
<span class="k">values</span>
    <span class="p">(</span><span class="s1">'nsa2admin'</span><span class="p">,</span> <span class="s1">'{bcrypt}$2a$10$Q5LFmz17lVVmPmtyeb.iVOOMmO13x08lDxH3n.lBIcF490JcYn69e'</span><span class="p">,</span> <span class="k">true</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'nsa2user'</span><span class="p">,</span> <span class="s1">'{bcrypt}$2a$10$D2Yr.nuSq5S5IHmR7I4n.OcMiPxtg1OMy9TxxAw5FPcMPM1kxy14m'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="registered-client">Registered Client</h3>
<div class="paragraph">
<p>Here is an example of inserting data into the oauth2_registered_client table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">public</span><span class="p">.</span><span class="n">oauth2_registered_client</span>
<span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_id_issued_at</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span> <span class="n">client_secret_expires_at</span><span class="p">,</span>
 <span class="n">client_name</span><span class="p">,</span> <span class="n">client_authentication_methods</span><span class="p">,</span> <span class="n">authorization_grant_types</span><span class="p">,</span> <span class="n">redirect_uris</span><span class="p">,</span>
 <span class="n">post_logout_redirect_uris</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">client_settings</span><span class="p">,</span> <span class="n">token_settings</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'a6bb6993-c5ed-4ee7-8af7-fd3699574ccc'</span><span class="p">,</span>
        <span class="s1">'nsa2'</span><span class="p">,</span>
        <span class="n">now</span><span class="p">(),</span>
        <span class="s1">'{bcrypt}$2a$10$WksnCewKO8wpUCEyN7B1BuN0EqqLTp3KmWz0EMC1jYawLNCl4wBBS'</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">'NSA2 OAuth 2.0 Client'</span><span class="p">,</span>
        <span class="s1">'client_secret_basic'</span><span class="p">,</span>
        <span class="s1">'refresh_token,client_credentials,authorization_code'</span><span class="p">,</span>
        <span class="s1">'http://nsa2-gateway:8080/login/oauth2/code/nsa2'</span><span class="p">,</span>
        <span class="s1">'http://nsa2-gateway:8080/logged-out'</span><span class="p">,</span>
        <span class="s1">'openid,profile,nsa2.user.all,nsa2.user.read,nsa2.user.write,nsa2.admin'</span><span class="p">,</span>
        <span class="s1">'{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":false,"settings.client.require-authorization-consent":false}'</span><span class="p">,</span>
        <span class="s1">'{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.x509-certificate-bound-access-tokens":false,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","RS256"],"settings.token.access-token-time-to-live":["java.time.Duration",300.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000],"settings.token.device-code-time-to-live":["java.time.Duration",300.000000000]}'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For client_settings and token_settings, you can use the following JSON format of Map.</p>
</div>
</div>
<div class="sect2">
<h3 id="authorization-consent">Authorization Consent</h3>
<div class="paragraph">
<p>Here is an example of inserting data into the oauth2_authorization_consent table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">public</span><span class="p">.</span><span class="n">oauth2_authorization_consent</span>
<span class="p">(</span><span class="n">registered_client_id</span><span class="p">,</span> <span class="n">principal_name</span><span class="p">,</span> <span class="n">authorities</span><span class="p">)</span>
<span class="k">VALUES</span>
    <span class="p">(</span><span class="s1">'a6bb6993-c5ed-4ee7-8af7-fd3699574ccc'</span><span class="p">,</span> <span class="s1">'nsa2user'</span><span class="p">,</span>
     <span class="s1">'SCOPE_openid,SCOPE_profile,SCOPE_nsa2.user.all'</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'a6bb6993-c5ed-4ee7-8af7-fd3699574ccc'</span><span class="p">,</span> <span class="s1">'nsa2admin'</span><span class="p">,</span>
     <span class="s1">'SCOPE_openid,SCOPE_profile,SCOPE_nsa2.user.all, SCOPE_nsa2.admin'</span><span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="authorization">Authorization</h3>
<div class="paragraph">
<p>No need to insert data into the oauth2_authorization table as it will be created when the user logs in.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="update-spring-authorization-server">Update Spring Authorization Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We need to update the Spring Authorization Server to use the database as the backend. The source files below are the ones that I modified and used in this article.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>application.yml</p>
</li>
<li>
<p>SecurityConfig.java</p>
</li>
<li>
<p>AuthorizationServerConfig.java</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="application-yml">application.yml</h3>
<div class="paragraph">
<p>I leave the OAuth2 configuration commented out in the application.yml file so that you can tell the difference between the configuration with the database and the configuration without the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring.application.name</span><span class="pi">:</span> <span class="s">nsa2-auth-server</span>

<span class="na">server.port</span><span class="pi">:</span> <span class="m">9000</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">org.postgresql.Driver</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">${NSA2_AUTH_DB_URL:jdbc:postgresql://localhost:5432/nsa2}</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">${NSA2_AUTH_DB_USERNAME:nsa2}</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">${NSA2_AUTH_DB_PASSWORD:changeme}</span>
  <span class="na">main</span><span class="pi">:</span>
    <span class="na">banner-mode</span><span class="pi">:</span> <span class="s">off</span>

<span class="c1">#spring.security.oauth2.authorizationserver:</span>
<span class="c1">#  client:</span>
<span class="c1">#    nsa2-client:</span>
<span class="c1">#      registration:</span>
<span class="c1">#        client-id: "nsa2"</span>
<span class="c1">#        client-secret: "{noop}secret"</span>
<span class="c1">#        client-authentication-methods:</span>
<span class="c1">#          - "client_secret_basic"</span>
<span class="c1">#        authorization-grant-types:</span>
<span class="c1">#          - "authorization_code"</span>
<span class="c1">#          - "refresh_token"</span>
<span class="c1">#          - "client_credentials"</span>
<span class="c1">#        redirect-uris:</span>
<span class="c1">#          - "http://127.0.0.1:8080/login/oauth2/code/nsa2"</span>
<span class="c1">#        post-logout-redirect-uris:</span>
<span class="c1">#          - "http://127.0.0.1:8080/logged-out"</span>
<span class="c1">#        scopes:</span>
<span class="c1">#          - "openid"</span>
<span class="c1">#          - "profile"</span>
<span class="c1">#          - "nsa2.user.all"</span>
<span class="c1">#          - "nsa2.user.read"</span>
<span class="c1">#          - "nsa2.user.write"</span>
<span class="c1">#          - "nsa2.admin"</span>
<span class="c1">#</span>
<span class="c1">#      require-authorization-consent: true</span>
<span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">org.springframework</span><span class="pi">:</span> <span class="s">INFO</span>

<span class="na">management</span><span class="pi">:</span>
  <span class="na">endpoint.health.probes.enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">health</span><span class="pi">:</span>
    <span class="na">livenessstate.enabled</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">readinessstate.enabled</span><span class="pi">:</span> <span class="kc">true</span>

  <span class="na">endpoints.web.exposure.include</span><span class="pi">:</span> <span class="c1">#info,health,metrics,prometheus</span>
    <span class="pi">-</span> <span class="s">info</span>
    <span class="pi">-</span> <span class="s">health</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The server port is set to 9000.</p>
</li>
<li>
<p>The datasource is set to PostgreSQL.</p>
</li>
<li>
<p>The OAuth2 configuration is commented out.</p>
</li>
<li>
<p>The logging level is set to INFO. Set it to DEBUG if you want to see more detailed logs.</p>
</li>
<li>
<p>The management endpoint is enabled to be able to run on Kubernetes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="securityconfig-java">SecurityConfig.java</h3>
<div class="paragraph">
<p>I deliberately keep the in-memory user details manager commented out so that you can see the difference between the in-memory user details manager and the JDBC user details manager.</p>
</div>
<div class="listingblock">
<div class="title">SecurityConfig.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="o">{</span>

<span class="c1">//    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="c1">//    @Bean</span>
<span class="c1">//    UserDetailsService inMemoryUserDetailsManager() {</span>
<span class="c1">//        return new InMemoryUserDetailsManager(</span>
<span class="c1">//                User.withUsername("nsa2user")</span>
<span class="c1">//                        .password("{noop}password")</span>
<span class="c1">//                        .roles("NSA2_USER")</span>
<span class="c1">//                        .build(),</span>
<span class="c1">//                User.withUsername("nsa2admin")</span>
<span class="c1">//                        .password("{noop}password")</span>
<span class="c1">//                        .roles("NSA2_ADMIN", "NSA2_USER")</span>
<span class="c1">//                        .build()</span>
<span class="c1">//</span>
<span class="c1">//        );</span>
<span class="c1">//    }</span>

    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@Bean</span>
    <span class="nc">JdbcUserDetailsManager</span> <span class="nf">jdbcUserDetailsManager</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcUserDetailsManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Bean</span>
    <span class="nc">UserDetailsPasswordService</span> <span class="nf">userDetailsPasswordService</span><span class="o">(</span><span class="nc">UserDetailsManager</span> <span class="n">udm</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">newPassword</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">updated</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">withUserDetails</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">newPassword</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
            <span class="n">udm</span><span class="o">.</span><span class="na">updateUser</span><span class="o">(</span><span class="n">updated</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">updated</span><span class="o">;</span>
        <span class="o">};</span>
    <span class="o">}</span>


    <span class="nd">@Bean</span>
    <span class="c1">// @formatter:off</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">securityFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">var</span> <span class="n">allowedUris</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]</span> <span class="o">{</span>
                <span class="s">"/error"</span><span class="o">,</span>
                <span class="s">"/actuator/health"</span><span class="o">,</span>
                <span class="s">"/actuator/health/liveness"</span><span class="o">,</span>
                <span class="s">"/actuator/health/readiness"</span>
        <span class="o">};</span>

        <span class="k">return</span> <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">(</span><span class="n">authorizeRequests</span> <span class="o">-&gt;</span>
                        <span class="n">authorizeRequests</span><span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="n">allowedUris</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">formLogin</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// @formatter:on</span>


<span class="o">}</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The in-memory user details manager is commented out.</p>
</li>
<li>
<p>The JDBC user details manager is enabled.</p>
</li>
<li>
<p>The UserDetailsPasswordService is added to update the user&#8217;s password.</p>
</li>
<li>
<p>The security filter chain is set to allow some URIs without authentication to be able to access the health check endpoints.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="userdetailspasswordservice">UserDetailsPasswordService</h4>
<div class="paragraph">
<p>When using UserDetailsPasswordService, you can update the user&#8217;s password seamlessly. For example, if the value of password is {noop}mypassword, it will be updated to the value below when users sign in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{bcrypt}$2a$10$jnuK/QseZ0/Ns5AclK5SnuP2yVQMPDvknXM7KTVDLCHsCYuQSZGLq</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="authorizationserverconfig-java">AuthorizationServerConfig.java</h3>
<div class="listingblock">
<div class="title">AuthorizationServerConfig.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationServerConfig</span> <span class="o">{</span>

    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="c1">// @formatter:off</span>
    <span class="nd">@Order</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
    <span class="nd">@Bean</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">authorizationSecurityFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">applyDefaultSecurity</span><span class="o">(</span><span class="n">http</span><span class="o">);</span>
        <span class="n">http</span><span class="o">.</span><span class="na">getConfigurer</span><span class="o">(</span><span class="nc">OAuth2AuthorizationServerConfigurer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">oidc</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">http</span>
                <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">(</span><span class="n">oauth2</span> <span class="o">-&gt;</span> <span class="n">oauth2</span><span class="o">.</span><span class="na">jwt</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span>
                        <span class="n">c</span><span class="o">.</span><span class="na">defaultAuthenticationEntryPointFor</span><span class="o">(</span>
                                <span class="k">new</span> <span class="nf">LoginUrlAuthenticationEntryPoint</span><span class="o">(</span><span class="s">"/login"</span><span class="o">),</span>
                                <span class="k">new</span> <span class="nf">MediaTypeRequestMatcher</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)))</span>

                <span class="o">.</span><span class="na">formLogin</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// @formatter:on</span>

    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JdbcRegisteredClientRepository</span> <span class="nf">registeredClientRepository</span><span class="o">(</span><span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcRegisteredClientRepository</span><span class="o">(</span><span class="n">jdbcTemplate</span><span class="o">);</span>
    <span class="o">}</span>

    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JdbcOAuth2AuthorizationService</span> <span class="nf">authorizationService</span><span class="o">(</span>
            <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">,</span>
            <span class="nc">RegisteredClientRepository</span> <span class="n">registeredClientRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcOAuth2AuthorizationService</span><span class="o">(</span><span class="n">jdbcTemplate</span><span class="o">,</span> <span class="n">registeredClientRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JdbcOAuth2AuthorizationConsentService</span> <span class="nf">authorizationConsentService</span><span class="o">(</span>
            <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">,</span>
            <span class="nc">RegisteredClientRepository</span> <span class="n">registeredClientRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcOAuth2AuthorizationConsentService</span><span class="o">(</span><span class="n">jdbcTemplate</span><span class="o">,</span> <span class="n">registeredClientRepository</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This is a typical SecurityFilterChain configuration for the Authorization Server. It is set to use the default security configuration and OIDC.</p>
</li>
<li>
<p>The JdbcRegisteredClientRepository is added to use the JDBC backend for the registered client repository.</p>
</li>
<li>
<p>The JdbcOAuth2AuthorizationService is added to use the JDBC backend for the OAuth2 authorization service.</p>
</li>
<li>
<p>The JdbcOAuth2AuthorizationConsentService is added to use the JDBC backend for the OAuth2 authorization consent service.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-applications-on-kubernetes">Deploy applications on Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have set up the database and updated the Spring Authorization Server, we can deploy the applications on Kubernetes.</p>
</div>
<div class="paragraph">
<p>To test the whole process of the Spring Authorization Server with the database, we need to deploy the following applications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>msa2-auth-server</p>
</li>
<li>
<p>msa2-gateway</p>
</li>
<li>
<p>msa2-resource-server-example</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As always. I created a Helm chart for each application and configured Observability features to monitor the applications.</p>
</div>
<div class="paragraph">
<p>Here is an example of the deployment manifest file for the msa2-auth-server.</p>
</div>
<div class="listingblock">
<div class="title">templates/deployment.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml">          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">JAVA_TOOL_OPTIONS</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">-javaagent:/usr/app/javaagent/opentelemetry-javaagent.jar"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_EXPORTER_OTLP_ENDPOINT</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://otel-collector:4318"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_LOGS_EXPORTER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">otlp"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_TRACES_EXPORTER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">otlp"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_METRICS_EXPORTER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">none"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LOGGING_LEVEL_ORG_SPRINGFRAMEWORK</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">INFO"</span>

            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">NSA2_AUTH_DB_URL</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">secretKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">postgresql-credentials</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">url</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">NSA2_AUTH_DB_USERNAME</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">secretKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">postgresql-credentials</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">username</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">NSA2_AUTH_DB_PASSWORD</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">secretKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">postgresql-credentials</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">password</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="port-forwarding">Port forwarding</h3>
<div class="paragraph">
<p>To access the applications, you need to port forward the services to your local machine.</p>
</div>
<div class="listingblock">
<div class="title">port-forward for nsa2-auth-server</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl <span class="nt">-n</span> nsa2 port-forward svc/nsa2-auth-server 9000:9000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">port-forward for nsa2-gateway</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl <span class="nt">-n</span> nsa2 port-forward svc/nsa2-gateway 8080:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the msa2-resource-server-example, no port forwarding is needed as it can be accessed from the Spring Cloud Gateway.</p>
</div>
</div>
<div class="sect2">
<h3 id="update-etchosts">Update /etc/hosts</h3>
<div class="paragraph">
<p>To access the applications with the domain name, you need to update the /etc/hosts file.</p>
</div>
<div class="listingblock">
<div class="title">/etc/hosts</div>
<div class="content">
<pre class="rouge highlight"><code>127.0.0.1	nsa2-gateway
127.0.0.1	nsa2-auth-server</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-the-applications">Test the applications</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To ensure that the browser cache is cleared, you can use the incognito mode of the browser.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have deployed the applications, we can test the applications.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go to the browser and access the following URLs:</p>
</div>
<div class="paragraph">
<p><a href="http://nsa2-gateway:8080/resource-server/access_token" class="bare">http://nsa2-gateway:8080/resource-server/access_token</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/webbrowser-1.png" alt="webbrowser 1">
</div>
</div>
<div class="paragraph">
<p>We can see the login page of the Spring Authorization Server with the domain name nsa2-auth-server and port 9000.</p>
</div>
<div class="paragraph">
<p>Input the username and password and click the "Log in" button.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/webbrowser-2.png" alt="webbrowser 2">
</div>
</div>
<div class="paragraph">
<p>After logging in, we can see the access token in the response.</p>
</div>
<div class="paragraph">
<p>The access token is saved in OAuth2 client which is nsa2-gateway as SecurityContext in the session. So we need Session ID to access the resource server through the gateway.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/webbrowser-3.png" alt="webbrowser 3">
</div>
</div>
<div class="paragraph">
<p>The session ID is saved in the cookie. So we need to copy the session ID from the cookie and paste it into the request header.</p>
</div>
<div class="sect2">
<h3 id="access-the-resource-server-using-curl">Access the resource server using cURL</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>curl http://nsa2-gateway:8080/resource-server/hello <span class="nt">-I</span> <span class="nt">--cookie</span> <span class="nv">NSA2SESSION</span><span class="o">=</span>F855460B64AC5503F5A15E950BD08CBE

HTTP/1.1 200
cache-control: no-cache, no-store, max-age<span class="o">=</span>0, must-revalidate
<span class="nb">date</span>: Mon, 30 Sep 2024 18:53:16 GMT
expires: 0
pragma: no-cache
x-content-type-options: nosniff
x-frame-options: DENY
x-xss-protection: 0
Content-Type: application/json
Transfer-Encoding: chunked</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="access-the-resource-server-using-postman">Access the resource server using Postman</h3>
<div class="paragraph">
<p>Need to set the cookie in the Postman Cookie Manager.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/postman-cookie-manager.png" alt="postman cookie manager">
</div>
</div>
<div class="paragraph">
<p>After setting the cookie, we can access the resource server using Postman.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/postman-request-1.png" alt="postman request 1">
</div>
</div>
<div class="paragraph">
<p>Now we can call the resource server using session ID cookie in the request header.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="distributed-tracing">Distributed Tracing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can monitor the applications using distributed tracing. I used Jaeger as the distributed tracing tool.</p>
</div>
<div class="paragraph">
<p>The screenshot below depicts that nsa2-gateway requests the access token from nsa2-auth-server. And then calls the resource server using the access token.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jaeger-1.png" alt="jaeger 1">
</div>
<div class="title">Figure 1. When USER SESSION has not been created.</div>
</div>
<div class="paragraph">
<p>We can see that nsa2-auth-server made some requests to the database to authenticate the user and authorize the client.</p>
</div>
<div class="paragraph">
<p>In contrast, the nsa2-gateway directly communicates with the resource server using the access token, without needing to contact the authorization server.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jaeger-2.png" alt="jaeger 2">
</div>
<div class="title">Figure 2. When USER SESSION has been created.</div>
</div>
<div class="paragraph">
<p>The image shows that the nsa2-gateway manages access tokens and refresh tokens in the session. So it does not need to request the access token from the authorization server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article, we set up a Spring Authorization Server using a database as the backend. We used PostgreSQL as the database and set up the necessary tables for the Spring Authorization Server.</p>
</div>
</div>
</div>
        </div>
    </main>
</div>




<script>
    const toc = document.getElementById('toc');
    const container = document.getElementById('toc-container');
    if (toc && container) {
        container.appendChild(toc);
    }
</script>


<!--<button onclick="toggleTheme()" style="position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; background-color: var(&#45;&#45;link); color: white; border: none; border-radius: 0.375rem; cursor: pointer;">-->
<!--    Toggle Theme-->
<!--</button>-->

<!--<script>-->
<!--    function toggleTheme() {-->
<!--        const html = document.documentElement;-->
<!--        const isDark = html.getAttribute("data-theme") === "dark";-->
<!--        html.setAttribute("data-theme", isDark ? "light" : "dark");-->
<!--        localStorage.setItem("theme", isDark ? "light" : "dark");-->
<!--    }-->

<!--    document.addEventListener("DOMContentLoaded", () => {-->
<!--        const savedTheme = localStorage.getItem("theme") || "light";-->
<!--        document.documentElement.setAttribute("data-theme", savedTheme);-->
<!--    });-->
<!--</script>-->

<!-- Footer -->
<footer class="bg-gray-900 text-white text-sm py-6 text-center">
     2025 Service Foundry. All rights reserved.
</footer>
</body>
</html>
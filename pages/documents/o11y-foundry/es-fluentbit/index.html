<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fluent-bit with Elasticsearch on K8s</title>
    <!-- rouge source highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/service-foundry/pages/assets/css/main.css">

    <!-- Highlight.js script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</head>
<body class="">

<!-- Header -->
<header>
<!--    <div class="logo text-xl font-semibold">Service Foundry</div>-->
    <a href="/service-foundry/pages/index.html" class="text-2xl font-semibold hover:text-teal-400">
    Service Foundry
</a>
    <nav>
    
        
        <a href="/service-foundry/pages/getting-started/" class="">Getting Started</a>
    
        
        <a href="/service-foundry/pages/products/" class="">Products</a>
    
        
        <a href="/service-foundry/pages/documents/" class="active">Docs</a>
    
        
        <a href="/service-foundry/pages/github/" class="">GitHub</a>
    
        
        <a href="/service-foundry/pages/developers/" class="">Developers</a>
    
        
        <a href="/service-foundry/pages/demo/" class="">Demo</a>
    
</nav>
</header>


    <!-- Sub-navigation for Foundries -->
    <div class="subnav">

    
    <a href="/service-foundry/pages/documents/blog/" class="">Blog</a>

    
    <a href="/service-foundry/pages/documents/infra-foundry/" class="">Infra</a>

    
    <a href="/service-foundry/pages/documents/sso-foundry/" class="">SSO</a>

    
    <a href="/service-foundry/pages/documents/o11y-foundry/" class="active">Observability</a>

    
    <a href="/service-foundry/pages/documents/backend-foundry/" class="">Backend</a>

    
    <a href="/service-foundry/pages/documents/bigdata-foundry/" class="">Big Data</a>

<!--    <a href="/service-foundry/pages/documents/infra-foundry/index-backup.html" class="text-gray-300 hover:text-white">Infra</a>-->
<!--    <a href="/service-foundry/pages/documents/sso-foundry/index-backup.html" class="text-gray-300 hover:text-white">SSO</a>-->
<!--    <a href="/service-foundry/pages/documents/o11y-foundry/index-backup.html" class="text-gray-300 hover:text-white">Observability</a>-->
<!--    <a href="/service-foundry/pages/documents/backend-foundry/index-backup.html" class="text-gray-300 hover:text-white">Backend</a>-->
<!--    <a href="/service-foundry/pages/documents/bigdata-foundry/index-backup.html" class="text-gray-300 hover:text-white">Big Data</a>-->
</div>





<!-- Breadcrumb -->

    <nav class="breadcrumb-wrapper">
    <ol class="breadcrumb">
        
        <li>
            
            <a href="/service-foundry/pages/">Home</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/">Docs</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/o11y-foundry/">Observability Foundry</a>
            
            
        </li>
        
    </ol>
</nav>





<!-- Main Layout -->
<div class="container">


    <nav id="toc-container" class="toc-nav"></nav>


    <main id="main-content">
        
        <div class="author-box">
            Young Gyu Kim
            &lt;<a href="mailto:credemol@gmail.com" style="color: #0d9488; text-decoration: none;">credemol@gmail.com</a>&gt;
        </div>
        

        <!-- Title -->
        
        <h1 class="page-title">
            Fluent-bit with Elasticsearch on K8s
        </h1>
        

        <div class="asciidoc">
            <div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#scenario">Scenario</a></li>
<li><a href="#centralized-logging-series">Centralized Logging series</a></li>
</ul>
</li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#install-fluent-bit-on-kubernetes">Install Fluent-bit on Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#create-a-namespace">Create a Namespace</a></li>
</ul>
</li>
<li><a href="#install-fluent-bit">Install Fluent-bit</a>
<ul class="sectlevel2">
<li><a href="#create-configmap-having-a-pem-file-for-fluent-bit">Create ConfigMap having a PEM file for Fluent-bit</a></li>
<li><a href="#log-parsers-for-spring-boot-application">Log Parsers for Spring Boot application</a></li>
<li><a href="#fluentbit-values-yaml">fluentbit-values.yaml</a></li>
<li><a href="#priorityclass">priorityClass</a></li>
<li><a href="#install-fluent-bit-using-helm-on-kubernetes">Install Fluent-bit using Helm on Kubernetes</a></li>
</ul>
</li>
<li><a href="#collecting-logs-from-the-spring-boot-application">Collecting logs from the Spring Boot application</a>
<ul class="sectlevel2">
<li><a href="#elasticsearch-index">Elasticsearch index</a></li>
<li><a href="#elasticsearch-documents-sent-by-fluent-bit">Elasticsearch documents sent by Fluent-bit</a></li>
</ul>
</li>
<li><a href="#test-script">Test script</a>
<ul class="sectlevel2">
<li><a href="#generate-logs-from-the-spring-boot-application">Generate logs from the Spring Boot application</a></li>
<li><a href="#generate-logs-with-different-log-levels">Generate logs with different log levels</a></li>
</ul>
</li>
<li><a href="#view-logs-in-kibana">View logs in Kibana</a>
<ul class="sectlevel2">
<li><a href="#create-a-new-data-view">Create a new Data View</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/centralized-logging-architecture.png" alt="centralized logging architecture" width="1000">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial, we will deploy Fluent-bit to Kubernetes. Fluent-bit will collect logs from the Spring Boot application and forward them to Elasticsearch. We will use the Helm package manager to deploy Fluent-bit and Elasticsearch to Kubernetes.</p>
</div>
<div class="paragraph">
<p>We are going to more focus on how to collect logs from the Spring Boot application and forward them to Elasticsearch. We will not cover the details of Elasticsearch in this tutorial.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/fluentbit-elasticsearch-k8s.png" alt="fluentbit elasticsearch k8s" width="1000">
</div>
</div>
<div class="sect2">
<h3 id="scenario">Scenario</h3>
<div class="paragraph">
<p>We are going to run a group of pods in Kubernetes and all pods have a prefix of <code>nsa2-</code>. In pods, if applications write log messages to stdout or stderr, then these log messages are saved in files under /var/log/containers directory of each Kubernetes node.
So, we will set the Fluent-bit configuration to read log messages from all files of which names are starting with nsa2- in the /var/log/containers/ folder of the Kubernetes node.
After Fluent-bit collects log messages from those files, and it will forward log messages to Elasticsearch for indexing. The index name will be <code>nsa2-{date-string}</code>.
Consequently, we can search and analyze the log messages in Kibana.</p>
</div>
</div>
<div class="sect2">
<h3 id="centralized-logging-series">Centralized Logging series</h3>
<div class="paragraph">
<p>This tutorial is the 4th part of the Centralized Logging series. The series covers the following topics:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Part 1 - Logging in Spring Boot Application</p>
</li>
<li>
<p>Part 2 - Deploying Spring Boot Application to Kubernetes</p>
</li>
<li>
<p>Part 3 - Installing Elasticsearch and Kibana to Kubernetes</p>
</li>
<li>
<p>Part 4 - Centralized Logging with Fluent-bit and Elasticsearch(Kubernetes)</p>
</li>
<li>
<p>Part 5 - Centralized Logging with Fluent-bit and Elasticsearch(On-premise)</p>
</li>
<li>
<p>Part 6 - Log Analysis with Apache Spark</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before you begin, ensure you have the following in place:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>Helm 3 installed</p>
</li>
<li>
<p>kubectl installed</p>
</li>
<li>
<p>A Spring Boot application deployed to Kubernetes</p>
</li>
<li>
<p>Elasticsearch installed</p>
</li>
<li>
<p>Kibana installed</p>
</li>
<li>
<p>A PEM file for Fluent-bit to use for TLS communication with Elasticsearch</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-fluent-bit-on-kubernetes">Install Fluent-bit on Kubernetes</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this tutorial, we are going to focus on how to collect logs from the Spring Boot applications and forward them to Elasticsearch. We will not cover the details of Elasticsearch in this tutorial. I have provided how to install Elasticsearch to Kubernetes using Helm in a separate tutorial.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="create-a-namespace">Create a Namespace</h3>
<div class="paragraph">
<p>Create a namespace for the logging components:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl create namespace logging
<span class="nv">$ </span>kubectl get namespaces</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-fluent-bit">Install Fluent-bit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we are going to add the Fluent Helm repository to Helm. Then we will create a ConfigMap to store the PEM file for Fluent-bit to use for TLS communication with Elasticsearch.</p>
</div>
<div class="listingblock">
<div class="title">Add the Fluent Helm repository</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>helm repo add fluent https://fluent.github.io/helm-charts
<span class="nv">$ </span>helm repo update
<span class="nv">$ </span>helm repo list
<span class="nv">$ </span>helm search repo fluent</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="create-configmap-having-a-pem-file-for-fluent-bit">Create ConfigMap having a PEM file for Fluent-bit</h3>
<div class="paragraph">
<p>We need a PEM file to communicate with Elasticsearch over HTTPS. We will create a PEM file for Fluent-bit to use for TLS communication with Elasticsearch.</p>
</div>
<div class="paragraph">
<p>I am using a PEM file named <code>elasticsearch-master.pem</code> for the Elasticsearch cluster. We will create a ConfigMap to store the PEM file for Fluent-bit to use for TLS communication with Elasticsearch.</p>
</div>
<div class="listingblock">
<div class="title">Create a ConfigMap for the PEM file</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl create configmap <span class="se">\</span>
  elasticsearch-master-ca-store <span class="se">\</span>
  <span class="nt">--from-file</span><span class="o">=</span>elasticsearch-master.pem<span class="o">=</span>elasticsearch-master.pem <span class="se">\</span>
  <span class="nt">-n</span> logging</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="log-parsers-for-spring-boot-application">Log Parsers for Spring Boot application</h3>
<div class="paragraph">
<p>It is crutial to understand the log message format of the Spring Boot application to parse the logs from the application. We will use the default log format of Spring Boot. If you want to use your own log format, you need to update the log parser in Fluent-bit configuration.</p>
</div>
<div class="sect3">
<h4 id="simple-log-message">Simple log message</h4>
<div class="paragraph">
<p>Let&#8217;s begin with an example of a simple log message from the Spring Boot application:</p>
</div>
<div class="listingblock">
<div class="title">an example of a simple log message</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="text">2024-05-27T22:14:06.787Z  INFO 1 --- [nsa2-logging-example] [           main] c.a.n.e.l.LoggingExampleApplication      : Application started successfully.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The log message has the following fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Named group</th>
<th class="tableblock halign-left valign-top">Captured value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2024-05-27T22:14:06.787Z</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INFO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nsa2-logging-example</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">main</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logger name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c.a.n.e.l.LoggingExampleApplication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application started successfully.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="named-capturing-groups">Named capturing groups</h4>
<div class="paragraph">
<p>When using regular expressions to parse log messages, named capturing groups are useful to extract fields from the log message.</p>
</div>
<div class="paragraph">
<p>For more information about named capturing groups, see the following link:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Named_capturing_group">Named capturing groups: (?&lt;name&gt;&#8230;&#8203;)</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We are going to use the following regular expression to parse the log message: This is an example of named capturing groups in regular expressions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="regexp">^(?&lt;timestamp&gt;[0-9-]+T[:0-9\.]+\d{3}Z)\s+(?&lt;level&gt;[A-Z]+)\s+\d+ \s\-{3}\s+\[(?&lt;appName&gt;[\w\-\d]+)\]+\s+\[\s*(?&lt;thread&gt;[\w\-\d]+)\]+ \s+[\w\d\.]*\.(?&lt;loggerClass&gt;[\w\.\d]+)\s+:(?&lt;message&gt;.*)$</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the regular expression above, we can extract the following fields from the log message:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Group name</th>
<th class="tableblock halign-left valign-top">Captured value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2024-05-27T22:14:06.787Z</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INFO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">appName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nsa2-logging-example</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">main</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">loggerClass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LoggingExampleApplication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application started successfully.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>I did not include the PID field in the regular expression because it is not useful on Kubernetes. The PID is the process ID of the application running in the container here. But sometimes, PID might be useful when applications are running On-Prem environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this section, I have set level, appName, thread, loggerClass, and message fields to show you how named capturing groups work. But when setting up Fluent-bit, I am not going to use all of these fields. I will use only the timestamp and message fields because Fluent-bit send a record in a chunk to Elasticsearch. So those fields in a record are not appropriate for each log message.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an online regex tester to test the regular expression: <a href="https://regex101.com/r/QDPqYB/1" class="bare">https://regex101.com/r/QDPqYB/1</a></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/regex101-example-1.png" alt="regex101 example 1" width="1000">
</div>
</div>
<div class="paragraph">
<p>It is handy to test the regular expression before using it in Fluent-bit configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fluentbit-values-yaml">fluentbit-values.yaml</h3>
<div class="paragraph">
<p>The fluentbit-values.yaml file contains the configuration for Fluent-bit. We will use this file when installing Fluent-bit to Kubernetes using Helm.</p>
</div>
<div class="sect3">
<h4 id="env-extravolumes-and-extravolumemounts">env, extraVolumes, and extraVolumeMounts</h4>
<div class="paragraph">
<p>In the <code>fluentbit-values.yaml</code>, we will provide the environment variables, extra volumes, and extra volume mounts for Fluent-bit.</p>
</div>
<div class="paragraph">
<p>Some resources regarding Elasticsearch like elasticsearch-master-credentials and elasticsearch-master-ca-store are created in the previous tutorials. We will use these resources in the Fluent-bit configuration.</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - env</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">env</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTIC_PASSWORD</span>
    <span class="na">valueFrom</span><span class="pi">:</span>
      <span class="na">secretKeyRef</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">elasticsearch-master-credentials</span>
        <span class="na">key</span><span class="pi">:</span> <span class="s">password</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ELASTIC_PASSWORD is the password for the Elasticsearch user. This will be used by Fluent-bit to connect to Elasticsearch.</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - extraVolumes</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">extraVolumes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">elasticsearch-master-ca-store</span>
    <span class="na">configMap</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">elasticsearch-master-ca-store</span>

<span class="na">extraVolumeMounts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">elasticsearch-master-ca-store</span>
    <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/ssl/certs/elasticsearch-master.pem</span>
    <span class="na">subPath</span><span class="pi">:</span> <span class="s">elasticsearch-master.pem</span>
    <span class="na">readOnly</span><span class="pi">:</span> <span class="kc">false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because Elasticsearch 8.5 supports only HTTPS, we need to provide the PEM file to Fluent-bit for TLS communication with Elasticsearch. We will mount the ConfigMap <code>elasticsearch-master-ca-store</code> to the path <code>/etc/ssl/certs/elasticsearch-master.pem</code> in the Fluent-bit container.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="priorityclass">priorityClass</h3>
<div class="paragraph">
<p>Fluent-bit si deployed as a DaemonSet to Kubernetes which means that it runs on all nodes in the cluster.</p>
</div>
<div class="paragraph">
<p>When deploying a DaemonSet to Kubernetes, you might face the issue of pods pending because of insufficient resources. In that case, you can set the <code>priorityClass</code> to the DaemonSet to give it a higher priority so that it can be scheduled to the nodes.</p>
</div>
<div class="paragraph">
<p>For more information, see the following link:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/" class="bare">https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is an example of how to see the priorityClass in Kubernetes:
.check the priorityClass</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl get priorityclass

NAME                      VALUE        GLOBAL-DEFAULT   AGE
addon-priority            999999       <span class="nb">false            </span>4y85d
high-priority             1000000      <span class="nb">false            </span>4y85d
system-cluster-critical   2000000000   <span class="nb">false            </span>4y85d
system-node-critical      2000001000   <span class="nb">false            </span>4y85d</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you don&#8217;t have a priorityClass in your Kubernetes cluster, you can create a priorityClass with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">

apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000000
globalDefault: false
description: "This priority class should be used for XYZ service pods only."

EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>fluentbit-values.yaml</code>, I have set the <code>priorityClassName</code> to <code>high-priority</code> to give the Fluent-bit DaemonSet a higher priority.</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - priorityClassName</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">priorityClassName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">high-priority"</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="config">config</h4>
<div class="paragraph">
<p>In the <code>fluentbit-values.yaml</code>, we will provide the configuration for Fluent-bit. We will configure the inputs, filters, and outputs for Fluent-bit.</p>
</div>
<div class="paragraph">
<p>config section consists of the following fields:</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">config</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span>

  <span class="na">inputs</span><span class="pi">:</span>

  <span class="na">filters</span><span class="pi">:</span>

  <span class="na">outputs</span><span class="pi">:</span>

  <span class="na">upstream</span><span class="pi">:</span>

  <span class="na">customParsers</span><span class="pi">:</span>

  <span class="na">extraFiles</span><span class="pi">:</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="service">service</h5>
<div class="paragraph">
<p>The <code>service</code> field is used to configure the Fluent-bit service. Some extra configuration files for parsers can be provided in the <code>Parsers_File</code> field.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml">  <span class="na">service</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[SERVICE]</span>
        <span class="s">Daemon Off</span>
        <span class="s">Flush {{ .Values.flush }}</span>
        <span class="s">Log_Level {{ .Values.logLevel }}</span>
        <span class="s">Parsers_File /fluent-bit/etc/parsers.conf</span>
        <span class="s">Parsers_File /fluent-bit/etc/conf/custom_parsers.conf</span>
        <span class="s">HTTP_Server On</span>
        <span class="s">HTTP_Listen 0.0.0.0</span>
        <span class="s">HTTP_Port {{ .Values.metricsPort }}</span>
        <span class="s">Health_Check On</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config - inputs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">config</span><span class="pi">:</span>
  <span class="na">inputs</span><span class="pi">:</span> <span class="pi">|</span>

    <span class="s">[INPUT]</span>
        <span class="s">Name tail</span>
        <span class="s">Path /var/log/containers/nsa2-*.log</span>
        <span class="s">Tag nsa2.*</span>
        <span class="s">Mem_Buf_Limit 32MB</span>
        <span class="s">multiline.parser              docker, cri</span>
        <span class="s">Path_Key            filePath</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All pods whose names start with <code>nsa2-</code> will have their logs collected by Fluent-bit. The logs will be collected from the files whose names start with <code>nsa2-</code> in the <code>/var/log/containers</code> directory. The <code>multiline.parser</code> is used to parse the multiline logs. The <code>filePath</code> field will be used as the log file path. The logs will be tagged with <code>nsa2.*</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="filters">filters</h5>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config - filters</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">config</span><span class="pi">:</span>
  <span class="na">filters</span><span class="pi">:</span> <span class="pi">|</span>

    <span class="s">[FILTER]</span>
        <span class="s">Name                    multiline</span>
        <span class="s">Match                   nsa2.*</span>
        <span class="s">multiline.parser        java, multiline-parser</span>
        <span class="s">multiline.key_content   log</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>multiline</code> filter is used to parse the multiline logs. The logs tagged with <code>nsa2.*</code> will be parsed using the <code>java</code> and <code>multiline-parser</code> parsers. The <code>log</code> field will be used as the log message.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
we are going to use a couple of more filters in the later sections to remove log message prefix created by Docker logging driver.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="outputs">outputs</h4>
<div class="paragraph">
<p>In the <code>fluentbit-values.yaml</code>, we will provide the configuration for the outputs. We will configure the output to forward the logs to Elasticsearch.</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config - outputs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">config</span><span class="pi">:</span>
  <span class="na">outputs</span><span class="pi">:</span> <span class="pi">|</span>

    <span class="s">[OUTPUT]</span>
        <span class="s">Name es</span>
        <span class="s">Match nsa2.*</span>
        <span class="s">Host elasticsearch-master</span>
        <span class="s">Logstash_Format On</span>
        <span class="s">Retry_Limit False</span>
        <span class="s">Logstash_Prefix      nsa2-</span>
        <span class="s">Trace_Output        On</span>
        <span class="s">Trace_Error         On</span>
        <span class="s">Replace_Dots        On</span>
        <span class="s">Buffer_Size         512M</span>
        <span class="s">HTTP_User           elastic</span>
        <span class="s">HTTP_Passwd         ${ELASTIC_PASSWORD}</span>
        <span class="s">Suppress_Type_Name  On</span>
        <span class="s">tls                 On</span>
        <span class="s">tls.verify          On</span>
        <span class="s">tls.ca_file          /etc/ssl/certs/elasticsearch-master.pem</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The logs tagged with <code>nsa2.*</code> will be forwarded to Elasticsearch. The logs will be sent to the <code>elasticsearch-master</code> service. The <code>Logstash_Format</code> is set to <code>On</code> to format the logs in Logstash format. The <code>HTTP_User</code> is set to <code>elastic</code> and the <code>HTTP_Passwd</code> is set to <code>${ELASTIC_PASSWORD}</code>. The <code>tls</code> is set to <code>On</code> to enable TLS communication with Elasticsearch. The <code>tls.ca_file</code> is set to <code>/etc/ssl/certs/elasticsearch-master.pem</code> to provide the PEM file for TLS communication.</p>
</div>
<div class="sect4">
<h5 id="customparsers">customParsers</h5>
<div class="paragraph">
<p>customParsers is used to provide custom parsers for Fluent-bit. We will provide the custom parsers for Fluent-bit to parse the log messages especially the multiline logs.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The regular expression used in this section is just an example to see how Fluent-bit parsers treat named captured group. We are going to use a different regular expression in the next section.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config - customParsers</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">config</span><span class="pi">:</span>
  <span class="na">customParsers</span><span class="pi">:</span> <span class="pi">|</span>

    <span class="s">[PARSER]</span>
        <span class="s">Name named-capture-test</span>
        <span class="s">Format regex</span>
        <span class="s">Regex (?&lt;timestamp&gt;[0-9\-]+T[:0-9\.]+\d{3}Z)\s+(?&lt;level&gt;[A-Z]+)\s+\d+\s\-{3}\s+\[(?&lt;appName&gt;[\w\-\d]+)\]+\s+\[.*\]+\s+[\w\d\.]*\.(?&lt;loggerClass&gt;[\w\.\d]+)\s+:(?&lt;message&gt;.*)</span>

    <span class="s">[MULTILINE_PARSER]</span>
        <span class="s">name              multiline-parser</span>
        <span class="s">type              regex</span>
        <span class="s">flush_timeout      1000</span>

        <span class="s"># rules |   state name  | regex pattern                    | next state</span>
        <span class="s"># ------|---------------|----------------------------------|-----------</span>
        <span class="s"># https://github.com/fluent/fluent-bit/discussions/5430</span>
        <span class="s">rule      "start_state" "/(?&lt;timestamp&gt;[0-9\-]+T[:0-9\.]+\d{3}Z)\s+(?&lt;level&gt;[A-Z]+)\s+\d+\s\-{3}\s+\[(?&lt;appName&gt;[\w\-\d]+)\]+\s+\[.*\]+\s+[\w\d\.]*\.(?&lt;loggerClass&gt;[\w\.\d]+)\s+:(?&lt;message&gt;.*)/"  "cont"</span>
        <span class="s">rule      "cont"        "/^(?:\s+at\s.*)|(?:[\w$_][\w\d.$:]*.*)$/"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>named-capture-test</code> parser will parse the log message using the regular expression. The <code>multiline-parser</code> will be used to parse the multiline logs. In Java applications, the stack trace log message might be multiline. The <code>flush_timeout</code> is set to <code>1000</code> to flush the multiline logs after 1 second.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I have configured for level, appName, loggerClass, and message fields for this example. But the pattern of the regular expression is simpler than the previous one. Because Fluent-bit sends a record in a chunk to Elasticsearch when the multiline.parser is configured. So those fields in a record will not be useful for each log message.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multiline-parser">Multiline parser</h4>
<div class="paragraph">
<p>Here are some resources to understand the multiline parser in Fluent-bit:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/multiline-parsing" class="bare">https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/multiline-parsing</a>
<a href="https://docs.fluentbit.io/manual/pipeline/filters/multiline-stacktrace" class="bare">https://docs.fluentbit.io/manual/pipeline/filters/multiline-stacktrace</a></p>
</li>
<li>
<p><a href="https://docs.fluentbit.io/manual/pipeline/parsers/regular-expression" class="bare">https://docs.fluentbit.io/manual/pipeline/parsers/regular-expression</a></p>
</li>
<li>
<p><a href="https://docs.fluentbit.io/manual/pipeline/inputs/tail" class="bare">https://docs.fluentbit.io/manual/pipeline/inputs/tail</a></p>
</li>
<li>
<p><a href="https://www.couchbase.com/blog/fluent-bit-tips-tricks-log-forwarding-couchbase/" class="bare">https://www.couchbase.com/blog/fluent-bit-tips-tricks-log-forwarding-couchbase/</a></p>
</li>
<li>
<p><a href="https://github.com/fluent/fluent-bit/issues/5504" class="bare">https://github.com/fluent/fluent-bit/issues/5504</a></p>
</li>
<li>
<p><a href="https://github.com/fluent/fluent-bit/discussions/5430" class="bare">https://github.com/fluent/fluent-bit/discussions/5430</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In Java applications, multiline logs are common. For example, stack trace log messages are multiline. We need to parse the multiline logs to get useful information from the logs.</p>
</div>
<div class="paragraph">
<p>Here is an example of a multiline log message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">2024-05-28T00:47:38.982Z ERROR 1 --- [nsa2-logging-example]
[or-http-epoll-2] c.a.n.e.l.c.LoggingExampleController     :
=====&gt; onErrorResume: No enum constant org.slf4j.event.Level.INVALID

java.lang.IllegalArgumentException: No enum constant org.slf4j.event.Level.INVALID
	at java.base/java.lang.Enum.valueOf(Unknown Source) ~[na:na]
	at org.slf4j.event.Level.valueOf(Level.java:16)
~[slf4j-api-2.0.13.jar!/:2.0.13]
	at com.alexamy.nsa2.example.logging.service
.LoggingExampleService.lambda$writeLog$0(LoggingExampleService.java:23)
~[!/:0.0.1-SNAPSHOT]
	at reactor.core.publisher.MonoSupplier$MonoSupplierSubscription.request(MonoSupplier.java:126)
~[reactor-core-3.6.5.jar!/:3.6.5]

... omitted for brevity

	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
~[netty-common-4.1.109.Final.jar!/:4.1.109.Final]
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
~[netty-common-4.1.109.Final.jar!/:4.1.109.Final]
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
~[netty-common-4.1.109.Final.jar!/:4.1.109.Final]
	at java.base/java.lang.Thread.run(Unknown Source) ~[na:na]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line of the log message has the same format as the simple log message. The stack trace is multiline and starts with the <code>java.lang.IllegalArgumentException</code> line. The <code>multiline-parser</code> will parse these types of multiline logs.
The final version of the regular expression for the multiline parser will be provided alter in this tutorial after applying a few filters to remove the log message prefix created by Docker logging driver.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="install-fluent-bit-using-helm-on-kubernetes">Install Fluent-bit using Helm on Kubernetes</h3>
<div class="paragraph">
<p>Now we are ready to install Fluent-bit to Kubernetes using Helm.
The following command will install Fluent-bit to the <code>logging</code> namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>helm <span class="nt">-n</span> logging <span class="nb">install </span>fluent-bit fluent/fluent-bit <span class="nt">-f</span> fluentbit-opensearch-values.yaml</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="internal-purpose">Internal purpose.</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>helm <span class="nt">-n</span> logging <span class="nb">install </span>fluent-bit fluent/fluent-bit <span class="se">\</span>
  <span class="nt">-f</span> fluentbit-opensearch-values.yaml <span class="nt">--set</span> nodeSelector.agentpool<span class="o">=</span>depnodes</code></pre>
</div>
</div>
<div class="paragraph">
<p>I added <code>nodeSelector.agentpool=depnodes</code> to the Helm command to deploy Fluent-bit to the node pool named <code>depnodes</code>. You can remove this option if you do not have a node pool named <code>depnodes</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="install-fluent-bit-using-helm-on-minikube">Install Fluent-bit using Helm on Minikube</h4>
<div class="paragraph">
<p>WIP. I will provide the values for Minikube in the next update.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>helm <span class="nb">install </span>fluent-bit fluent/fluent-bit <span class="nt">-n</span> logging <span class="nt">-f</span> fluentbit-opensearch-values.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="uninstall-fluent-bit">Uninstall Fluent-bit</h4>
<div class="paragraph">
<p>To uninstall Fluent-bit, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>helm uninstall fluent-bit <span class="nt">-n</span> logging</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="collecting-logs-from-the-spring-boot-application">Collecting logs from the Spring Boot application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we collect logs from the Spring Boot application, we need to deploy the Spring Boot application to Kubernetes. We will use the same Spring Boot application that we deployed in Part 2 of the series.</p>
</div>
<div class="paragraph">
<p>We can use the Helm chart that we created in Part 2 to deploy the Spring Boot application to Kubernetes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl create namespace nsa2
<span class="nv">$ </span>helm <span class="nb">install </span>nsa2-logging-example src/main/helm/nsa2-logging-example <span class="nt">-n</span> nsa2 <span class="nt">--set</span> <span class="nv">replicaCount</span><span class="o">=</span>3

<span class="nv">$ </span>kubectl <span class="nt">-n</span> nsa2 port-forward svc/nsa2-logging-example 18080:8080</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="elasticsearch-index">Elasticsearch index</h3>
<div class="paragraph">
<p>When Fluent-bit forwards the logs to Elasticsearch, it will create an index with the name <code>nsa2-{date-string}</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="elasticsearch-documents-sent-by-fluent-bit">Elasticsearch documents sent by Fluent-bit</h3>
<div class="paragraph">
<p>When Fluent-bit collects logs from the Spring Boot application, it will send the logs to Elasticsearch. The logs will be sent as documents to Elasticsearch.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please remember that multiline parser is used to parse the log messages. So the log message will be chunked and sent to Elasticsearch. The fields in a record will not be useful for each log message.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="document-with-a-simple-log-message">Document with a simple log message</h4>
<div class="paragraph">
<p>Let&#8217;s begin by looking at a document with a simple log message:</p>
</div>
<div class="paragraph">
<p>To write a log message in the Spring Boot application, we can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'This is an WARN log message'</span> http://localhost:18080/v1.0.0/log/WARN</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"@timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T21:48:27.821Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T21:51:13.819Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WARN"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"appName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-logging-example"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"loggerClass"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LoggingExampleService"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">" Writing log - level: WARN, message: This is an WARN log message</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"log"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T21:51:13.819968386Z stdout F 2024-06-06T21:51:13.819Z WARN 1 --- [nsa2-logging-example] [or-http-epoll-2] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: WARN, message: This is an WARN log message</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/containers/nsa2-logging-example-5c8c465555-lhcss_nsa2_nsa2-logging-example-adc9cb921fb8ae407971d03326a153ada850e6c64a1175a8f6796766035dde97.log"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="document-with-chunked-log-message">Document with chunked log message</h4>
<div class="paragraph">
<p>To simulate a chunked log message, we can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"INFO WARN"</span> | <span class="nb">tr</span> <span class="s2">" "</span> <span class="s1">'\n'</span> <span class="se">\</span>
  | xargs <span class="nt">-I</span> <span class="o">{}</span> curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s2">"This is a sample of {} level messages"</span> <span class="se">\</span>
  http://localhost:18080/v1.0.0/log/<span class="o">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Two log messages with different level will be written to the log file. The log messages will be chunked and sent to Elasticsearch.</p>
</div>
<div class="paragraph">
<p>Here is an example of a document with a chunked log message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"@timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T21:48:27.821Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T21:55:29.119Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"INFO"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"appName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-logging-example"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"loggerClass"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LoggingExampleService"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">" Writing log - level: WARN, message: This is a sample of WARN level messages</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"log"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T21:55:29.119686381Z stdout F 2024-06-06T21:55:29.119Z INFO 1 --- [nsa2-logging-example] [or-http-epoll-3] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: INFO, message: This is a sample of INFO level messages</span><span class="se">\n</span><span class="s2"> 2024-06-06T21:55:29.395604417Z stdout F 2024-06-06T21:55:29.395Z WARN 1 --- [nsa2-logging-example] [or-http-epoll-4] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: WARN, message: This is a sample of WARN level messages</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/containers/nsa2-logging-example-5c8c465555-lhcss_nsa2_nsa2-logging -example-adc9cb921fb8ae407971d03326a153ada850e6c64a1175a8f6796766035dde97.log"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, named capturing groups are not appropriate for chunked log messages. For example, The value of the level field is INFO, but the log message contains both INFO and WARN level messages. The message field contains the log message, but it is not useful for chunked log messages.
These fine-grained fields are useful for simple log messages when we are not using the multiline parser like when parsing webserver logs. But conventionally Java applications have stack trace log messages that are multiline. So we do not need to use these fields for chunked log messages.</p>
</div>
<div class="paragraph">
<p>Here is the pattern of the regular expression that I used to parse the log message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="regexp">(?&lt;timestamp&gt;[0-9\-]+T[:0-9\.]+\d{3}Z)\s+(?&lt;message&gt;.*)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern will extract only the timestamp and message fields from the log message.</p>
</div>
<div class="paragraph">
<p>Once you update the Fluent-bit configuration with the new regular expression, you will see the following document in Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"@timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T22:07:27.554Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T22:07:27.554214387Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stdout F 2024-06-06T22:07:27.553Z INFO 1 --- [nsa2-logging-example] [or-http-epoll-4] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: INFO, message: This is a sample of INFO level messages</span><span class="se">\n</span><span class="s2"> 2024-06-06T22:07:27.780009745Z stdout F 2024-06-06T22:07:27.779Z WARN 1 --- [nsa2-logging-example] [or-http-epoll-1] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: WARN, message: This is a sample of WARN level messages"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"log"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T22:07:27.554214387Z stdout F 2024-06-06T22:07:27.553Z INFO 1 --- [nsa2-logging-example] [or-http-epoll-4] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: INFO, message: This is a sample of INFO level messages</span><span class="se">\n</span><span class="s2"> 2024-06-06T22:07:27.780009745Z stdout F 2024-06-06T22:07:27.779Z WARN 1 --- [nsa2-logging-example] [or-http-epoll-1] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: WARN, message: This is a sample of WARN level messages"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/containers/nsa2-logging-example-5c8c465555-lhcss_nsa2_nsa2-logging-example -adc9cb921fb8ae407971d03326a153ada850e6c64a1175a8f6796766035dde97.log"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Still, the log message looks redundant. We can remove the timestamp field from the document because the timestamp field is already in the @timestamp field. And message field is quite similar to the log field. So we can remove the message field from the document.</p>
</div>
<div class="paragraph">
<p>The updated regular expression is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="regexp">([0-9\-]+T[:0-9\.]+\d{3}Z)\s+(.*)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can notice that there is no named capturing group in the regular expression any longer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"@timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T22:17:47.503Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"log"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T22:17:47.503239291Z stdout F 2024-06-06T22:17:47.502Z INFO 1 --- [nsa2-logging-example] [or-http-epoll-4] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: INFO, message: This is a sample of INFO level messages</span><span class="se">\n</span><span class="s2"> 2024-06-06T22:17:48.010204823Z stdout F 2024-06-06T22:17:48.009Z WARN 1 --- [nsa2-logging-example] [or-http-epoll-1] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: WARN, message: This is a sample of WARN level messages</span><span class="se">\n</span><span class="s2"> 2024-06-06T22:17:48.231040111Z stdout F 2024-06-06T22:17:48.229Z ERROR 1 --- [nsa2-logging-example] [or-http-epoll-2] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: ERROR, message: This is a sample of ERROR level messages</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w"> </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/containers/nsa2-logging-example-5c8c465555-lhcss_nsa2_nsa2-logging -example-adc9cb921fb8ae407971d03326a153ada850e6c64a1175a8f6796766035dde97.log"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may notice that there is additional information before the log messages. They look like this:
`2024-06-06T22:17:47.503239291Z stdout F `. This is added by the Docker logging driver. I do not want to include this information in the log message. I want to keep the log message as it is logged by the application.</p>
</div>
<div class="paragraph">
<p>To remove the additional part from the log message, we can use the <code>Kubernetes Filter</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="kubernetes-filter">Kubernetes Filter</h4>
<div class="paragraph">
<p>Fluent Bit Kubernetes Filter allows to enrich your log files with Kubernetes metadata.</p>
</div>
<div class="paragraph">
<p>For more information about the Kubernetes Filter, see the following link:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.fluentbit.io/manual/pipeline/filters/kubernetes" class="bare">https://docs.fluentbit.io/manual/pipeline/filters/kubernetes</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config - filter</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml">  <span class="na">filters</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[FILTER]</span>
        <span class="s">Name kubernetes</span>
        <span class="s">Match nsa2.*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just by adding the Kubernetes Filter with default configurations, the log message will be enriched with Kubernetes metadata.
When the filter is applied, the log message will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"@timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T23:26:04.692Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T23:26:04.692181582Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"stream"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stdout"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_p"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"log"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-06T23:26:04.691Z WARN 1 --- [nsa2-logging-example] [or-http-epoll-1] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: WARN, message: This is an WARN log message"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"kubernetes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"pod_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-logging-example-5c8c465555-lhcss"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"namespace_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pod_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"74fa83de-8e90-40c9-be0a-c2690f79549f"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"app_kubernetes_io/instance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-logging-example"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"app_kubernetes_io/managed-by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Helm"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"app_kubernetes_io/name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-logging-example"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"app_kubernetes_io/version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.16.0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"helm_sh/chart"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-logging-example-0.1.0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pod-template-hash"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5c8c465555"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aks-depnodes-90256095-vmss000001"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"container_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nsa2-logging-example"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"docker_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"adc9cb921fb8ae407971d03326a153ada850e6c64a1175a8f6796766035dde97"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"container_hash"</span><span class="p">:</span><span class="w"> </span><span class="s2">"docker.io/credemol/nsa2-logging-example@sha256: b6552a4f1253b118b7deda59a4a0cfd7c2896670f225513beebdaee96ae0dd41"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"container_image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"docker.io/credemol/nsa2-logging-example:latest"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two significant changes in the log message:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The log message is enriched with Kubernetes metadata. The <code>kubernetes</code> field contains the pod name, namespace name, pod ID, labels, host, container name, Docker ID, container hash, and container image.</p>
</li>
<li>
<p>The log message contains additional fields like <code>time</code>, <code>stream</code>, and <code>_p</code>. These fields are added by the Docker logging driver. And log field does not contain the additional information that is added by the Docker logging driver.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And we can also remove some of the fields that are not useful for us. For example, we can remove the <code>time</code>, <code>stream</code>, <code>_p</code> and <code>kubernetes</code> field from the document.</p>
</div>
<div class="sect4">
<h5 id="record-modifier-filter">Record Modifier Filter</h5>
<div class="paragraph">
<p>For more information about the Record Modifier Filter, see the following link:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.fluentbit.io/manual/pipeline/filters/record-modifier" class="bare">https://docs.fluentbit.io/manual/pipeline/filters/record-modifier</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example of how to remove the <code>time</code>, <code>stream</code>, <code>_p</code>, and <code>kubernetes</code> fields from the document:</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config - filter</div>
<div class="content">
<pre>    [FILTER]
        Name record_modifier
        Match nsa2.*
        Remove_key time
        Remove_key stream
        Remove_key _p
        Remove_key kubernetes</pre>
</div>
</div>
<div class="paragraph">
<p>In this tutorial, I have removed the <code>time</code>, <code>stream</code>, <code>_p</code>, and <code>kubernetes</code> fields from the document. If needed, you can keep the <code>kubernetes</code> field in the document which contains some useful information about the pod.</p>
</div>
<div class="paragraph">
<p>This is the final format of the document that will be indexed in Elasticsearch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"@timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-07T00:34:59.336Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"log"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-07T00:34:59.336Z  WARN 1 --- [nsa2-logging-example] [or-http-epoll-1] c.a.n.e.l.service.LoggingExampleService  : Writing log - level: WARN, message: This is an WARN log message"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="updated-parser-configuration-for-fluent-bit">Updated Parser configuration for Fluent-bit</h4>
<div class="paragraph">
<p>The error message can be simply illustrated as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>&lt;timestamp&gt; &lt;level&gt; &lt;PID&gt; --- [&lt;appName&gt;] [&lt;thread&gt;] &lt;loggerClass&gt; : &lt;message&gt;</p>
</li>
<li>
<p>empty line</p>
</li>
<li>
<p>java class name and error message</p>
</li>
<li>
<p>stack trace lines starting with at with spaces</p>
</li>
<li>
<p>empty line</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The rules for the multiline parser are start_state, empty_row, cont. The <code>start_state</code> rule will match the first line of the log message. The <code>empty_row</code> rule will match the empty line. The <code>cont</code> rule will match the lines that start with a java class name, stack trace lines, or an empty line.</p>
</div>
<div class="paragraph">
<p>Here is the updated multiline parser configuration:</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config - customParsers</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml">    <span class="pi">[</span><span class="nv">MULTILINE_PARSER</span><span class="pi">]</span>
        <span class="s">name              multiline-parser</span>
        <span class="s">type              regex</span>
        <span class="s">flush_timeout      </span><span class="m">1000</span>
        <span class="s">Skip_Empty_Lines  Off</span>

        <span class="s"># rules |   state name  | regex pattern                    | next state</span>
        <span class="s"># ------|---------------|----------------------------------|-----------</span>
        <span class="s">rule      "start_state"      "/([\d-]+T[\d:.]+)Z ([\s\S]*)/m"  "empty_row"</span>
        <span class="s">rule      "empty_row"        "/^$/m"                                    "cont"</span>
        <span class="s"># start with at java class or start with java class name or empty line</span>
        <span class="s">rule      "cont"</span>
<span class="s2">"</span><span class="s">/(?:</span><span class="err">\</span><span class="s">s+at</span><span class="err">\</span><span class="s">s.*)|^(?:[a-zA-Z_$][a-zA-Z</span><span class="err">\</span><span class="s">d_$]*(</span><span class="err">\</span><span class="s">.[a-zA-Z_$][a-zA-Z</span><span class="err">\</span><span class="s">d_$]*)*)|^</span><span class="err">\</span><span class="s">s*$/m"</span>
<span class="s2">"</span><span class="s">cont"</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="updated-config-for-fluent-bit">Updated config for Fluent-bit</h4>
<div class="paragraph">
<p>Here is the updated config for Fluent-bit:</p>
</div>
<div class="listingblock">
<div class="title">fluentbit-values.yaml - config</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">config</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[SERVICE]</span>
        <span class="s">Daemon Off</span>
        <span class="s">Flush {{ .Values.flush }}</span>
        <span class="s">Log_Level {{ .Values.logLevel }}</span>
        <span class="s">Parsers_File /fluent-bit/etc/parsers.conf</span>
        <span class="s">Parsers_File /fluent-bit/etc/conf/custom_parsers.conf</span>
        <span class="s">HTTP_Server On</span>
        <span class="s">HTTP_Listen 0.0.0.0</span>
        <span class="s">HTTP_Port {{ .Values.metricsPort }}</span>
        <span class="s">Health_Check On</span>

  <span class="c1">## https://docs.fluentbit.io/manual/pipeline/inputs</span>
  <span class="na">inputs</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[INPUT]</span>
        <span class="s">Name tail</span>
        <span class="s">Path /var/log/containers/nsa2-*.log</span>
        <span class="s">Tag nsa2.*</span>
        <span class="s">Mem_Buf_Limit 32MB</span>
        <span class="s">multiline.parser             cri</span>
        <span class="s">Skip_Empty_Lines              On</span>

  <span class="c1">## https://docs.fluentbit.io/manual/pipeline/filters</span>
  <span class="na">filters</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[FILTER]</span>
        <span class="s">Name kubernetes</span>
        <span class="s">Match nsa2.*</span>
        <span class="s">Labels Off</span>
        <span class="s">Annotations Off</span>

    <span class="s">[FILTER]</span>
        <span class="s">Name record_modifier</span>
        <span class="s">Match nsa2.*</span>
        <span class="s">Remove_key time</span>
        <span class="s">Remove_key stream</span>
        <span class="s">Remove_key _p</span>
        <span class="s">Remove_key kubernetes</span>

    <span class="s">[FILTER]</span>
        <span class="s">Name                    multiline</span>
        <span class="s">Match                   nsa2.*</span>
        <span class="s">multiline.parser        multiline-parser</span>
        <span class="s">multiline.key_content   log</span>

    <span class="s">[FILTER]</span>
        <span class="s">Name              parser</span>
        <span class="s">Match             nsa2.*</span>
        <span class="s">Key_Name          log</span>
        <span class="s">Parser            named-capture-test</span>
        <span class="s">Preserve_Key      true</span>
        <span class="s">Reserve_Data      true</span>

  <span class="c1">## https://docs.fluentbit.io/manual/pipeline/outputs</span>
  <span class="na">outputs</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[OUTPUT]</span>
        <span class="s">Name es</span>
        <span class="s">Match nsa2.*</span>
        <span class="s">Host elasticsearch-master</span>
        <span class="s">Logstash_Format On</span>
        <span class="s">Retry_Limit False</span>
        <span class="s">Logstash_Prefix      nsa2</span>
        <span class="s">Trace_Output        On</span>
        <span class="s">Trace_Error         On</span>
        <span class="s">Replace_Dots        On</span>
        <span class="s">Buffer_Size         512M</span>
        <span class="s">HTTP_User           elastic</span>
        <span class="s">HTTP_Passwd         ${ELASTIC_PASSWORD}</span>
        <span class="s">Suppress_Type_Name  On</span>
        <span class="s">tls                 On</span>
        <span class="s">tls.verify          On</span>
        <span class="s">tls.ca_file          /etc/ssl/certs/elasticsearch-master.pem</span>

  <span class="na">upstream</span><span class="pi">:</span> <span class="pi">{}</span>

  <span class="c1">## https://docs.fluentbit.io/manual/pipeline/parsers</span>
  <span class="na">customParsers</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[PARSER]</span>
        <span class="s">Name          docker_no_time</span>
        <span class="s">Format        json</span>
        <span class="s">Time_Keep     Off</span>
        <span class="s">Time_Key      time</span>
        <span class="s">Time_Format   %Y-%m-%dT%H:%M:%S.%L</span>

    <span class="s">[MULTILINE_PARSER]</span>
        <span class="s">name              multiline-parser</span>
        <span class="s">type              regex</span>
        <span class="s">flush_timeout      1000</span>
        <span class="s">Skip_Empty_Lines  Off</span>

        <span class="s"># rules |   state name  | regex pattern                    | next state</span>
        <span class="s"># ------|---------------|----------------------------------|-----------</span>
        <span class="s">rule      "start_state"      "/([\d-]+T[\d:.]+)Z ([\s\S]*)/m"  "empty_row"</span>
        <span class="s">rule      "empty_row"        "/^$/m"                                    "cont"</span>
        <span class="s"># start with at java class or start with java class name or empty line</span>
        <span class="s">rule      "cont" "/(?:\s+at\s.*)|^(?:[a-zA-Z_$][a-zA-Z\d_$]*(\.[a-zA-Z_$][a-zA-Z\d_$]*)*)|^\s*$/m" "cont"</span>


    <span class="s">[PARSER]</span>
        <span class="s">Name named-capture-test</span>
        <span class="s">Format regex</span>
        <span class="s">Skip_Empty_Values On</span>
        <span class="s"># simplified version</span>
        <span class="s">Regex /([0-9\-]+T[:0-9\.]+\d{3}Z)\s+(.*)/m</span>

  <span class="na">extraFiles</span><span class="pi">:</span> <span class="pi">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The full <code>fluentbit-values.yaml</code> can be found in the following link:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/nsalexamy/nsa2-logging-example/blob/main/src/main/k8s/helm-values/fluentbit-values.yaml">fluentbit-values.yaml</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-script">Test script</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="generate-logs-from-the-spring-boot-application">Generate logs from the Spring Boot application</h3>
<div class="paragraph">
<p>To generate 100 logs from the Spring Boot application, we can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl <span class="nt">-n</span> nsa2 port-forward svc/nsa2-logging-example 18080:8080

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span>  <span class="se">\</span>
  curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s2">"This is an INFO log message - </span><span class="nv">$i</span><span class="s2">"</span> <span class="se">\</span>
  http://localhost:18080/v1.0.0/log/INFO<span class="p">;</span> <span class="k">done</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generate-logs-with-different-log-levels">Generate logs with different log levels</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">echo</span> <span class="s2">"TRACE DEBUG INFO WARN ERROR"</span> | <span class="se">\</span>
  <span class="nb">tr</span> <span class="s2">" "</span> <span class="s1">'\n'</span> | <span class="se">\</span>
  xargs <span class="nt">-I</span> <span class="o">{}</span> curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s2">"This is a sample of {} level messages"</span> <span class="se">\</span>
  http://localhost:18080/v1.0.0/log/<span class="o">{}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="generate-a-stack-trace-log-message">Generate a stack trace log message</h4>
<div class="paragraph">
<p>To generate a stack trace log message from the Spring Boot application, we can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>for i in {1..10}; do \
    curl -X POST -H "Content-Type: application/json" \
    -d "This is n invalid log message - $i" \
    http://localhost:18080/v1.0.0/log/INVALID; done</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="view-logs-in-kibana">View logs in Kibana</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To view the logs in Kibana, we need to port-forward the Kibana service to our local machine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl port-forward svc/kibana-kibana 5601:5601 <span class="nt">-n</span> logging</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to <code><a href="http://localhost:5601" class="bare">http://localhost:5601</a></code> in your browser and go to the <code>Discover</code> tab in Kibana. You should see the logs from the Spring Boot application.</p>
</div>
<div class="sect2">
<h3 id="create-a-new-data-view">Create a new Data View</h3>
<div class="paragraph">
<p>To create a new Data View in Kibana, follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to the <code>Discover</code> tab in Kibana.</p>
</li>
<li>
<p>Click on the <code>Create a Data View</code> button.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/kibana-nsa2-log-0.png" alt="kibana nsa2 log 0" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Enter <code>nsa2-logs</code> for Name and Select the index pattern <code>nsa2-*</code>.</p>
</li>
<li>
<p>Click on the <code>Save data view to Kibana</code> button.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/kibana-nsa2-log-1.png" alt="kibana nsa2 log 1" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Search for the logs in the <code>nsa2-logs</code> Data View.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/kibana-nsa2-log-3.png" alt="kibana nsa2 log 3" width="1000">
</div>
</div>
<div class="paragraph">
<p>I entered log: error and log: <strong>LoggingExampleController</strong> in KQL text field to filter the logs. It filters the logs that contain the word <code>error</code> in the log message and the logs that contain the word <code>LoggingExampleController</code> in the log message.
You can use different filters to search for logs in the Data View.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial, we have learned how to collect logs from a Spring Boot application running in Kubernetes using Fluent-bit. We have configured Fluent-bit to parse the log messages and send them to Elasticsearch. We have also enriched the log messages with Kubernetes metadata using the Kubernetes Filter.</p>
</div>
</div>
</div>
        </div>
    </main>
</div>




<script>
    const toc = document.getElementById('toc');
    const container = document.getElementById('toc-container');
    if (toc && container) {
        container.appendChild(toc);
    }
</script>


<!--<button onclick="toggleTheme()" style="position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; background-color: var(&#45;&#45;link); color: white; border: none; border-radius: 0.375rem; cursor: pointer;">-->
<!--    Toggle Theme-->
<!--</button>-->

<!--<script>-->
<!--    function toggleTheme() {-->
<!--        const html = document.documentElement;-->
<!--        const isDark = html.getAttribute("data-theme") === "dark";-->
<!--        html.setAttribute("data-theme", isDark ? "light" : "dark");-->
<!--        localStorage.setItem("theme", isDark ? "light" : "dark");-->
<!--    }-->

<!--    document.addEventListener("DOMContentLoaded", () => {-->
<!--        const savedTheme = localStorage.getItem("theme") || "light";-->
<!--        document.documentElement.setAttribute("data-theme", savedTheme);-->
<!--    });-->
<!--</script>-->

<!-- Footer -->
<footer class="bg-gray-900 text-white text-sm py-6 text-center">
     2025 Service Foundry. All rights reserved.
</footer>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>End to End Observability for Go Applications with Otel eBPF Instrumentation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
            margin: 0;
            padding: 0;
        }
    </style>
    
</head>
<body>
<div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#key-components">Key Components</a></li>
</ul>
</li>
<li><a href="#what-is-ebpf">What is eBPF?</a></li>
<li><a href="#what-is-opentelemetry-ebpf-instrumentation">What is OpenTelemetry eBPF Instrumentation?</a></li>
<li><a href="#what-is-fluent-bit">What is Fluent Bit?</a></li>
<li><a href="#enabling-obi-using-service-foundry-console">Enabling OBI using Service Foundry Console</a></li>
<li><a href="#enabling-obi-manually">Enabling OBI manually</a>
<ul class="sectlevel2">
<li><a href="#otel-ebpf-instrumentation-daemonset">OTel eBPF Instrumentation DaemonSet</a></li>
<li><a href="#fluent-bit-daemonset">Fluent Bit DaemonSet</a></li>
</ul>
</li>
<li><a href="#writing-logs-in-go-applications">Writing Logs in Go Applications</a>
<ul class="sectlevel2">
<li><a href="#middleware-go">middleware.go</a></li>
<li><a href="#logger-go">logger.go</a></li>
<li><a href="#writing-logs-in-handlers">Writing Logs in Handlers</a></li>
</ul>
</li>
<li><a href="#traefik-configuration-for-trace-context-propagation">Traefik Configuration for Trace Context Propagation</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="imageblock img-wide">
<div class="content">
<img src="./images/end-to-end-obi.png" alt="end to end obi">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide provides a comprehensive walkthrough for setting up end-to-end observability for Go applications using OpenTelemetry (Otel) eBPF instrumentation. By following this guide, you will learn how to instrument your Go applications, collect telemetry data, and visualize it using popular observability tools. Traces and Metrics will be collected using Otel eBPF instrumentation, while logs will be collected using Fluent Bit and correlated with traces.</p>
</div>
<div class="paragraph">
<p>At the end of this guide, you will have a fully functional observability stack like the one shown below:</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="./images/grafana-trace.png" alt="grafana trace">
</div>
<div class="title">Figure 1. End-to-End Observability Stack - Traces</div>
</div>
<div class="paragraph">
<p>The screen above shows traces collected from a sample Go application using Otel eBPF instrumentation. It includes spans from HTTP requests, database queries, and other operations, all visualized in Grafana.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="./images/grafana-trace-and-log.png" alt="grafana trace and log">
</div>
<div class="title">Figure 2. End-to-End Observability Stack - Logs correlated with Traces</div>
</div>
<div class="paragraph">
<p>If clicking 'Logs for this span' in the trace view, you can see the logs correlated with the selected trace span. This correlation helps in diagnosing issues by providing context around specific operations.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="./images/grafana-metrics.png" alt="grafana metrics">
</div>
<div class="title">Figure 3. End-to-End Observability Stack - Metrics</div>
</div>
<div class="paragraph">
<p>The metrics dashboard displays various performance metrics such as request latency, error rates, and system resource usage, providing insights into the health and performance of your Go applications.</p>
</div>
<div class="sect2">
<h3 id="key-components">Key Components</h3>
<div class="paragraph">
<p>The following key components are used in this end-to-end observability setup:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenTelemetry Collector: A vendor-agnostic agent that collects, processes, and exports telemetry data.</p>
</li>
<li>
<p>Otel eBPF Instrumentation: A method to collect low-level system metrics and traces using extended</p>
</li>
<li>
<p>Otel Go SDK: The official OpenTelemetry SDK for Go applications to write logs.</p>
</li>
<li>
<p>Traefik: A modern HTTP reverse proxy and load balancer that is used to generate trace headers for incoming requests.</p>
</li>
<li>
<p>Fluent Bit: A lightweight log processor and forwarder that collects and ships logs to Otel Collector.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-ebpf">What is eBPF?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>eBPF (extended Berkeley Packet Filter) is a powerful technology that allows you to run sandboxed programs in the Linux kernel without changing kernel source code or loading kernel modules. It provides a way to safely and efficiently extend the capabilities of the kernel, enabling advanced networking, security, and observability features.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-opentelemetry-ebpf-instrumentation">What is OpenTelemetry eBPF Instrumentation?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OpenTelemetry eBPF instrumentation leverages eBPF technology to collect telemetry data (traces, metrics, and logs) from applications and the underlying system. It allows for deep visibility into application performance and behavior by capturing low-level events and interactions.
This instrumentation is particularly useful for monitoring applications in dynamic and distributed environments, such as Kubernetes, where traditional instrumentation methods may fall short.</p>
</div>
<div class="paragraph">
<p>In this guide, we will deploy the OpenTelemetry eBPF instrumentation as a DaemonSet in a Kubernetes cluster to collect telemetry data from all nodes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-fluent-bit">What is Fluent Bit?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since eBPF instrumentation does not collect application logs, we will use Fluent Bit to collect and forward logs to the OpenTelemetry Collector. Fluent Bit is a lightweight and efficient log processor and forwarder that can be easily deployed in Kubernetes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-obi-using-service-foundry-console">Enabling OBI using Service Foundry Console</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On Service Foundry Console Dashboard, there is an "<strong>Enable OBI</strong>" button. This button is available after the Observability Stack is enabled.</p>
</div>
<div class="paragraph">
<p>Clicking this button will deploy Otel eBPF Instrumentation and Fluent Bit as a DaemonSet in your Kubernetes cluster.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="./images/sf-console-enable-obi.png" alt="sf console enable obi">
</div>
<div class="title">Figure 4. Service Foundry Console - Enable OBI</div>
</div>
<div class="paragraph">
<p>If you want to clean up the resources created by this guide, you can click the "Disable OBI" button.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="./images/sf-console-disable-obi.png" alt="sf console disable obi">
</div>
<div class="title">Figure 5. Service Foundry Console - Disable OBI</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-obi-manually">Enabling OBI manually</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are not using Service Foundry, you can manually deploy the Otel eBPF Instrumentation and Fluent Bit DaemonSets using the provided YAML files.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kustomize app for OBI DaemonSet:</p>
</li>
<li>
<p>Helm chart for Fluent Bit DaemonSet:</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="otel-ebpf-instrumentation-daemonset">OTel eBPF Instrumentation DaemonSet</h3>
<div class="paragraph">
<p>These files are generated and deployed as a ArgoCD application when you click the "Enable OBI" button.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>kustomization.yaml</p>
</li>
<li>
<p>obi-rbac.yaml</p>
</li>
<li>
<p>obi-configmap.yaml</p>
</li>
<li>
<p>obi-daemonset.yaml</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="kustomization-yaml">kustomization.yaml</h4>
<div class="paragraph">
<p>Like other ArgoCD applications in Service Foundry, a kustomization.yaml file is used to manage the resources for the OBI DaemonSet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">namespace</span><span class="pi">:</span> <span class="s">o11y</span>

<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">obi-rbac.yaml</span>
  <span class="pi">-</span> <span class="s">obi-configmap.yaml</span>
  <span class="pi">-</span> <span class="s">obi-daemonset.yaml</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="obi-rbac-yaml">obi-rbac.yaml</h4>
<div class="paragraph">
<p>Create a ServiceAccount, ClusterRole, and ClusterRoleBinding for the OBI DaemonSet.</p>
</div>
<div class="paragraph">
<p>For more information about the required permissions, refer to the official documentation:</p>
</div>
<div class="paragraph">
<p><a href="https://opentelemetry.io/docs/zero-code/obi/setup/kubernetes/" class="bare">https://opentelemetry.io/docs/zero-code/obi/setup/kubernetes/</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">obi</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">o11y</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">obi</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">apps'</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">replicasets'</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">list'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">watch'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">'</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">pods'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">services'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">nodes'</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">list'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">watch'</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">obi</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">obi</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">o11y</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">obi</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="obi-configmap-yaml">obi-configmap.yaml</h4>
<div class="paragraph">
<p>The obi-configmap.yaml file contains the configuration for the OBI DaemonSet.</p>
</div>
<div class="paragraph">
<p>In the discovery section, we specify that we want to instrument pods in the service-foundry namespace with the label <code>instrument: obi</code>. and more discovery options are available in the official documentation:</p>
</div>
<div class="paragraph">
<p><a href="https://opentelemetry.io/docs/zero-code/obi/configure/service-discovery/" class="bare">https://opentelemetry.io/docs/zero-code/obi/configure/service-discovery/</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">obi-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">o11y</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">obi-config.yml</span><span class="pi">:</span> <span class="pi">|-</span>
    <span class="s">discovery:</span>
      <span class="s">instrument:</span>

      <span class="s">- k8s_namespace: service-foundry</span>
        <span class="s">k8s_pod_labels:</span>
          <span class="s">instrument: obi</span>

    <span class="s"># https://opentelemetry.io/docs/zero-code/obi/configure/service-discovery/</span>
    <span class="s">kubernetes:</span>
      <span class="s">resource_labels:</span>
        <span class="s">service.name:</span>
          <span class="s">- "override-svc-name"</span>
          <span class="s">- "app.kubernetes.io/name"</span>
          <span class="s">- "app.kubernetes.io/component"</span>

        <span class="s">service.namespace:</span>
          <span class="s">- "override-svc-namespace"</span>
          <span class="s">- "app.kubernetes.io/part-of"</span>
          <span class="s">- "app.kubernetes.io/namespace"</span>

    <span class="s"># Controls how eBPF-generated spans behave</span>
    <span class="s">ebpf:</span>
      <span class="s"># When true, OBI does NOT auto-detect existing SDKs.</span>
      <span class="s"># Instead, it assumes that incoming requests may already contain trace headers.</span>
      <span class="s">disable_sdk_detection: true</span>

      <span class="s"># When true, include spans for inbound/outbound network calls</span>
      <span class="s"># (so OBI generates child spans only when trace context exists)</span>
      <span class="s">include_network_spans: true</span>

      <span class="s"># Optional: capture network metadata</span>
      <span class="s">capture_headers: true</span>
      <span class="s">capture_body: false</span>

      <span class="s"># Optional: enrich spans with Kubernetes metadata</span>
      <span class="s">kube_metadata_enable: true</span>

    <span class="s">otel_traces_export:</span>
      <span class="s">endpoint: http://otel-collector.o11y.svc.cluster.local:4318</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="obi-daemonset-yaml">obi-daemonset.yaml</h4>
<div class="paragraph">
<p>The obi-daemonset.yaml file defines the DaemonSet that deploys the OBI agent on each node in the Kubernetes cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">obi</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">service-foundry</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">obi</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">obi</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">obi</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">hostPID</span><span class="pi">:</span> <span class="kc">true</span> <span class="c1"># Required to access the processes on the host</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">obi</span> <span class="c1"># required if you want kubernetes metadata decoration</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">autoinstrument</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">otel/ebpf-instrument:main</span>
          <span class="na">securityContext</span><span class="pi">:</span>
            <span class="na">privileged</span><span class="pi">:</span> <span class="kc">true</span>
            <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">0</span>
            <span class="na">capabilities</span><span class="pi">:</span>
              <span class="na">add</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">SYS_ADMIN</span>
                <span class="pi">-</span> <span class="s">SYS_RESOURCE</span>
                <span class="pi">-</span> <span class="s">CAP_NET_ADMIN</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1">#- name: OTEL_EXPORTER_OTLP_ENDPOINT</span>
            <span class="c1">#  value: 'http://otel-collector.o11y.svc.cluster.local:4318'</span>
              <span class="c1"># required if you want kubernetes metadata decoration</span>
            <span class="c1">#- name: OTEL_EBPF_KUBE_METADATA_ENABLE</span>
            <span class="c1">#  value: 'true'</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_EBPF_CONFIG_PATH</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">/etc/obi/config/obi-config.yml</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_EBPF_LOG_LEVEL</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">debug'</span> <span class="c1"># debug, info, warn, error</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_EBPF_BPF_CONTEXT_PROPAGATION</span> <span class="c1"># all, headers, ip, disabled</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">headers</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_EBPF_BPF_TRACK_REQUEST_HEADERS</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_EBPF_METRIC_FEATURES</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">network,application</span>

          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">obi-config</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/obi/config</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">var-run-obi</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/run/obi</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cgroup</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/sys/fs/cgroup</span>

      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">obi-config</span>
          <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">obi-config</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">var-run-obi</span>
          <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cgroup</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/sys/fs/cgroup</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fluent-bit-daemonset">Fluent Bit DaemonSet</h3>
<div class="paragraph">
<p>These files are generated and deployed as a ArgoCD application when you click the "Enable OBI" button.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>custom-values-0.53.0.yaml</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Filter configurations for Fluent Bit are dependent on your application and log format. You may need to modify the filter configurations in the custom-values-0.53.0.yaml file to match your application&#8217;s log format.</p>
</div>
<div class="sect3">
<h4 id="log-format-of-the-go-application">Log Format of the Go Application</h4>
<div class="paragraph">
<p>The sample Go application in this example uses a JSON log format. Here is an example log entry:</p>
</div>
<div class="listingblock">
<div class="title">go-log-format.txt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"job.name"</span><span class="p">:</span><span class="s2">"service-foundry-builder"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"level"</span><span class="p">:</span><span class="s2">"info"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"Received request for job status"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"span_id"</span><span class="p">:</span><span class="s2">"316912bad90ada05"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"time"</span><span class="p">:</span><span class="s2">"2025-10-15T03:27:15Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"trace_id"</span><span class="p">:</span><span class="s2">"e3501aa248ec89c9e1d629720797cbf1"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The log entry contains fields such as job.name, level, msg, span_id, time, and trace_id. The trace_id and span_id field is particularly important as it allows us to correlate logs with traces. They came from the propagated trace context.</p>
</div>
</div>
<div class="sect3">
<h4 id="input-configuration">Input Configuration</h4>
<div class="paragraph">
<p>In the input configuration, we use the Tail input plugin to read log files from the specified path. The Path parameter should match the log file path of your Go application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">config</span><span class="pi">:</span>

  <span class="na">inputs</span><span class="pi">:</span> <span class="pi">|</span>

    <span class="s">[INPUT]</span>
        <span class="s">Name tail</span>
        <span class="s">Path        /var/log/containers/service-foundry-app-backend-*.log</span>
        <span class="s">Tag         obi-log.*</span>
        <span class="s">Parser      cri_json_tail</span>
        <span class="s">Mem_Buf_Limit 32MB</span>
        <span class="s">multiline.parser              docker,</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filters-configuration">Filters Configuration</h4>
<div class="paragraph">
<p>In the filters configuration, we use several filter plugins to process and enrich the log entries.</p>
</div>
<div class="paragraph">
<p>After all filters are applied, the log entry will be transformed into the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">[1760489734.138600321, {}, {"job.name"=&gt;"service-foundry-builder", "SeverityText"=&gt;"info", "msg"=&gt;"Received request for job status", "SpanId"=&gt;"210d9d66448b8a82", "time"=&gt;"2025-10-15T00:55:34Z", "TraceId"=&gt;"ccd3e8cd7f82aaa010b27493763c78dc", "@timestamp"=&gt;"2025-10-15T00:55:34.138600321Z", "service.namespace"=&gt;"service-foundry", "service.name"=&gt;"service-foundry-app-backend"}]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="output-configuration">Output Configuration</h4>
<div class="paragraph">
<p>In the output configuration, we use the OpenTelemetry output plugin to send logs to the Otel Collector. The Host and Port parameters should match the Otel Collector&#8217;s service name and port in your Kubernetes cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"> <span class="na">outputs</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[OUTPUT]</span>
        <span class="s">Name            opentelemetry</span>
        <span class="s">Match           obi-log.*</span>
        <span class="s">Host            otel-collector.o11y.svc.cluster.local</span>
        <span class="s">Port            4318</span>
        <span class="s">Logs_uri        /v1/logs</span>
        <span class="s">TLS             Off</span>
        <span class="s">Logs_Body_Key   msg</span>
        <span class="s">Logs_Body_Key_Attributes On</span>
        <span class="s">Logs_Timestamp_Metadata_Key @timestamp</span>
        <span class="s">Logs_Resource_Metadata_Key   service.name</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-logs-in-go-applications">Writing Logs in Go Applications</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="middleware-go">middleware.go</h3>
<div class="paragraph">
<p>To retrieve and log the trace context (trace_id and span_id) in your Go application, you can use the OpenTelemetry Go SDK. Here is an example of how to do this:</p>
</div>
<div class="listingblock">
<div class="title">middleware.go</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="go"><span class="k">package</span> <span class="n">tracing</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>
	<span class="s">"net/http"</span>

	<span class="s">"github.com/gin-gonic/gin"</span>
	<span class="s">"go.opentelemetry.io/otel/propagation"</span>
<span class="p">)</span>

<span class="c">// Global propagator for W3C Trace Context (traceparent, tracestate)</span>
<span class="k">var</span> <span class="n">Propagator</span> <span class="o">=</span> <span class="n">propagation</span><span class="o">.</span><span class="n">TraceContext</span><span class="p">{}</span>

<span class="c">// ExtractContext extracts any incoming OpenTelemetry trace context</span>
<span class="c">// (e.g., from OBI, upstream services, or gateways) from HTTP headers.</span>
<span class="k">func</span> <span class="n">ExtractContext</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span> <span class="p">{</span>

	<span class="k">return</span> <span class="n">Propagator</span><span class="o">.</span><span class="n">Extract</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Context</span><span class="p">(),</span> <span class="n">propagation</span><span class="o">.</span><span class="n">HeaderCarrier</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Header</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">Middleware</span><span class="p">()</span> <span class="n">gin</span><span class="o">.</span><span class="n">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">gin</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="c">// Extract context from request headers (from OBI or upstream)</span>
		<span class="n">ctx</span> <span class="o">:=</span> <span class="n">ExtractContext</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span>

		<span class="c">// Replace the request context so downstream handlers use it</span>
		<span class="n">c</span><span class="o">.</span><span class="n">Request</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">WithContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

		<span class="n">c</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="logger-go">logger.go</h3>
<div class="paragraph">
<p>In logger.go, we define a custom logger that includes the trace_id and span_id from the context in each log entry. This allows us to correlate logs with traces in the observability stack.</p>
</div>
<div class="listingblock">
<div class="title">logger.go</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="go"><span class="k">package</span> <span class="n">logger</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>

	<span class="s">"github.com/sirupsen/logrus"</span>
	<span class="s">"go.opentelemetry.io/otel/trace"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="n">_logger</span> <span class="o">=</span> <span class="n">logrus</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>

<span class="k">func</span> <span class="n">Init</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">_logger</span><span class="o">.</span><span class="n">SetFormatter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logrus</span><span class="o">.</span><span class="n">JSONFormatter</span><span class="p">{})</span>
	<span class="n">_logger</span><span class="o">.</span><span class="n">SetLevel</span><span class="p">(</span><span class="n">logrus</span><span class="o">.</span><span class="n">InfoLevel</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Info logs a message with trace_id and span_id from context</span>
<span class="k">func</span> <span class="n">Info</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="n">fields</span> <span class="o">...</span><span class="n">logrus</span><span class="o">.</span><span class="n">Fields</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">entry</span> <span class="o">:=</span> <span class="n">_logger</span><span class="o">.</span><span class="n">WithFields</span><span class="p">(</span><span class="n">extractTraceFields</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">fields</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">WithField</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">entry</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Error logs an error message with trace context</span>
<span class="k">func</span> <span class="n">Error</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">_logger</span><span class="o">.</span><span class="n">WithFields</span><span class="p">(</span><span class="n">extractTraceFields</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span><span class="o">.</span><span class="n">WithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// extractTraceFields pulls trace_id/span_id from context</span>
<span class="k">func</span> <span class="n">extractTraceFields</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="n">logrus</span><span class="o">.</span><span class="n">Fields</span> <span class="p">{</span>
	<span class="n">sc</span> <span class="o">:=</span> <span class="n">trace</span><span class="o">.</span><span class="n">SpanContextFromContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

	<span class="k">if</span> <span class="o">!</span><span class="n">sc</span><span class="o">.</span><span class="n">IsValid</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">logrus</span><span class="o">.</span><span class="n">Fields</span><span class="p">{}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">logrus</span><span class="o">.</span><span class="n">Fields</span><span class="p">{</span>
		<span class="s">"trace_id"</span><span class="o">:</span> <span class="n">sc</span><span class="o">.</span><span class="n">TraceID</span><span class="p">()</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
		<span class="s">"span_id"</span><span class="o">:</span>  <span class="n">sc</span><span class="o">.</span><span class="n">SpanID</span><span class="p">()</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This Middleware should be added to your Gin router to ensure that all incoming requests have their trace context extracted and set in the request context.</p>
</div>
<div class="listingblock">
<div class="title">main.go</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="go"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">logger</span><span class="o">.</span><span class="n">Init</span><span class="p">()</span>


	<span class="n">r</span> <span class="o">:=</span> <span class="n">gin</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>

	<span class="c">// Custom tracing middleware to extract context from incoming requests</span>
	<span class="n">r</span><span class="o">.</span><span class="n">Use</span><span class="p">(</span><span class="n">tracing</span><span class="o">.</span><span class="n">Middleware</span><span class="p">())</span>

    <span class="c">// omitted for brevity</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="writing-logs-in-handlers">Writing Logs in Handlers</h3>
<div class="paragraph">
<p>In your HTTP handlers, you can use the custom logger to log messages along with the trace context. Here is an example of how to do this in a Gin handler:</p>
</div>
<div class="listingblock">
<div class="title">handler.go</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="go"><span class="k">func</span> <span class="n">RunInternalServiceHandler</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">gin</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ctx</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

	<span class="n">logger</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"Received request to run internal service"</span><span class="p">)</span>

    <span class="c">// omitted for brevity</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This log entry will include the trace_id and span_id, allowing you to correlate it with the corresponding trace in your observability stack.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="traefik-configuration-for-trace-context-propagation">Traefik Configuration for Trace Context Propagation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since the Otel eBPF instrumentation does not automatically propagate trace context for incoming requests, we will use Traefik as a reverse proxy to add trace context headers to incoming requests. This ensures that the Go application receives the trace context and can log it accordingly.</p>
</div>
<div class="paragraph">
<p>Traefik is installed as a core component in Service Foundry. You can configure Traefik to add the necessary headers for trace context propagation.</p>
</div>
<div class="imageblock img-wide">
<div class="content">
<img src="./images/sf-console-traefik-edit.png" alt="sf console traefik edit">
</div>
<div class="title">Figure 6. Service Foundry Console - Edit Traefik Configuration</div>
</div>
<div class="paragraph">
<p>Add the following configuration to the custom-values.yaml file for Traefik:</p>
</div>
<div class="listingblock source">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">tracing</span><span class="pi">:</span>
  <span class="na">addInternals</span><span class="pi">:</span> <span class="kc">true</span>

  <span class="na">otlp</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">endpoint</span><span class="pi">:</span> <span class="s">http://otel-collector.o11y.svc.cluster.local:4318</span>
      <span class="na">insecure</span><span class="pi">:</span> <span class="kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have published the changes, ArgoCD will automatically deploy the updated Traefik configuration within a few minutes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By following this guide, you have successfully set up end-to-end observability for your Go applications using OpenTelemetry eBPF instrumentation. You can now monitor and analyze traces, metrics, and logs in your observability stack, gaining valuable insights into the performance and behavior of your applications.</p>
</div>
<div class="paragraph">
<p>For more information on OpenTelemetry eBPF instrumentation, refer to the official documentation:</p>
</div>
<div class="paragraph">
<p><a href="https://opentelemetry.io/docs/zero-code/obi/" class="bare">https://opentelemetry.io/docs/zero-code/obi/</a></p>
</div>
</div>
</div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Distributed Tracing - Spring Boot Application with OpenTelemetry Instrumentation</title>
    <link rel="stylesheet" href="/service-foundry/pages/assets/css/main.css">
</head>
<body>

<!-- Header -->
<header>
<!--    <div class="logo text-xl font-semibold">Service Foundry</div>-->
    <a href="/service-foundry/pages/index.html" class="text-2xl font-semibold hover:text-teal-400">Service Foundry</a>
    <nav>
    <a href="/service-foundry/pages/documents/index.html" class="text-teal-400 border-b-2 border-teal-400 pb-1">Docs</a>
    <a href="/service-foundry/pages/architecture/index.html" class="hover:text-teal-400">Architecture</a>
    <a href="/service-foundry/pages/getting-started/index.html" class="hover:text-teal-400">Getting Started</a>
    <a href="https://github.com/nsalexamy/service-foundry" class="hover:text-teal-400">GitHub</a>
</nav>
</header>

<!-- Sub-navigation for Foundries -->
<div class="subnav">
    <a href="/service-foundry/pages/documents/infra-foundry/index.html" class="text-gray-300 hover:text-white">Infra</a>
    <a href="/service-foundry/pages/documents/sso-foundry/index.html" class="text-gray-300 hover:text-white">SSO</a>
    <a href="/service-foundry/pages/documents/o11y-foundry/index.html" class="text-gray-300 hover:text-white">Observability</a>
    <a href="/service-foundry/pages/documents/backend-foundry/index.html" class="text-gray-300 hover:text-white">Backend</a>
    <a href="/service-foundry/pages/documents/bigdata-foundry/index.html" class="text-gray-300 hover:text-white">Big Data</a>
</div>




<!-- Breadcrumb -->

    <nav class="breadcrumb-wrapper">
    <ol class="breadcrumb">
        
        <li>
            
            <a href="/service-foundry/pages/">Home</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/">Docs</a>
            
            
            <span class="separator">/</span>
            
        </li>
        
        <li>
            
            <a href="/service-foundry/pages/documents/o11y-foundry/">Observability Foundry</a>
            
            
        </li>
        
    </ol>
</nav>





<!-- Main Layout -->
<div class="container">
    <nav id="toc-container" class="toc-nav"></nav>
    <main id="main-content">
        
        <div class="author-box">
            Young Gyu Kim
            &lt;<a href="mailto:credemol@gmail.com" style="color: #0d9488; text-decoration: none;">credemol@gmail.com</a>&gt;
        </div>
        

        <!-- Title -->
        
        <h1 class="page-title">
            Distributed Tracing - Spring Boot Application with OpenTelemetry Instrumentation
        </h1>
        

        <div id="toc" class="toc">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#opentelemetry-instrumentation">OpenTelemetry Instrumentation</a></li>
</ul>
</li>
<li><a href="#opentelemetry">OpenTelemetry</a>
<ul class="sectlevel2">
<li><a href="#what-is-opentelemetry">What is OpenTelemetry?</a></li>
<li><a href="#out-of-the-box-instrumentation">Out of the box instrumentation</a></li>
<li><a href="#download-opentelemetry-instrumentation">Download OpenTelemetry Instrumentation</a></li>
<li><a href="#system-environment-variables">System environment variables</a></li>
<li><a href="#build-and-run-the-application">Build and run the application</a></li>
</ul>
</li>
<li><a href="#opentelemetry-operator-for-kubernetesinject-opentelemetry-auto-instrumentation-in-kubernetes">OpenTelemetry Operator for Kubernetes(Inject OpenTelemetry Auto-Instrumentation in Kubernetes)</a>
<ul class="sectlevel2">
<li><a href="#cert-manager">Install cert-manager</a></li>
<li><a href="#otel-operator">Install OpenTelemetry Operator</a></li>
</ul>
</li>
<li><a href="#deploy-spring-boot-application-with-opentelemetry-instrumentation">Deploy Spring Boot Application with OpenTelemetry Instrumentation</a>
<ul class="sectlevel2">
<li><a href="#dockerfile">Dockerfile</a></li>
</ul>
</li>
<li><a href="#opentelemetry-instrumentation-java-configuration">OpenTelemetry Instrumentation Java Configuration</a>
<ul class="sectlevel2">
<li><a href="#helm-chart">Helm chart</a></li>
</ul>
</li>
<li><a href="#opentelemetry-instrumentation-extension">OpenTelemetry Instrumentation extension</a>
<ul class="sectlevel2">
<li><a href="#exclude-urls-from-tracing">Exclude URLs from Tracing</a></li>
<li><a href="#healthcheckexclusionsampler-java">HealthCheckExclusionSampler.java</a></li>
<li><a href="#nas2autoconfigurationcustomizerprovider-java">Nas2AutoConfigurationCustomizerProvider.java</a></li>
<li><a href="#dockerfile-2">Dockerfile</a></li>
</ul>
</li>
<li><a href="#comparison-to-using-spring-boot-actuator-for-tracing">Comparison to using Spring Boot Actuator for Tracing</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#trouble-shooting">Trouble Shooting</a>
<ul class="sectlevel2">
<li><a href="#httpexporter-not-working-resulting-in-404-page-not-found">HttpExporter not working resulting in 404 page not found</a></li>
<li><a href="#vm-warning-sharing-is-only-supported-for-boot-loader-classes-3111">VM warning: Sharing is only supported for boot loader classes #3111</a></li>
</ul>
</li>
<li><a href="#inject-opentelemetry-auto-instrumentation-in-kubernetes">Inject OpenTelemetry Auto-Instrumentation in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#exclude-urls-from-tracing-2">Exclude URLs from Tracing</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This article is part of a series of articles on Distributed Tracing. In this article, we will discuss how to set up Zipkin and a sample Spring Boot application to demonstrate distributed tracing.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Part 1 - <a href="https://www.linkedin.com/pulse/distributed-tracing-setup-zipkin-sample-spring-boot-young-gyu-kim-msaqc/">Distributed Tracing - Setup Zipkin and Sample Spring Boot Application</a></p>
</li>
<li>
<p>Part 2 - <a href="https://www.linkedin.com/pulse/distributed-tracing-spring-boot-application-micrometer-kim-napzc">Distributed Tracing - Spring Boot Application with Micrometer and OpenTelemetry</a></p>
</li>
<li>
<p>Part 3 - <a href="https://www.linkedin.com/pulse/distributed-tracing-spring-boot-application-young-gyu-kim-cuuvc/">Distributed Tracing - Spring Boot Application with OpenTelemetry Instrumentation</a></p>
</li>
<li>
<p>Part 4 - Distributed Tracing - Spring Boot Application with OpenTelemetry Collector</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This article is the third part of the series.</p>
</div>
<div class="sect2">
<h3 id="opentelemetry-instrumentation">OpenTelemetry Instrumentation</h3>
<div class="paragraph">
<p>This article describes how to use OpenTelemetry instrumentation in a Spring Boot application. The requirements are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable tracing for HTTP requests, JDBC calls, and RabbitMQ messages.</p>
</li>
<li>
<p>Disable tracing for Actuator endpoints.</p>
</li>
<li>
<p>Use OpenTelemetry with Zipkin.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="opentelemetry">OpenTelemetry</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what-is-opentelemetry">What is OpenTelemetry?</h3>
<div class="paragraph">
<p>OpenTelemetry is an open-source project that provides a set of APIs, libraries, agents, and instrumentation to collect distributed traces and metrics from applications. OpenTelemetry is a merger of two popular distributed tracing projects, OpenTracing and OpenCensus.</p>
</div>
</div>
<div class="sect2">
<h3 id="out-of-the-box-instrumentation">Out of the box instrumentation</h3>
<div class="paragraph">
<p>Refer to the following link for more information on out-of-the-box instrumentation for Java:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://opentelemetry.io/docs/zero-code/java/spring-boot-starter/out-of-the-box-instrumentation/">Out of the box instrumentation</a></p>
</li>
</ul>
</div>
<div class="hdlist">
<div class="title">Features - Property and Default Value</div>
<table>
<tr>
<td class="hdlist1">
JDBC
</td>
<td class="hdlist2">
<p>otel.instrumentation.jdbc.enabled (Default: true)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Logback
</td>
<td class="hdlist2">
<p>otel.instrumentation.logback-appender.enabled (Default: true)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Spring Web
</td>
<td class="hdlist2">
<p>otel.instrumentation.spring-web.enabled (Default: true)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Spring Web MVC
</td>
<td class="hdlist2">
<p>otel.instrumentation.spring-webmvc.enabled (Default: true)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Spring Webflux
</td>
<td class="hdlist2">
<p>otel.instrumentation.spring-webflux.enabled (Default: true)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Kafka
</td>
<td class="hdlist2">
<p>otel.instrumentation.kafka.enabled (Default: true)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
MongoDB
</td>
<td class="hdlist2">
<p>otel.instrumentation.mongodb.enabled (Default: true)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Micrometer
</td>
<td class="hdlist2">
<p>otel.instrumentation.micrometer.enabled (Default: false)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
R2DBC
</td>
<td class="hdlist2">
<p>otel.instrumentation.r2dbc.enabled (Default: true)</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="download-opentelemetry-instrumentation">Download OpenTelemetry Instrumentation</h3>
<div class="paragraph">
<p>Run the following command to download the OpenTelemetry instrumentation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> javaagent
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">-O</span> https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar <span class="nt">--output-dir</span> javaagent</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above downloads the OpenTelemetry Java agent to the <code>javaagent</code> directory.</p>
</div>
</div>
<div class="sect2">
<h3 id="system-environment-variables">System environment variables</h3>
<div class="listingblock">
<div class="title">set environment variables</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">export </span><span class="nv">JAVA_TOOL_OPTIONS</span><span class="o">=</span><span class="s2">"-javaagent:./javaagent/opentelemetry-javaagent.jar"</span> <span class="se">\</span>
  <span class="nv">OTEL_TRACES_EXPORTER</span><span class="o">=</span>zipkin <span class="se">\</span>
  <span class="nv">OTEL_EXPORTER_ZIPKIN_ENDPOINT</span><span class="o">=</span>http://zipkin-server:9411/api/v2/spans <span class="se">\</span>
  <span class="nv">OTEL_METRICS_EXPORTER</span><span class="o">=</span>none <span class="se">\</span>
  <span class="nv">OTEL_LOGS_EXPORTER</span><span class="o">=</span>none</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-and-run-the-application">Build and run the application</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure that JAVA_TOOL_OPTIONS is set to the OpenTelemetry Java agent before building the application. Otherwise, the tracing for database calls will not work.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">build the application</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>./gradlew clean bootJar

Picked up JAVA_TOOL_OPTIONS: <span class="nt">-javaagent</span>:./javaagent/opentelemetry-javaagent.jar</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">run the application</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>java <span class="nt">-jar</span> build/libs/nsa2-opentelemetry-example-0.0.1-SNAPSHOT.jar

Picked up JAVA_TOOL_OPTIONS: <span class="nt">-javaagent</span>:./javaagent/opentelemetry-javaagent.jar</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test the application</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>curl http://localhost:8080/error-logs/notify

4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to the Zipkin UI to view the traces.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/zipkin-otel-instrumentation.png" alt=" Zipkin OpenTelemetry Traces" width="1000">
</div>
<div class="title">Figure 1. Zipkin UI</div>
</div>
<div class="paragraph">
<p>OpenTelemetry instrumentation provider more detailed information about the traces as you can see from the image above. The traces include the HTTP request, JDBC call, and RabbitMQ message.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="opentelemetry-operator-for-kubernetesinject-opentelemetry-auto-instrumentation-in-kubernetes">OpenTelemetry Operator for Kubernetes(Inject OpenTelemetry Auto-Instrumentation in Kubernetes)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section was written with reference to the following links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-operator" class="bare">https://github.com/open-telemetry/opentelemetry-operator</a></p>
</li>
<li>
<p><a href="https://opentelemetry.io/docs/kubernetes/operator/automatic/" class="bare">https://opentelemetry.io/docs/kubernetes/operator/automatic/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The OpenTelemetry Operator is a Kubernetes operator that manages the lifecycle of OpenTelemetry components. The operator deploys and manages the OpenTelemetry Collector, which collects, processes, and exports telemetry data.</p>
</div>
<div class="paragraph">
<p>The OpenTelemetry Operator supports injecting and configuring auto-instrumentation libraries for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java</p>
</li>
<li>
<p>.NET</p>
</li>
<li>
<p>Node.js</p>
</li>
<li>
<p>Python</p>
</li>
<li>
<p>Go</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this document, we will focus on Java auto-instrumentation. And we will use the Zipkin server to collect traces without the OpenTelemetry Collector.</p>
</div>
<div class="paragraph">
<p>I will cover the topic of using the OpenTelemetry Collector in a separate article.</p>
</div>
<div class="paragraph">
<p>To enable OpenTelemetry instrumentation on Kubernetes, we will need to install the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cert-manager</p>
</li>
<li>
<p>OpenTelemetry Operator</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cert-manager">Install cert-manager</h3>
<div class="paragraph">
<p>To install the operator in an existing cluster, make sure you have cert-manager installed and run:</p>
</div>
<div class="paragraph">
<p><a href="https://cert-manager.io/docs/installation/">cert-manager installation</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://github.com/cert-manager/cert-manager/releases/download/v1.15.2/cert-manager.yaml

namespace/cert-manager created
customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io created
serviceaccount/cert-manager-cainjector created
serviceaccount/cert-manager created
serviceaccount/cert-manager-webhook created
clusterrole.rbac.authorization.k8s.io/cert-manager-cainjector created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-issuers created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificates created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-orders created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-challenges created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created
clusterrole.rbac.authorization.k8s.io/cert-manager-cluster-view created
clusterrole.rbac.authorization.k8s.io/cert-manager-view created
clusterrole.rbac.authorization.k8s.io/cert-manager-edit created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created
clusterrole.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-cainjector created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-issuers created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificates created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-orders created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-challenges created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created
role.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created
role.rbac.authorization.k8s.io/cert-manager:leaderelection created
role.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created
rolebinding.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created
rolebinding.rbac.authorization.k8s.io/cert-manager:leaderelection created
rolebinding.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created
service/cert-manager created
service/cert-manager-webhook created
deployment.apps/cert-manager-cainjector created
deployment.apps/cert-manager created
deployment.apps/cert-manager-webhook created
mutatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created
validatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created</code></pre>
</div>
</div>
<div class="paragraph">
<p>All resources are created in the <code>cert-manager</code> namespace.</p>
</div>
</div>
<div class="sect2">
<h3 id="otel-operator">Install OpenTelemetry Operator</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://github.com/open-telemetry/opentelemetry-operator/releases/latest/download/opentelemetry-operator.yaml

namespace/opentelemetry-operator-system created
customresourcedefinition.apiextensions.k8s.io/instrumentations.opentelemetry.io created
customresourcedefinition.apiextensions.k8s.io/opampbridges.opentelemetry.io created
customresourcedefinition.apiextensions.k8s.io/opentelemetrycollectors.opentelemetry.io created
serviceaccount/opentelemetry-operator-controller-manager created
role.rbac.authorization.k8s.io/opentelemetry-operator-leader-election-role created
clusterrole.rbac.authorization.k8s.io/opentelemetry-operator-manager-role created
clusterrole.rbac.authorization.k8s.io/opentelemetry-operator-metrics-reader created
clusterrole.rbac.authorization.k8s.io/opentelemetry-operator-proxy-role created
rolebinding.rbac.authorization.k8s.io/opentelemetry-operator-leader-election-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/opentelemetry-operator-manager-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/opentelemetry-operator-proxy-rolebinding created
service/opentelemetry-operator-controller-manager-metrics-service created
service/opentelemetry-operator-webhook-service created
deployment.apps/opentelemetry-operator-controller-manager created
certificate.cert-manager.io/opentelemetry-operator-serving-cert created
issuer.cert-manager.io/opentelemetry-operator-selfsigned-issuer created
mutatingwebhookconfiguration.admissionregistration.k8s.io/opentelemetry-operator-mutating-webhook-configuration created
validatingwebhookconfiguration.admissionregistration.k8s.io/opentelemetry-operator-validating-webhook-configuration created</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-spring-boot-application-with-opentelemetry-instrumentation">Deploy Spring Boot Application with OpenTelemetry Instrumentation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="dockerfile">Dockerfile</h3>
<div class="paragraph">
<p>Dockerfile and opentelemetry-javaagent.jar are required to build the Docker image.</p>
</div>
<div class="paragraph">
<p>The directory structure is as follows:</p>
</div>
<div class="listingblock">
<div class="title">build/libs directory structure</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">build/libs
├── Dockerfile
├── nsa2-opentelemetry-example-0.0.1-SNAPSHOT.jar
└── opentelemetry-javaagent.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the Dockerfile:</p>
</div>
<div class="listingblock">
<div class="title">build/libs/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="dockerfile"><span class="k">FROM</span><span class="s"> openjdk:21-jdk-bullseye</span>
<span class="k">COPY</span><span class="s"> ./nsa2-opentelemetry-example-0.0.1-SNAPSHOT.jar /usr/app/nsa2-opentelemetry-example.jar</span>
<span class="k">COPY</span><span class="s"> ./opentelemetry-javaagent.jar /usr/app/javaagent/opentelemetry-javaagent.jar</span>

<span class="k">WORKDIR</span><span class="s"> /usr/app</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["java", "-Xshare:off", "-javaagent:/usr/app/javaagent/opentelemetry-javaagent.jar", "-jar", "nsa2-opentelemetry-example.jar"]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JVM Options used in the Dockerfile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><em>-Xshare:off</em></strong> option is used to disable class data sharing.</p>
</li>
<li>
<p><strong><em>-javaagent:/usr/app/javaagent/opentelemetry-javaagent.jar</em></strong> option is used to enable OpenTelemetry instrumentation.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="opentelemetry-instrumentation-java-configuration">OpenTelemetry Instrumentation Java Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Properties for OpenTelemetry instrumentation are listed below:</p>
</div>
<div class="paragraph">
<p><a href="https://opentelemetry.io/docs/languages/java/configuration/">https://opentelemetry.io/docs/languages/java/configuration/ - OpenTelemetry Java Configuration</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">System Properties and Environment Variables</div>
<div class="paragraph">
<p>Any setting configurable with a system property can also be configured with an environment variable. Apply the following steps to convert a system property to an environment variable:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Convert the name to uppercase.</p>
</li>
<li>
<p>Replace all . and - characters with _.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the system property <code>otel.traces.exporter</code> can be set as an environment variable <code>OTEL_TRACES_EXPORTER</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="helm-chart">Helm chart</h3>
<div class="paragraph">
<p>Properties for OpenTelemetry instrumentation can be set in the deployment.yaml file of the Helm chart.</p>
</div>
<div class="paragraph">
<p>For more information on how to use Helm chart to deploy your application, refer to the following link:</p>
</div>
<div class="paragraph">
<p><a href="https://www.linkedin.com/pulse/part-2-deploying-spring-boot-application-kubernetes-young-gyu-kim-ewaqc/">Part 2: Deploying Spring Boot Application to Kubernetes</a></p>
</div>
<div class="listingblock">
<div class="title">templates/deployment.yaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml">          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_TRACES_EXPORTER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">zipkin</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_EXPORTER_ZIPKIN_ENDPOINT</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">http://zipkin-server:9411/api/v2/spans</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_METRICS_EXPORTER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">none</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OTEL_LOGS_EXPORTER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">none</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on how to use Zipkin exporter, refer to the following link:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://opentelemetry.io/docs/languages/java/configuration/#zipkin-exporter">OpenTelemetry Java Configuration - Zipkin Exporter</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="opentelemetry-instrumentation-extension">OpenTelemetry Instrumentation extension</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="exclude-urls-from-tracing">Exclude URLs from Tracing</h3>
<div class="paragraph">
<p>In Kubernetes, when you deploy a Spring Boot application with live probes, the health check URLs are called frequently, and they are traced in the Zipkin server.
To exclude these URLs from tracing, we can use the OpenTelemetry Instrumentation extension.</p>
</div>
<div class="paragraph">
<p>I created a separate Java project to demonstrate how to exclude health check URLs from tracing.</p>
</div>
<div class="paragraph">
<p>There are two classes in the project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HealthCheckExclusionSampler.java</p>
</li>
<li>
<p>Nas2AutoConfigurationCustomizerProvider.java</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="healthcheckexclusionsampler-java">HealthCheckExclusionSampler.java</h3>
<div class="paragraph">
<p>I implemented a custom sampler to exclude health check URLs from tracing.</p>
</div>
<div class="listingblock">
<div class="title">HealthCheckExclusionSampler.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">com.alexamy.nsa2.otel.extension</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.opentelemetry.api.common.AttributeKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.api.common.Attributes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.api.trace.SpanKind</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.context.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.sdk.trace.data.LinkData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.sdk.trace.samplers.Sampler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.sdk.trace.samplers.SamplingResult</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HealthCheckExclusionSampler</span> <span class="kd">implements</span> <span class="nc">Sampler</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">SamplingResult</span> <span class="nf">shouldSample</span><span class="o">(</span><span class="nc">Context</span> <span class="n">parentContext</span><span class="o">,</span> <span class="nc">String</span> <span class="n">traceId</span><span class="o">,</span>
                                       <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">SpanKind</span> <span class="n">spanKind</span><span class="o">,</span>
                                       <span class="nc">Attributes</span> <span class="n">attributes</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">LinkData</span><span class="o">&gt;</span> <span class="n">parentLinks</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">String</span> <span class="n">urlPath</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">AttributeKey</span><span class="o">.</span><span class="na">stringKey</span><span class="o">(</span><span class="s">"url.path"</span><span class="o">));</span>

        <span class="k">if</span><span class="o">(</span><span class="n">urlPath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">urlPath</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"/actuator/health"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">SamplingResult</span><span class="o">.</span><span class="na">drop</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nc">SamplingResult</span><span class="o">.</span><span class="na">recordAndSample</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"HealthCheckExclusionSampler"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the URL path contains "/actuator/health", the sampler will drop the trace.</p>
</div>
</div>
<div class="sect2">
<h3 id="nas2autoconfigurationcustomizerprovider-java">Nas2AutoConfigurationCustomizerProvider.java</h3>
<div class="paragraph">
<p>I implemented a customizer provider to add the custom sampler to the OpenTelemetry instrumentation.</p>
</div>
<div class="listingblock">
<div class="title">Nas2AutoConfigurationCustomizerProvider.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">com.alexamy.nsa2.otel.extension</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.auto.service.AutoService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.sdk.autoconfigure.spi.AutoConfigurationCustomizer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.opentelemetry.sdk.autoconfigure.spi.AutoConfigurationCustomizerProvider</span><span class="o">;</span>

<span class="nd">@AutoService</span><span class="o">(</span><span class="nc">AutoConfigurationCustomizerProvider</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Nas2AutoConfigurationCustomizerProvider</span> <span class="kd">implements</span> <span class="nc">AutoConfigurationCustomizerProvider</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">customize</span><span class="o">(</span><span class="nc">AutoConfigurationCustomizer</span> <span class="n">autoConfigurationCustomizer</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">autoConfigurationCustomizer</span><span class="o">.</span><span class="na">addSamplerCustomizer</span><span class="o">(</span>
            <span class="o">(</span><span class="n">sampler</span><span class="o">,</span> <span class="n">configProperties</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">HealthCheckExclusionSampler</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The class with @AutoService annotation is automatically discovered by the OpenTelemetry instrumentation. The addSamplerCustomizer method is used to add the custom sampler to the OpenTelemetry instrumentation.</p>
</div>
<div class="paragraph">
<p>The project is built as a JAR file named <code>nsa2-otel-extension-1.0-all.jar</code> and used as an extension in the Spring Boot application.</p>
</div>
<div class="paragraph">
<p>For more information on how to develop an OpenTelemetry Instrumentation extension, refer to the following link:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/examples/extension/README.md" class="bare">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/examples/extension/README.md</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once you have the extension project, you can build the JAR file and use it with -Dotel.javaagent.extensions option to exclude URLs from tracing.</p>
</div>
<div class="listingblock">
<div class="title">how to use the extension</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>java <span class="nt">-javaagent</span>:path/to/opentelemetry-javaagent.jar <span class="se">\</span>
     <span class="nt">-Dotel</span>.javaagent.extensions<span class="o">=</span>nsa2-otel-extension-1.0-all.jar <span class="se">\</span>
     <span class="nt">-jar</span> myapp.jar</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dockerfile-2">Dockerfile</h3>
<div class="paragraph">
<p>To use the OpenTelemetry Instrumentation extension in a Docker container, you need to add the extension JAR file to the Docker image.</p>
</div>
<div class="paragraph">
<p>Now the directory sturecture is as follows:</p>
</div>
<div class="listingblock">
<div class="title">build/libs directory structure</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">build/libs
├── Dockerfile
├── nsa2-opentelemetry-example-0.0.1-SNAPSHOT.jar
├── nsa2-otel-extension-1.0-all.jar
└── opentelemetry-javaagent.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the Dockerfile:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="dockerfile"><span class="k">FROM</span><span class="s"> openjdk:21-jdk-bullseye</span>
<span class="k">COPY</span><span class="s"> ./nsa2-opentelemetry-example-0.0.1-SNAPSHOT.jar /usr/app/nsa2-opentelemetry-example.jar</span>
<span class="k">COPY</span><span class="s"> ./opentelemetry-javaagent.jar /usr/app/javaagent/opentelemetry-javaagent.jar</span>
<span class="k">COPY</span><span class="s"> ./nsa2-otel-extension-1.0-all.jar /usr/app/javaagent/nsa2-otel-extension-1.0-all.jar</span>
<span class="k">WORKDIR</span><span class="s"> /usr/app</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
<span class="c">#ENTRYPOINT ["./run-app.sh"]</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["java", "-Xshare:off", "-Dotel.javaagent.extensions=/usr/app/javaagent/nsa2-otel-extension-1.0-all.jar", "-jar", "nsa2-opentelemetry-example.jar"]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we filter out the health check URLs from tracing and the Zipkin server will not show the traces for the health check URLs.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/zipkin-otel-no-healthcheck.png" alt="zipkin otel no healthcheck" width="1000">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="comparison-to-using-spring-boot-actuator-for-tracing">Comparison to using Spring Boot Actuator for Tracing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous article, we used Spring Boot Actuator to enable tracing for HTTP, JDBC, and RabbitMQ calls and disable tracing for health check URLs. We needed to add small amount of codes to enable tracing</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Tracing enablement</dt>
</dl>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Spring Actuator with Micrometer
</td>
<td class="hdlist2">
<p>Small amount of code are needed</p>
</td>
</tr>
<tr>
<td class="hdlist1">
OpenTelemetry Instrumentation
</td>
<td class="hdlist2">
<p>No code was added.</p>
</td>
</tr>
</table>
</div>
<div class="dlist vertical">
<dl>
<dt>Excluding Health check URLs</dt>
</dl>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Spring Actuator with Micrometer
</td>
<td class="hdlist2">
<p>Need to implement Spring Configuration Beans</p>
</td>
</tr>
<tr>
<td class="hdlist1">
OpenTelemetry Instrumentation
</td>
<td class="hdlist2">
<p>Need to implement extensions</p>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article, we learned how to use OpenTelemetry Instrumentation in a Spring Boot application. We also learned how to exclude health check URLs from tracing using OpenTelemetry Instrumentation extension. To use OpenTelemetry Instrumentation in Kubernetes, we need to install the OpenTelemetry Operator. And we implemented a custom sampler to exclude health check URLs from tracing. In the next article, we will learn how to use the OpenTelemetry Collector in a Spring Boot application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trouble-shooting">Trouble Shooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="httpexporter-not-working-resulting-in-404-page-not-found">HttpExporter not working resulting in 404 page not found</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector/issues/10761" class="bare">https://github.com/open-telemetry/opentelemetry-collector/issues/10761</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="solution">Solution</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>block metrics and logs exporter</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vm-warning-sharing-is-only-supported-for-boot-loader-classes-3111">VM warning: Sharing is only supported for boot loader classes #3111</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/mockito/mockito/issues/3111" class="bare">https://github.com/mockito/mockito/issues/3111</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/77512409/adding-xshareoff-jvm-arg-break-jacoco-maven-plugin-setup" class="bare">https://stackoverflow.com/questions/77512409/adding-xshareoff-jvm-arg-break-jacoco-maven-plugin-setup</a></p>
</li>
<li>
<p><a href="https://nipafx.dev/java-application-class-data-sharing/" class="bare">https://nipafx.dev/java-application-class-data-sharing/</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="solution-2">Solution</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use -Xshare:off option to disable class data sharing</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inject-opentelemetry-auto-instrumentation-in-kubernetes">Inject OpenTelemetry Auto-Instrumentation in Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="exclude-urls-from-tracing-2">Exclude URLs from Tracing</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/1060" class="bare">https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/1060</a>
<a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/filterprocessor/README.md" class="bare">https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/filterprocessor/README.md</a> - Filter Processor is not working as expected</p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/discussions/6597" class="bare">https://github.com/open-telemetry/opentelemetry-java-instrumentation/discussions/6597</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
    </main>
</div>

<!-- TOC relocation script -->
<script>
    const toc = document.getElementById('toc');
    const container = document.getElementById('toc-container');
    if (toc && container) {
        container.appendChild(toc);
    }
</script>

<button onclick="toggleTheme()" style="position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; background-color: var(--link); color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
    Toggle Theme
</button>

<script>
    function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.getAttribute("data-theme") === "dark";
        html.setAttribute("data-theme", isDark ? "light" : "dark");
        localStorage.setItem("theme", isDark ? "light" : "dark");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
    });
</script>
</body>
</html>